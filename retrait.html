<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>VGN ‚Äì Retrait</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--g:#16A34A;--gd:#15803D;--o:#F97316;--od:#EA580C;--bg:#F1F5F1;--card:#fff;--txt:#111827;--mu:#6B7280;--bd:#E5E7EB;--H:56px;--B:58px;--sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px)}
html{font-family:'Nunito',sans-serif;background:var(--bg)}
body{max-width:430px;margin:0 auto;background:var(--bg);overflow-x:hidden}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:calc(var(--H) + var(--sat));background:linear-gradient(135deg,var(--gd),#22C55E);display:flex;align-items:center;justify-content:space-between;padding:var(--sat) 14px 0;z-index:999;box-shadow:0 2px 10px rgba(0,0,0,.15)}
.tbk{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;text-decoration:none;color:#fff;font-weight:900}
.tbt{font-size:1rem;font-weight:900;color:#fff}
.tbsolde{font-size:.68rem;font-weight:800;color:#fff;background:rgba(255,255,255,.15);padding:4px 10px;border-radius:16px;border:1px solid rgba(255,255,255,.25)}

/* ‚îÄ‚îÄ SCROLL ‚îÄ‚îÄ */
.scroll{padding-top:calc(var(--H) + var(--sat) + 12px);padding-bottom:calc(var(--B) + var(--sab) + 24px);min-height:100svh;min-height:100vh}

/* ‚îÄ‚îÄ BOTNAV ‚îÄ‚îÄ */
.botnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:calc(var(--B) + var(--sab));padding-bottom:var(--sab);background:#fff;border-top:1px solid var(--bd);display:flex;align-items:center;z-index:999;box-shadow:0 -2px 10px rgba(0,0,0,.07)}
.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none;position:relative}
.bni{font-size:1.2rem}.bnl{font-size:.57rem;font-weight:800;color:var(--mu)}

/* ‚îÄ‚îÄ SOLDE CARD ‚îÄ‚îÄ */
.solde-card{margin:0 12px 14px;background:linear-gradient(135deg,var(--gd),#22C55E);border-radius:18px;padding:16px 18px;box-shadow:0 4px 18px rgba(22,163,74,.25);position:relative;overflow:hidden}
.solde-card::after{content:'üí∞';position:absolute;right:-6px;bottom:-8px;font-size:5rem;opacity:.1}
.sc-lbl{font-size:.7rem;color:rgba(255,255,255,.75);font-weight:700;margin-bottom:4px}
.sc-val{font-size:1.8rem;font-weight:900;color:#fff}
.sc-sub{font-size:.65rem;color:rgba(255,255,255,.65);margin-top:4px}
.sc-chips{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.chip{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);color:#fff;font-size:.65rem;font-weight:800;padding:4px 10px;border-radius:20px;cursor:pointer;transition:background .15s}
.chip:active{background:rgba(255,255,255,.35)}

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.sec-h{padding:0 14px;margin-bottom:10px;font-size:.85rem;font-weight:900;color:var(--txt)}

/* ‚îÄ‚îÄ M√âTHODE DE RETRAIT ‚îÄ‚îÄ */
.methods{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 12px;margin-bottom:14px}
.meth{background:var(--card);border-radius:14px;padding:13px 12px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;border:2px solid transparent;transition:all .2s;box-shadow:0 1px 7px rgba(0,0,0,.07)}
.meth.on{border-color:var(--g);background:#F0FDF4}
.meth:active{transform:scale(.96)}
.meth-ico{font-size:1.7rem}
.meth-nom{font-size:.72rem;font-weight:800;color:var(--txt)}
.meth-tag{font-size:.58rem;color:var(--mu);font-weight:600}

/* ‚îÄ‚îÄ FORMULAIRE ‚îÄ‚îÄ */
.form-card{background:var(--card);border-radius:18px;margin:0 12px 14px;padding:16px;box-shadow:0 1px 8px rgba(0,0,0,.08)}
.field{margin-bottom:14px}
.field label{display:block;font-size:.73rem;font-weight:800;color:var(--txt);margin-bottom:6px}
.field input{width:100%;padding:12px 14px;border:1.5px solid var(--bd);border-radius:12px;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:700;color:var(--txt);background:#fff;outline:none;transition:border .2s}
.field input:focus{border-color:var(--g)}
.field input.err-input{border-color:#DC2626}
.field .hint{font-size:.63rem;color:var(--mu);margin-top:5px;font-weight:600}
.field .hint.err-txt{color:#DC2626}
.montant-wrap{position:relative}
.montant-wrap input{padding-right:50px}
.montant-wrap .cur{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:.72rem;font-weight:900;color:var(--mu)}

/* ‚îÄ‚îÄ FRAIS ‚îÄ‚îÄ */
.frais-box{background:#FFF7ED;border:1px solid #FED7AA;border-radius:12px;padding:11px 14px;margin-bottom:14px}
.frais-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.frais-row:last-child{margin-bottom:0;padding-top:6px;border-top:1px dashed #FED7AA}
.frais-lbl{font-size:.7rem;color:#92400E;font-weight:700}
.frais-val{font-size:.75rem;font-weight:900;color:#92400E}
.frais-row.total .frais-lbl{color:var(--g);font-size:.75rem}
.frais-row.total .frais-val{color:var(--g);font-size:.88rem}

/* ‚îÄ‚îÄ BOUTON ‚îÄ‚îÄ */
.btn-retrait{width:100%;padding:14px;background:linear-gradient(135deg,var(--g),var(--gd));border:none;border-radius:14px;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;color:#fff;cursor:pointer;transition:transform .15s,box-shadow .15s;box-shadow:0 4px 14px rgba(22,163,74,.3);margin:0 0 10px}
.btn-retrait:active{transform:scale(.97)}
.btn-retrait:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* ‚îÄ‚îÄ HISTORIQUE ‚îÄ‚îÄ */
.hist-list{padding:0 12px;display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.hist-item{background:var(--card);border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
.hist-ico{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.hist-ico.pending{background:#FFF7ED}.hist-ico.done{background:#F0FDF4}.hist-ico.fail{background:#FEF2F2}
.hist-info{flex:1;min-width:0}
.hist-nom{font-size:.77rem;font-weight:800;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hist-date{font-size:.62rem;color:var(--mu);margin-top:2px}
.hist-right{text-align:right;flex-shrink:0}
.hist-mont{font-size:.85rem;font-weight:900;color:#DC2626}
.hist-stat{font-size:.6rem;font-weight:700;padding:2px 8px;border-radius:10px;margin-top:3px;display:inline-block}
.hist-stat.pending{background:#FFF7ED;color:#D97706}
.hist-stat.done{background:#F0FDF4;color:var(--g)}
.hist-stat.fail{background:#FEF2F2;color:#DC2626}

/* ‚îÄ‚îÄ VIDE ‚îÄ‚îÄ */
.vide{text-align:center;padding:24px 16px;color:var(--mu);font-size:.78rem;font-weight:700}
.vide-ico{font-size:2.5rem;margin-bottom:8px}

/* ‚îÄ‚îÄ OVERLAY CONFIRM ‚îÄ‚îÄ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.ov.open{opacity:1;pointer-events:all}
.ov-box{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:430px;padding:20px 20px 32px;transform:translateY(100%);transition:transform .3s cubic-bezier(.34,1.1,.64,1)}
.ov.open .ov-box{transform:translateY(0)}
.ov-title{font-size:1.05rem;font-weight:900;color:var(--txt);margin-bottom:4px}
.ov-sub{font-size:.73rem;color:var(--mu);margin-bottom:16px}
.ov-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid #F3F4F6}
.ov-row:last-of-type{border-bottom:none}
.ov-lbl{font-size:.73rem;color:var(--mu);font-weight:700}
.ov-val{font-size:.8rem;font-weight:900;color:var(--txt)}
.ov-val.green{color:var(--g)}.ov-val.red{color:#DC2626}
.ov-btns{display:flex;gap:10px;margin-top:16px}
.ov-cancel{flex:1;padding:12px;background:#F3F4F6;border:none;border-radius:12px;font-family:'Nunito',sans-serif;font-size:.88rem;font-weight:800;color:var(--mu);cursor:pointer}
.ov-confirm{flex:2;padding:12px;background:linear-gradient(135deg,var(--g),var(--gd));border:none;border-radius:12px;font-family:'Nunito',sans-serif;font-size:.88rem;font-weight:900;color:#fff;cursor:pointer}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.tst{position:fixed;top:calc(var(--H) + var(--sat) + 8px);left:50%;transform:translateX(-50%) translateY(-80px);background:#111;color:#fff;padding:9px 22px;border-radius:22px;font-size:.77rem;font-weight:700;z-index:99999;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.2)}
.tst.show{transform:translateX(-50%) translateY(0)}.tst.err{background:#DC2626}.tst.ok{background:var(--g)}
.ld{display:inline-block;width:10px;height:10px;border:2px solid #ccc;border-top-color:var(--g);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <a class="tbk" href="dashboard.html">‚Äπ</a>
  <span class="tbt">üí≥ Retrait</span>
  <div class="tbsolde">üí∞ <span id="tb-solde">‚Äî</span></div>
</div>
<div class="tst" id="tst"></div>

<div class="scroll">

  <!-- SOLDE DISPONIBLE -->
  <div class="solde-card">
    <div class="sc-lbl">Solde disponible</div>
    <div class="sc-val" id="sc-solde"><span class="ld"></span></div>
    <div class="sc-sub" id="sc-sub">Minimum de retrait : <b>1 000 FCFA</b></div>
    <div class="sc-chips">
      <div class="chip" onclick="setMontant(1000)">1 000</div>
      <div class="chip" onclick="setMontant(2000)">2 000</div>
      <div class="chip" onclick="setMontant(5000)">5 000</div>
      <div class="chip" onclick="setMontantMax()">Max</div>
    </div>
  </div>

  <!-- M√âTHODE -->
  <div class="sec-h">M√©thode de retrait</div>
  <div class="methods">
    <div class="meth on" id="m-momo" onclick="selectMeth('momo')">
      <span class="meth-ico">üì±</span>
      <span class="meth-nom">Mobile Money</span>
      <span class="meth-tag">MTN / Orange / Moov</span>
    </div>
    <div class="meth" id="m-bank" onclick="selectMeth('bank')">
      <span class="meth-ico">üè¶</span>
      <span class="meth-nom">Virement bancaire</span>
      <span class="meth-tag">2‚Äì5 jours ouvr√©s</span>
    </div>
    <div class="meth" id="m-wave" onclick="selectMeth('wave')">
      <span class="meth-ico">üåä</span>
      <span class="meth-nom">Wave</span>
      <span class="meth-tag">Instantan√©</span>
    </div>
    <div class="meth" id="m-crypto" onclick="selectMeth('crypto')">
      <span class="meth-ico">‚Çø</span>
      <span class="meth-nom">Crypto (USDT)</span>
      <span class="meth-tag">TRC-20</span>
    </div>
  </div>

  <!-- FORMULAIRE -->
  <div class="form-card">

    <!-- Montant -->
    <div class="field">
      <label>Montant √† retirer</label>
      <div class="montant-wrap">
        <input type="number" id="inp-montant" placeholder="0" min="1000" inputmode="numeric" oninput="calcFrais()">
        <span class="cur">FCFA</span>
      </div>
      <div class="hint" id="hint-montant">Minimum 1 000 FCFA</div>
    </div>

    <!-- Num√©ro / Compte (Mobile Money) -->
    <div class="field" id="field-tel">
      <label id="lbl-compte">Num√©ro Mobile Money</label>
      <input type="tel" id="inp-tel" placeholder="Ex: 07 00 00 00 00" inputmode="tel">
      <div class="hint">Le num√©ro doit √™tre enregistr√© √† votre nom</div>
    </div>

    <!-- R√©seau (Mobile Money) -->
    <div class="field" id="field-reseau">
      <label>R√©seau</label>
      <input type="text" id="inp-reseau" placeholder="Ex: MTN, Orange, Moov..." readonly onclick="cycleReseau()" style="cursor:pointer;background:#F9FAFB">
      <div class="hint">Appuyez pour changer de r√©seau</div>
    </div>

    <!-- Nom b√©n√©ficiaire (Banque) -->
    <div class="field" id="field-nom" style="display:none">
      <label>Nom du b√©n√©ficiaire</label>
      <input type="text" id="inp-nom" placeholder="Nom complet">
    </div>

    <!-- IBAN / RIB (Banque) -->
    <div class="field" id="field-iban" style="display:none">
      <label>IBAN / RIB</label>
      <input type="text" id="inp-iban" placeholder="FR76 xxxx xxxx xxxx">
    </div>

    <!-- Adresse crypto -->
    <div class="field" id="field-crypto" style="display:none">
      <label>Adresse USDT TRC-20</label>
      <input type="text" id="inp-crypto" placeholder="T...">
      <div class="hint">‚ö†Ô∏è V√©rifiez l'adresse ‚Äî transfert irr√©versible</div>
    </div>

  </div>

  <!-- FRAIS -->
  <div class="frais-box" id="frais-box" style="display:none;margin:0 12px 14px">
    <div class="frais-row">
      <span class="frais-lbl">Montant demand√©</span>
      <span class="frais-val" id="f-montant">‚Äî</span>
    </div>
    <div class="frais-row">
      <span class="frais-lbl">Frais de traitement (2%)</span>
      <span class="frais-val" id="f-frais">‚Äî</span>
    </div>
    <div class="frais-row total">
      <span class="frais-lbl">Vous recevrez</span>
      <span class="frais-val" id="f-net">‚Äî</span>
    </div>
  </div>

  <!-- BOUTON -->
  <div style="padding:0 12px 4px">
    <button class="btn-retrait" id="btn-retrait" onclick="demanderConfirm()">
      üí≥ Demander le retrait
    </button>
  </div>

  <!-- HISTORIQUE -->
  <div class="sec-h" style="margin-top:6px">Historique des retraits</div>
  <div class="hist-list" id="hist-list">
    <div style="text-align:center;padding:16px"><span class="ld"></span></div>
  </div>

</div>

<!-- BOTNAV -->
<nav class="botnav">
  <a class="bn" href="dashboard.html"><span class="bni">üè†</span><span class="bnl">Accueil</span></a>
  <a class="bn" href="taches.html"><span class="bni">‚úÖ</span><span class="bnl">T√¢ches</span></a>
  <a class="bn" href="rapport.html"><span class="bni">üìä</span><span class="bnl">Rapports</span></a>
  <a class="bn" href="profil.html"><span class="bni">üë§</span><span class="bnl">Mon Compte</span></a>
</nav>

<!-- OVERLAY CONFIRMATION -->
<div class="ov" id="ov">
  <div class="ov-box">
    <div class="ov-title">‚úÖ Confirmer le retrait</div>
    <div class="ov-sub">V√©rifiez les informations avant de valider</div>
    <div class="ov-row"><span class="ov-lbl">M√©thode</span><span class="ov-val" id="ov-meth">‚Äî</span></div>
    <div class="ov-row"><span class="ov-lbl">Compte / Num√©ro</span><span class="ov-val" id="ov-compte">‚Äî</span></div>
    <div class="ov-row"><span class="ov-lbl">Montant demand√©</span><span class="ov-val" id="ov-montant">‚Äî</span></div>
    <div class="ov-row"><span class="ov-lbl">Frais (2%)</span><span class="ov-val red" id="ov-frais">‚Äî</span></div>
    <div class="ov-row"><span class="ov-lbl">Vous recevrez</span><span class="ov-val green" id="ov-net">‚Äî</span></div>
    <div class="ov-btns">
      <button class="ov-cancel" onclick="closeOv()">Annuler</button>
      <button class="ov-confirm" id="ov-btn" onclick="validerRetrait()">‚úÖ Confirmer</button>
    </div>
  </div>
</div>

<script>
const SB=supabase.createClient(
  'https://tgrfzybemuwvhkbpuzmz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE',
  {auth:{persistSession:true,storageKey:'vgn-auth',storage:window.localStorage}}
);

const MIN=1000, FRAIS_PCT=0.02;
const fmt=n=>Number(n||0).toLocaleString('fr-FR');
const fmtF=n=>fmt(n)+' FCFA';
const $=id=>document.getElementById(id);
const $s=(id,v)=>{const e=$(id);if(e)e.textContent=v};
const toast=(m,type='')=>{const t=$('tst');t.textContent=m;t.className='tst show'+(type?' '+type:'');setTimeout(()=>t.className='tst',3500)};

let U=null, P=null, methode='momo', reseaux=['MTN','Orange','Moov'], reseauIdx=0;

/* ‚îÄ‚îÄ S√©lection m√©thode ‚îÄ‚îÄ */
function selectMeth(m){
  methode=m;
  ['momo','bank','wave','crypto'].forEach(k=>$('m-'+k).classList.remove('on'));
  $('m-'+m).classList.add('on');
  // Afficher/cacher champs
  $('field-tel').style.display=(m==='momo'||m==='wave')?'block':'none';
  $('field-reseau').style.display=m==='momo'?'block':'none';
  $('field-nom').style.display=m==='bank'?'block':'none';
  $('field-iban').style.display=m==='bank'?'block':'none';
  $('field-crypto').style.display=m==='crypto'?'block':'none';
  // Label
  const labels={momo:'Num√©ro Mobile Money',wave:'Num√©ro Wave',bank:'Nom du b√©n√©ficiaire',crypto:'Adresse USDT'};
  $s('lbl-compte',labels[m]||'Compte');
  if(m==='wave') $('inp-tel').placeholder='Ex: 07 00 00 00 00';
  calcFrais();
}

function cycleReseau(){
  reseauIdx=(reseauIdx+1)%reseaux.length;
  $('inp-reseau').value=reseaux[reseauIdx];
}

/* ‚îÄ‚îÄ Montant ‚îÄ‚îÄ */
function setMontant(v){
  $('inp-montant').value=v;
  calcFrais();
}
function setMontantMax(){
  if(!P){toast('Chargement...','');return}
  const max=Math.floor(P.solde||0);
  if(max<MIN){toast('‚ö†Ô∏è Solde insuffisant (min 1 000 FCFA)','err');return}
  $('inp-montant').value=max;
  calcFrais();
}

function calcFrais(){
  const v=parseInt($('inp-montant').value)||0;
  const fraisBox=$('frais-box');
  const hint=$('hint-montant');
  const solde=P?.solde||0;

  hint.className='hint';
  $('inp-montant').classList.remove('err-input');

  if(v<=0){fraisBox.style.display='none';return}

  if(v<MIN){
    hint.textContent='‚ö†Ô∏è Minimum 1 000 FCFA';
    hint.className='hint err-txt';
    $('inp-montant').classList.add('err-input');
    fraisBox.style.display='none';return;
  }
  if(v>solde){
    hint.textContent='‚ö†Ô∏è Solde insuffisant';
    hint.className='hint err-txt';
    $('inp-montant').classList.add('err-input');
    fraisBox.style.display='none';return;
  }

  hint.textContent='Montant valide ‚úì';
  hint.style.color='var(--g)';
  const frais=Math.ceil(v*FRAIS_PCT);
  const net=v-frais;
  $s('f-montant',fmtF(v));
  $s('f-frais',fmtF(frais));
  $s('f-net',fmtF(net));
  fraisBox.style.display='block';
}

/* ‚îÄ‚îÄ Validation formulaire ‚îÄ‚îÄ */
function validerChamps(){
  const v=parseInt($('inp-montant').value)||0;
  const solde=P?.solde||0;
  if(v<MIN){toast('‚ö†Ô∏è Montant minimum : 1 000 FCFA','err');return false}
  if(v>solde){toast('‚ö†Ô∏è Solde insuffisant','err');return false}

  if(methode==='momo'||methode==='wave'){
    const tel=$('inp-tel').value.trim();
    if(tel.length<8){toast('‚ö†Ô∏è Num√©ro invalide','err');return false}
  }
  if(methode==='momo'){
    if(!$('inp-reseau').value){toast('‚ö†Ô∏è S√©lectionnez un r√©seau','err');return false}
  }
  if(methode==='bank'){
    if(!$('inp-nom').value.trim()){toast('‚ö†Ô∏è Nom requis','err');return false}
    if($('inp-iban').value.trim().length<10){toast('‚ö†Ô∏è IBAN invalide','err');return false}
  }
  if(methode==='crypto'){
    const addr=$('inp-crypto').value.trim();
    if(addr.length<20){toast('‚ö†Ô∏è Adresse crypto invalide','err');return false}
  }
  return true;
}

function demanderConfirm(){
  if(!validerChamps())return;
  const v=parseInt($('inp-montant').value);
  const frais=Math.ceil(v*FRAIS_PCT);
  const net=v-frais;
  const methLabels={momo:'Mobile Money',bank:'Virement bancaire',wave:'Wave',crypto:'Crypto USDT'};
  const compte={
    momo:$('inp-tel').value.trim()+' ('+($('inp-reseau').value||'‚Äî')+')',
    wave:$('inp-tel').value.trim(),
    bank:$('inp-nom').value.trim()+' ‚Äì '+$('inp-iban').value.trim(),
    crypto:$('inp-crypto').value.trim()
  }[methode];
  $s('ov-meth',methLabels[methode]);
  $s('ov-compte',compte);
  $s('ov-montant',fmtF(v));
  $s('ov-frais',fmtF(frais));
  $s('ov-net',fmtF(net));
  $('ov').classList.add('open');
}
function closeOv(){$('ov').classList.remove('open')}

/* ‚îÄ‚îÄ Valider retrait ‚îÄ‚îÄ */
async function validerRetrait(){
  if(!U||!P)return;
  const v=parseInt($('inp-montant').value);
  const frais=Math.ceil(v*FRAIS_PCT);
  const net=v-frais;
  const btn=$('ov-btn');
  btn.textContent='‚è≥...';btn.disabled=true;

  const methLabels={momo:'Mobile Money',bank:'Virement bancaire',wave:'Wave',crypto:'Crypto USDT'};
  const compte={
    momo:$('inp-tel').value.trim()+' ('+$('inp-reseau').value+')',
    wave:$('inp-tel').value.trim(),
    bank:$('inp-nom').value.trim()+' ‚Äì '+$('inp-iban').value.trim(),
    crypto:$('inp-crypto').value.trim()
  }[methode];

  try{
    // 1. Ins√©rer la transaction
    const{error:e1}=await SB.from('transactions').insert({
      user_id:U.id,
      type:'retrait',
      montant:v,
      frais:frais,
      montant_net:net,
      methode:methode,
      compte:compte,
      statut:'en_attente',
      created_at:new Date().toISOString()
    });
    if(e1)throw new Error(e1.message);

    // 2. D√©duire du solde
    const nouveauSolde=(P.solde||0)-v;
    const{error:e2}=await SB.from('profiles').update({solde:nouveauSolde}).eq('id',U.id);
    if(e2)throw new Error(e2.message);

    // 3. Mettre √† jour local
    P.solde=nouveauSolde;
    $s('sc-solde',fmtF(nouveauSolde));
    $s('tb-solde',fmtF(nouveauSolde));

    closeOv();
    toast('‚úÖ Demande envoy√©e ! Traitement sous 24h','ok');
    $('inp-montant').value='';
    $('frais-box').style.display='none';
    $('hint-montant').textContent='Minimum 1 000 FCFA';
    $('hint-montant').className='hint';
    chargerHistorique();
  }catch(err){
    toast('‚ùå '+err.message,'err');
    console.error(err);
  }finally{
    btn.textContent='‚úÖ Confirmer';btn.disabled=false;
  }
}

/* ‚îÄ‚îÄ Historique ‚îÄ‚îÄ */
async function chargerHistorique(){
  const{data:hist}=await SB.from('transactions')
    .select('*').eq('user_id',U.id).eq('type','retrait')
    .order('created_at',{ascending:false}).limit(20);
  const list=$('hist-list');
  if(!hist||hist.length===0){
    list.innerHTML='<div class="vide"><div class="vide-ico">üìã</div>Aucun retrait effectu√©</div>';
    return;
  }
  const statLabel={en_attente:'En attente',valide:'Valid√©',rejete:'Rejet√©'};
  const statCls={en_attente:'pending',valide:'done',rejete:'fail'};
  const methIco={momo:'üì±',bank:'üè¶',wave:'üåä',crypto:'‚Çø'};
  const methNom={momo:'Mobile Money',bank:'Virement',wave:'Wave',crypto:'Crypto'};
  list.innerHTML=hist.map(h=>{
    const st=h.statut||'en_attente';
    const dt=new Date(h.created_at).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
    return `<div class="hist-item">
      <div class="hist-ico ${statCls[st]}">${methIco[h.methode]||'üí≥'}</div>
      <div class="hist-info">
        <div class="hist-nom">${methNom[h.methode]||h.methode} ‚Äî ${h.compte||'‚Äî'}</div>
        <div class="hist-date">${dt}</div>
      </div>
      <div class="hist-right">
        <div class="hist-mont">-${fmtF(h.montant)}</div>
        <span class="hist-stat ${statCls[st]}">${statLabel[st]||st}</span>
      </div>
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
async function init(){
  const{data:{session}}=await SB.auth.getSession();
  if(!session){window.location.href='index.html';return}
  U=session.user;

  const{data:p}=await SB.from('profiles').select('*').eq('id',U.id).single();
  P=p||{solde:0};

  $s('sc-solde',fmtF(P.solde));
  $s('tb-solde',fmtF(P.solde));
  $s('sc-sub','Minimum de retrait : 1 000 FCFA');

  // Initialiser r√©seau Mobile Money
  $('inp-reseau').value=reseaux[0];

  // D√©sactiver bouton si solde insuffisant
  if((P.solde||0)<MIN){
    $('btn-retrait').disabled=true;
    $('btn-retrait').textContent='Solde insuffisant (min 1 000 FCFA)';
  }

  await chargerHistorique();
}

// Cr√©er table transactions si elle n'existe pas (g√©r√© c√¥t√© SQL)
init();
</script>
</body>
</html>
