<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VGN ‚Äì Accueil</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#16A34A;--green-dark:#15803D;
  --orange:#F97316;--orange-dark:#EA580C;
  --bg:#F1F5F1;--card:#fff;
  --text:#111827;--muted:#6B7280;--border:#E5E7EB;
  --top:58px;--bot:58px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%}
body{font-family:'Nunito',sans-serif;background:var(--bg);max-width:430px;margin:0 auto;min-height:100%;overflow-x:hidden}

/* TOPBAR */
.topbar{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:var(--top);background:linear-gradient(135deg,var(--green-dark),#22C55E);display:flex;align-items:center;justify-content:space-between;padding:0 14px;z-index:500;box-shadow:0 2px 10px rgba(0,0,0,.15)}
.tl{display:flex;align-items:center;gap:8px}
.tl-badge{width:32px;height:32px;background:var(--orange);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1rem;box-shadow:0 2px 8px rgba(249,115,22,.4)}
.tl-name{font-size:1.2rem;font-weight:900;color:#fff;letter-spacing:.07em}
.tr{display:flex;gap:7px}
.ibtn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:.95rem;cursor:pointer}

/* PAGE */
.page{padding-top:calc(var(--top)+12px);padding-bottom:calc(var(--bot)+18px)}

/* HERO */
.hero{margin:0 11px 10px;background:linear-gradient(135deg,var(--green-dark),#22C55E);border-radius:18px;padding:13px 15px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 16px rgba(22,163,74,.22);position:relative;overflow:hidden}
.hero::after{content:'üåæ';position:absolute;right:-8px;top:-8px;font-size:4.5rem;opacity:.1}
.hero-txt h4{font-size:.67rem;color:rgba(255,255,255,.72);font-weight:600}
.hero-txt h2{font-size:1rem;color:#fff;font-weight:900;margin:2px 0}
.hero-txt p{font-size:.64rem;color:rgba(255,255,255,.6)}
.hero-ico{font-size:2.2rem;position:relative;z-index:1}

/* ANNOUNCE */
.announce{margin:0 11px 10px;background:#fff;border-radius:12px;padding:8px 11px;display:flex;align-items:center;gap:7px;box-shadow:0 1px 6px rgba(0,0,0,.06);overflow:hidden}
.ann-dot{font-size:.9rem;flex-shrink:0;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
.ann-track{overflow:hidden;flex:1}
.ann-track span{display:block;white-space:nowrap;font-size:.72rem;font-weight:700;color:var(--text);animation:tick 22s linear infinite}
@keyframes tick{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

/* SLIDER */
.slider{margin:0 11px 12px;border-radius:17px;overflow:hidden;position:relative;height:170px;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.slide{position:absolute;inset:0;opacity:0;transition:opacity .85s ease}
.slide.on{opacity:1}
.slide img{width:100%;height:100%;object-fit:cover;display:block}
.sov{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.58) 0%,transparent 52%)}
.scap{position:absolute;bottom:0;left:0;right:0;padding:9px 13px}
.scap h4{font-size:.86rem;font-weight:900;color:#fff}
.scap p{font-size:.64rem;color:rgba(255,255,255,.78);margin-top:1px}
.sdots{position:absolute;bottom:9px;right:10px;display:flex;gap:4px}
.sd{width:6px;height:6px;border-radius:3px;background:rgba(255,255,255,.45);transition:all .3s}
.sd.on{width:15px;background:var(--orange)}

/* SECTION HEAD */
.sh{display:flex;align-items:center;justify-content:space-between;padding:0 13px;margin-bottom:8px}
.sh h3{font-size:.87rem;font-weight:800;color:var(--text)}
.sh a{font-size:.68rem;color:var(--green);font-weight:700;text-decoration:none}

/* ACTIONS */
.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 11px;margin-bottom:12px}
.ab{display:flex;flex-direction:column;align-items:center;gap:5px;text-decoration:none;cursor:pointer}
.ab:active .ai{transform:scale(.88)}
.ai{width:50px;height:50px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;box-shadow:0 3px 10px rgba(0,0,0,.12);transition:transform .18s,box-shadow .18s}
.al{font-size:.62rem;font-weight:800;color:var(--text);text-align:center;line-height:1.2}
.c1{background:linear-gradient(135deg,#F97316,#EA580C)}
.c2{background:linear-gradient(135deg,#3B82F6,#1D4ED8)}
.c3{background:linear-gradient(135deg,#16A34A,#15803D)}
.c4{background:linear-gradient(135deg,#84CC16,#65A30D)}
.c5{background:linear-gradient(135deg,#F43F5E,#BE123C)}
.c6{background:linear-gradient(135deg,#EAB308,#CA8A04)}

/* SOLDE */
.solde-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;padding:0 11px;margin-bottom:12px}
.sc{background:var(--card);border-radius:14px;padding:11px 12px;box-shadow:0 1px 7px rgba(0,0,0,.07);position:relative;overflow:hidden}
.sc::after{content:attr(data-e);position:absolute;right:-4px;bottom:-4px;font-size:2.3rem;opacity:.1}
.sc-lbl{font-size:.62rem;color:var(--muted);font-weight:700;margin-bottom:3px}
.sc-val{font-size:1.02rem;font-weight:900;color:var(--text)}
.sc-sub{font-size:.59rem;margin-top:3px;font-weight:700}
.sg{color:var(--green)} .so{color:var(--orange)}

/* STAGE BANNER */
.stage-banner{margin:0 11px 8px;background:linear-gradient(135deg,var(--orange),var(--orange-dark));border-radius:14px;padding:11px 14px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 3px 12px rgba(249,115,22,.22)}
.sb-l h4{font-size:.77rem;font-weight:900;color:#fff}
.sb-l p{font-size:.63rem;color:rgba(255,255,255,.8);margin-top:2px;line-height:1.4}
.sb-r{text-align:right;flex-shrink:0;margin-left:10px}
.sb-days{font-size:1.4rem;font-weight:900;color:#fff;line-height:1}
.sb-days-lbl{font-size:.58rem;color:rgba(255,255,255,.75)}

.stage-prog{margin:0 11px 12px}
.prog-wrap{background:#E5E7EB;border-radius:6px;height:6px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--orange),var(--orange-dark));border-radius:6px;transition:width .5s ease}
.prog-lbls{display:flex;justify-content:space-between;margin-top:4px}
.prog-lbls span{font-size:.59rem;font-weight:700;color:var(--muted)}

/* TACHE CARDS */
.taches-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 11px;margin-bottom:16px}
.tc{background:var(--card);border-radius:15px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.08);cursor:pointer;transition:transform .18s,box-shadow .18s;position:relative;user-select:none}
.tc:hover{transform:translateY(-2px);box-shadow:0 5px 18px rgba(0,0,0,.13)}
.tc:active{transform:scale(.95)}
.tc.done{pointer-events:none}
.tc.done::after{content:'‚úÖ Fait';position:absolute;inset:0;background:rgba(22,163,74,.84);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:900;color:#fff;border-radius:15px}
.tc.locked{opacity:.45;pointer-events:none}
.tc img{width:100%;height:92px;object-fit:cover;display:block}
.tc-top{position:relative}
.tc-tag{position:absolute;top:6px;left:6px;background:var(--green);color:#fff;font-size:.56rem;font-weight:800;padding:2px 7px;border-radius:5px;text-transform:uppercase;letter-spacing:.04em}
.tc-body{padding:7px 9px 9px}
.tc-n{font-size:.73rem;font-weight:800;color:var(--text)}
.tc-r{font-size:.7rem;font-weight:900;color:var(--green);margin-top:2px}
.tc-desc{font-size:.6rem;color:var(--muted);margin-top:2px;line-height:1.3}
.tasks-limit-notice{grid-column:1/-1;text-align:center;padding:11px;background:#F0FDF4;border-radius:12px;font-size:.73rem;font-weight:700;color:var(--green)}
.stage-ended{grid-column:1/-1;text-align:center;padding:18px 14px;background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.07)}

/* BOTTOM NAV */
.botnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:var(--bot);background:#fff;border-top:1px solid var(--border);display:flex;align-items:center;z-index:500;box-shadow:0 -2px 10px rgba(0,0,0,.07)}
.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none;position:relative;cursor:pointer}
.bn.on::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:26px;height:3px;background:var(--green);border-radius:0 0 3px 3px}
.bn-ico{font-size:1.2rem}
.bn-lbl{font-size:.57rem;font-weight:800;color:var(--muted)}
.bn.on .bn-lbl{color:var(--green)}

/* AD OVERLAY */
.ad-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.ad-overlay.open{opacity:1;pointer-events:all}
.ad-box{background:#111;border-radius:20px;width:calc(100% - 32px);max-width:398px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.6)}
.ad-fake{width:100%;height:190px;position:relative;background:#000;display:flex;align-items:center;justify-content:center}
.ad-fake img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;opacity:.6}
.ad-play{position:relative;z-index:2;font-size:3rem}
.ad-body{padding:13px 15px}
.ad-brand{font-size:.67rem;font-weight:700;color:#888;margin-bottom:3px}
.ad-title{font-size:.87rem;font-weight:900;color:#fff;margin-bottom:8px}
.ad-bar-wrap{background:#333;border-radius:4px;height:5px;overflow:hidden;margin-bottom:8px}
.ad-bar{height:100%;background:var(--orange);border-radius:4px;width:0%}
.ad-timer{font-size:.72rem;font-weight:800;color:#bbb;text-align:center;margin-bottom:10px}
.ad-skip{width:100%;padding:11px;background:linear-gradient(135deg,var(--green),var(--green-dark));border:none;border-radius:12px;font-family:'Nunito',sans-serif;font-size:.88rem;font-weight:900;color:#fff;cursor:pointer;display:none;transition:transform .15s}
.ad-skip:active{transform:scale(.97)}
.ad-skip.show{display:block}

/* TOAST */
.toast-bar{position:fixed;top:66px;left:50%;transform:translateX(-50%) translateY(-70px);background:#111;color:#fff;padding:7px 18px;border-radius:22px;font-size:.77rem;font-weight:700;z-index:9999;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.2)}
.toast-bar.show{transform:translateX(-50%) translateY(0)}
.ldot{display:inline-block;width:10px;height:10px;border:2px solid #ccc;border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="topbar">
  <div class="tl"><div class="tl-badge">üå±</div><span class="tl-name">VGN</span></div>
  <div class="tr">
    <div class="ibtn" onclick="toast('üîî Aucune notification')">üîî</div>
    <div class="ibtn" onclick="toast('üí¨ Support 24h/24')">üí¨</div>
  </div>
</div>
<div class="toast-bar" id="tb"></div>

<div class="page">

  <div class="hero">
    <div class="hero-txt">
      <h4>Bienvenue sur</h4>
      <h2 id="uname"><span class="ldot"></span></h2>
      <p>üåΩ Ma√Øs &nbsp;¬∑&nbsp; üåæ Bl√© &nbsp;¬∑&nbsp; üêÑ √âlevage</p>
    </div>
    <div class="hero-ico">üë®‚Äçüåæ</div>
  </div>

  <div class="announce">
    <span class="ann-dot">üì¢</span>
    <div class="ann-track">
      <span>üåΩ R√©colte ma√Øs +18% &nbsp;|&nbsp; üåæ Nouvelle parcelle bl√© &nbsp;|&nbsp; üêÑ √âlevage record &nbsp;|&nbsp; üí∞ Retirez vos gains &nbsp;|&nbsp; ‚úÖ 3 t√¢ches gratuites / jour pendant 4 jours !</span>
    </div>
  </div>

  <div class="slider">
    <div class="slide on"><img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=800&q=80" alt=""><div class="sov"></div><div class="scap"><h4>üåΩ Champs de Ma√Øs VGN</h4><p>Ma√Øs bio ‚Äî rendement garanti</p></div></div>
    <div class="slide"><img src="https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=800&q=80" alt=""><div class="sov"></div><div class="scap"><h4>üåæ Culture de Bl√© Dor√©</h4><p>Des hectares de bl√© pour vous</p></div></div>
    <div class="slide"><img src="https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=800&q=80" alt=""><div class="sov"></div><div class="scap"><h4>üêÑ √âlevage Bovin Premium</h4><p>Gains durables et rentables</p></div></div>
    <div class="slide"><img src="https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=800&q=80" alt=""><div class="sov"></div><div class="scap"><h4>üöú Exploitation VGN</h4><p>Votre investissement bien g√©r√©</p></div></div>
    <div class="sdots"><div class="sd on"></div><div class="sd"></div><div class="sd"></div><div class="sd"></div></div>
  </div>

  <div class="sh"><h3>Actions rapides</h3></div>
  <div class="actions">
    <a class="ab" href="recharge.html"><div class="ai c1">üí∞</div><span class="al">Recharge</span></a>
    <a class="ab" href="retrait.html"><div class="ai c2">üí≥</div><span class="al">Retrait</span></a>
    <a class="ab" href="fonds.html"><div class="ai c3">üõ°Ô∏è</div><span class="al">Mes Fonds</span></a>
    <a class="ab" href="roue.html"><div class="ai c4">üé°</div><span class="al">Roue Chance</span></a>
    <a class="ab" href="inviter.html"><div class="ai c5">üë•</div><span class="al">Inviter</span></a>
    <a class="ab" href="vip.html"><div class="ai c6">üíé</div><span class="al">VIP</span></a>
  </div>

  <div class="sh"><h3>Mon Portefeuille</h3></div>
  <div class="solde-row">
    <div class="sc" data-e="üí∞"><div class="sc-lbl">Solde disponible</div><div class="sc-val" id="v-solde"><span class="ldot"></span></div><div class="sc-sub sg" id="v-solde-sub">‚Äî</div></div>
    <div class="sc" data-e="üìà"><div class="sc-lbl">Gains totaux</div><div class="sc-val" id="v-gains"><span class="ldot"></span></div><div class="sc-sub so">Cumul√©s</div></div>
    <div class="sc" data-e="üå±"><div class="sc-lbl">Investissement</div><div class="sc-val" id="v-invest"><span class="ldot"></span></div><div class="sc-sub sg">Actif</div></div>
    <div class="sc" data-e="‚úÖ"><div class="sc-lbl">T√¢ches du jour</div><div class="sc-val" id="v-tasks"><span class="ldot"></span></div><div class="sc-sub so">/ 3 max</div></div>
  </div>

  <div class="stage-banner" id="stage-banner">
    <div class="sb-l">
      <h4>üéì T√¢ches de stage ‚Äî Gratuites</h4>
      <p>Regardez une pub ‚Üí +70 FCFA<br>Max 3 t√¢ches par jour</p>
    </div>
    <div class="sb-r">
      <div class="sb-days" id="stage-days">‚Äî</div>
      <div class="sb-days-lbl">jours restants</div>
    </div>
  </div>
  <div class="stage-prog">
    <div class="prog-wrap"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
    <div class="prog-lbls"><span>Jour 1</span><span id="prog-lbl">0 / 4 jours</span><span>Jour 4</span></div>
  </div>

  <div class="sh">
    <h3>üéØ T√¢ches gratuites</h3>
    <span id="tasks-lbl" style="font-size:.7rem;font-weight:800;color:var(--orange)"></span>
  </div>
  <div class="taches-grid" id="taches-grid">
    <div style="grid-column:1/-1;text-align:center;padding:20px"><span class="ldot"></span></div>
  </div>

</div>

<nav class="botnav">
  <a class="bn on" href="dashboard.html"><span class="bn-ico">üè†</span><span class="bn-lbl">Accueil</span></a>
  <a class="bn" href="taches.html"><span class="bn-ico">‚úÖ</span><span class="bn-lbl">T√¢ches</span></a>
  <a class="bn" href="rapport.html"><span class="bn-ico">üìä</span><span class="bn-lbl">Rapports</span></a>
  <a class="bn" href="profil.html"><span class="bn-ico">üë§</span><span class="bn-lbl">Mon Compte</span></a>
</nav>

<!-- AD OVERLAY -->
<div class="ad-overlay" id="ad-overlay">
  <div class="ad-box">
    <div class="ad-fake"><img id="ad-img" src="" alt=""><div class="ad-play">‚ñ∂Ô∏è</div></div>
    <div class="ad-body">
      <div class="ad-brand" id="ad-brand">VGN Agriculture</div>
      <div class="ad-title" id="ad-title">D√©couvrez nos champs</div>
      <div class="ad-bar-wrap"><div class="ad-bar" id="ad-bar"></div></div>
      <div class="ad-timer" id="ad-timer">Patientez <b>15</b> secondes...</div>
      <button class="ad-skip" id="ad-skip" onclick="finishAd()">‚úÖ R√©clamer +70 FCFA</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SB = supabase.createClient(
  'https://tgrfzybemuwvhkbpuzmz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE'
);

// ‚îÄ‚îÄ CONSTANTES ‚îÄ‚îÄ
const MAX_TASKS  = 3;
const REWARD     = 70;
const STAGE_DAYS = 4;
const AD_SEC     = 15;

const TACHES = [
  {id:'ag1', nom:'Champs de Ma√Øs VGN',     img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400&q=80', desc:'Pub agricole VGN'},
  {id:'ag2', nom:'Bl√© Dor√© Premium',        img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&q=80', desc:'D√©couvrez nos cultures'},
  {id:'ag3', nom:'√âlevage Bovin VGN',       img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=400&q=80', desc:'Notre b√©tail prim√©'},
  {id:'ag4', nom:'Grande R√©colte 2025',     img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&q=80', desc:'R√©colte record'},
  {id:'ag5', nom:'Ferme Bio Certifi√©e',     img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=400&q=80', desc:'Agriculture durable'},
  {id:'ag6', nom:'Irrigation Moderne',      img:'https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=400&q=80', desc:'Tech agricole VGN'},
];

// ‚îÄ‚îÄ √âTAT LOCAL ‚îÄ‚îÄ
let authUser      = null;
let profile       = null;
let doneTodayRefs = [];   // IDs t√¢ches faites aujourd'hui (ex: ['ag1','ag2'])
let currentTask   = null;
let adInterval    = null;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
const fmt  = n => Number(n||0).toLocaleString('fr-FR');
const fmtF = n => fmt(n) + ' FCFA';
const todayStr = () => new Date().toISOString().slice(0, 10); // 'YYYY-MM-DD'

function set(id, v) {
  const e = document.getElementById(id);
  if (e) e.textContent = v;
}

function toast(m) {
  const t = document.getElementById('tb');
  t.textContent = m;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3200);
}

// ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ
let cur = 0;
const slides = document.querySelectorAll('.slide');
const dots   = document.querySelectorAll('.sd');
function goTo(n) {
  slides[cur].classList.remove('on'); dots[cur].classList.remove('on');
  cur = (n + slides.length) % slides.length;
  slides[cur].classList.add('on');   dots[cur].classList.add('on');
}
setInterval(() => goTo(cur + 1), 3800);
dots.forEach((d, i) => d.addEventListener('click', () => goTo(i)));

// ‚îÄ‚îÄ STAGE INFO ‚îÄ‚îÄ
function stageInfo(createdAt) {
  const ms   = Date.now() - new Date(createdAt).getTime();
  const done = Math.min(Math.floor(ms / 86400000), STAGE_DAYS);
  const left = Math.max(STAGE_DAYS - done, 0);
  return { done, left, pct: (done / STAGE_DAYS) * 100 };
}

function updateStageBanner(createdAt) {
  const { done, left, pct } = stageInfo(createdAt);
  set('stage-days', left);
  set('prog-lbl', done + ' / ' + STAGE_DAYS + ' jours');
  document.getElementById('prog-fill').style.width = pct + '%';
  if (left === 0) {
    const b = document.getElementById('stage-banner');
    b.style.background = 'linear-gradient(135deg,#6B7280,#374151)';
    b.querySelector('h4').textContent = 'üéì Stage termin√©';
    b.querySelector('p').textContent  = 'Passez √† un plan VIP pour continuer';
  }
  return left;
}

// ‚îÄ‚îÄ RENDER T√ÇCHES ‚îÄ‚îÄ
function renderTaches(left) {
  const grid = document.getElementById('taches-grid');
  grid.innerHTML = '';
  const done = doneTodayRefs.length;
  set('tasks-lbl', done + ' / ' + MAX_TASKS + ' aujourd\'hui');

  if (left === 0) {
    grid.innerHTML = `<div class="stage-ended">
      <div style="font-size:2.2rem;margin-bottom:8px">üéì</div>
      <div style="font-size:.84rem;font-weight:800;color:var(--text);margin-bottom:4px">Stage de 4 jours termin√© !</div>
      <div style="font-size:.72rem;color:var(--muted);margin-bottom:12px">Investissez dans un plan VIP pour continuer √† gagner.</div>
      <a href="vip.html" style="display:inline-block;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;padding:9px 20px;border-radius:11px;font-size:.8rem;font-weight:800;text-decoration:none">üíé Voir les plans VIP</a>
    </div>`;
    return;
  }

  TACHES.forEach(t => {
    const isDone   = doneTodayRefs.includes(t.id);
    const isLocked = !isDone && done >= MAX_TASKS;
    const card = document.createElement('div');
    card.className = 'tc' + (isDone ? ' done' : isLocked ? ' locked' : '');
    if (!isDone && !isLocked) card.onclick = () => startTask(t);
    card.innerHTML = `
      <div class="tc-top">
        <img src="${t.img}" alt="${t.nom}" loading="lazy">
        <span class="tc-tag">Gratuit</span>
      </div>
      <div class="tc-body">
        <div class="tc-n">${t.nom}</div>
        <div class="tc-r">+${REWARD} FCFA</div>
        <div class="tc-desc">${t.desc}</div>
      </div>`;
    grid.appendChild(card);
  });

  if (done >= MAX_TASKS) {
    const n = document.createElement('div');
    n.className = 'tasks-limit-notice';
    n.textContent = '‚úÖ 3 t√¢ches compl√©t√©es ! Revenez demain.';
    grid.appendChild(n);
  }
}

// ‚îÄ‚îÄ D√âMARRER PUB ‚îÄ‚îÄ
function startTask(t) {
  currentTask = t;
  document.getElementById('ad-img').src   = t.img;
  document.getElementById('ad-brand').textContent = 'VGN Agriculture';
  document.getElementById('ad-title').textContent = t.nom;
  document.getElementById('ad-bar').style.width   = '0%';
  document.getElementById('ad-bar').style.transition = 'none';
  document.getElementById('ad-timer').innerHTML   = `Patientez <b>${AD_SEC}</b> secondes...`;
  document.getElementById('ad-skip').classList.remove('show');
  document.getElementById('ad-overlay').classList.add('open');

  let elapsed = 0;
  clearInterval(adInterval);
  adInterval = setInterval(() => {
    elapsed++;
    const pct = (elapsed / AD_SEC) * 100;
    const bar = document.getElementById('ad-bar');
    bar.style.transition = 'width .9s linear';
    bar.style.width = pct + '%';
    const rem = AD_SEC - elapsed;
    document.getElementById('ad-timer').innerHTML = rem > 0
      ? `Patientez <b>${rem}</b> seconde${rem > 1 ? 's' : ''}...`
      : 'üéâ Cliquez pour r√©clamer votre gain !';
    if (elapsed >= AD_SEC) {
      clearInterval(adInterval);
      document.getElementById('ad-skip').classList.add('show');
    }
  }, 1000);
}

// ‚îÄ‚îÄ TERMINER PUB ‚Üí CR√âDITER ‚îÄ‚îÄ
async function finishAd() {
  clearInterval(adInterval);
  document.getElementById('ad-overlay').classList.remove('open');
  if (!currentTask || !authUser) return;

  const t = currentTask;
  currentTask = null;

  // V√©rifications c√¥t√© client
  if (doneTodayRefs.includes(t.id))    { toast('‚ö†Ô∏è T√¢che d√©j√† compl√©t√©e'); return; }
  if (doneTodayRefs.length >= MAX_TASKS) { toast('‚ö†Ô∏è Max 3 t√¢ches par jour'); return; }

  // Optimistic UI : marquer comme fait imm√©diatement
  doneTodayRefs.push(t.id);
  const left = updateStageBanner(profile.created_at || authUser.created_at);
  renderTaches(left);

  try {
    const today = todayStr();

    // 1. Ins√©rer dans taches_completees
    const { error: errInsert } = await SB
      .from('taches_completees')
      .insert({
        user_id:   authUser.id,
        tache_id:  null,
        tache_ref: t.id,
        type_tache:'stage',
        reward:    REWARD,
        date_jour: today,
        completee_le: new Date().toISOString(),
      });

    if (errInsert) throw errInsert;

    // 2. Mettre √† jour le profil (solde + gains)
    const nvSolde       = (profile.solde       || 0) + REWARD;
    const nvGainsJour   = (profile.gains_jour  || 0) + REWARD;
    const nvGainsTotaux = (profile.gains_totaux|| 0) + REWARD;
    const nvGainsSemaine= (profile.gains_semaine||0) + REWARD;
    const nvGainsMois   = (profile.gains_mois  || 0) + REWARD;
    const nvTachesJour  = (profile.taches_jour || 0) + 1;

    const { error: errUpdate } = await SB
      .from('profiles')
      .update({
        solde:          nvSolde,
        gains_jour:     nvGainsJour,
        gains_totaux:   nvGainsTotaux,
        gains_semaine:  nvGainsSemaine,
        gains_mois:     nvGainsMois,
        taches_jour:    nvTachesJour,
      })
      .eq('id', authUser.id);

    if (errUpdate) throw errUpdate;

    // Mettre √† jour le cache local
    profile.solde         = nvSolde;
    profile.gains_jour    = nvGainsJour;
    profile.gains_totaux  = nvGainsTotaux;
    profile.gains_semaine = nvGainsSemaine;
    profile.gains_mois    = nvGainsMois;
    profile.taches_jour   = nvTachesJour;

    // Mettre √† jour l'affichage
    set('v-solde', fmtF(nvSolde));
    set('v-gains', fmtF(nvGainsTotaux));
    set('v-tasks', nvTachesJour + ' / ' + MAX_TASKS);
    set('v-solde-sub', '‚Üë Disponible');

    toast(`üéâ +${REWARD} FCFA cr√©dit√©s sur votre compte !`);

  } catch (err) {
    // Rollback optimistic
    doneTodayRefs = doneTodayRefs.filter(id => id !== t.id);
    renderTaches(updateStageBanner(profile.created_at || authUser.created_at));
    console.error('Erreur t√¢che:', err);
    toast('‚ùå Erreur: ' + (err.message || 'R√©essayez'));
  }
}

// ‚îÄ‚îÄ CHARGEMENT INITIAL ‚îÄ‚îÄ
async function init() {
  const { data: { user } } = await SB.auth.getUser();
  if (!user) { window.location.href = 'index.html'; return; }
  authUser = user;

  const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'Investisseur';
  set('uname', 'Bonjour, ' + name + ' üëã');

  // Charger profil
  const { data: p, error: errP } = await SB
    .from('profiles')
    .select('solde,gains_totaux,gains_jour,gains_semaine,gains_mois,investissement,taches_jour,created_at,vip_niveau')
    .eq('id', user.id)
    .single();

  profile = p || {
    solde:0, gains_totaux:0, gains_jour:0, gains_semaine:0,
    gains_mois:0, investissement:0, taches_jour:0,
    created_at: user.created_at
  };

  set('v-solde',  fmtF(profile.solde));
  set('v-gains',  fmtF(profile.gains_totaux));
  set('v-invest', fmtF(profile.investissement));
  set('v-solde-sub', profile.solde > 0 ? '‚Üë Disponible' : '‚Üë 1er d√©p√¥t ?');

  // Charger t√¢ches faites AUJOURD'HUI depuis taches_completees
  const today = todayStr();
  const { data: tc, error: errTc } = await SB
    .from('taches_completees')
    .select('tache_ref')
    .eq('user_id', user.id)
    .eq('date_jour', today)
    .eq('type_tache', 'stage');

  if (!errTc && tc) {
    doneTodayRefs = tc
      .map(r => r.tache_ref)
      .filter(Boolean)
      .slice(0, MAX_TASKS);
  }

  set('v-tasks', doneTodayRefs.length + ' / ' + MAX_TASKS);

  // Stage banner + t√¢ches
  const ca   = profile.created_at || user.created_at;
  const left = updateStageBanner(ca);
  renderTaches(left);
}

init();
</script>
</body>
</html>
