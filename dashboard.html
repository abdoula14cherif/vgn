<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>VGN ‚Äì Accueil</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--g:#16A34A;--gd:#15803D;--o:#F97316;--od:#EA580C;--bg:#F1F5F1;--card:#fff;--txt:#111827;--mu:#6B7280;--bd:#E5E7EB;--H:58px;--B:58px;--sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px)}
html{font-family:'Nunito',sans-serif;background:var(--bg)}
body{max-width:430px;margin:0 auto;background:var(--bg);overflow-x:hidden}

.topbar{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:calc(var(--H) + var(--sat));background:linear-gradient(135deg,var(--gd),#22C55E);display:flex;align-items:center;justify-content:space-between;padding:var(--sat) 14px 0;z-index:999;box-shadow:0 2px 10px rgba(0,0,0,.15)}
.tl{display:flex;align-items:center;gap:8px}
.badge{width:32px;height:32px;background:var(--o);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1rem}
.logo{font-size:1.2rem;font-weight:900;color:#fff;letter-spacing:.07em}
.ibtn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:.95rem;cursor:pointer}

.scroll{padding-top:calc(var(--H) + var(--sat) + 10px);padding-bottom:calc(var(--B) + var(--sab) + 24px);min-height:100svh;min-height:100vh}

.botnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:calc(var(--B) + var(--sab));padding-bottom:var(--sab);background:#fff;border-top:1px solid var(--bd);display:flex;align-items:center;z-index:999;box-shadow:0 -2px 10px rgba(0,0,0,.07)}
.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none;position:relative;cursor:pointer}
.bn.on::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:26px;height:3px;background:var(--g);border-radius:0 0 3px 3px}
.bni{font-size:1.2rem}.bnl{font-size:.57rem;font-weight:800;color:var(--mu)}.bn.on .bnl{color:var(--g)}

.hero{margin:0 11px 10px;background:linear-gradient(135deg,var(--gd),#22C55E);border-radius:18px;padding:13px 15px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 16px rgba(22,163,74,.22);position:relative;overflow:hidden}
.hero::after{content:'üåæ';position:absolute;right:-8px;top:-8px;font-size:4.5rem;opacity:.1}
.ht h4{font-size:.67rem;color:rgba(255,255,255,.72);font-weight:600}
.ht h2{font-size:1rem;color:#fff;font-weight:900;margin:2px 0}
.ht p{font-size:.64rem;color:rgba(255,255,255,.6)}
.hi{font-size:2.2rem;position:relative;z-index:1}

.ann{margin:0 11px 10px;background:#fff;border-radius:12px;padding:8px 11px;display:flex;align-items:center;gap:7px;box-shadow:0 1px 6px rgba(0,0,0,.06);overflow:hidden}
.ann-d{font-size:.9rem;flex-shrink:0;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
.ann-t{overflow:hidden;flex:1}
.ann-t span{display:block;white-space:nowrap;font-size:.72rem;font-weight:700;color:var(--txt);animation:tick 22s linear infinite}
@keyframes tick{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

.slider{margin:0 11px 12px;border-radius:17px;overflow:hidden;position:relative;height:168px;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.sli{position:absolute;inset:0;opacity:0;transition:opacity .85s ease}.sli.on{opacity:1}
.sli img{width:100%;height:100%;object-fit:cover;display:block}
.sov{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.58) 0%,transparent 52%)}
.cap{position:absolute;bottom:0;left:0;right:0;padding:9px 13px}
.cap h4{font-size:.84rem;font-weight:900;color:#fff}
.cap p{font-size:.63rem;color:rgba(255,255,255,.78);margin-top:1px}
.dots{position:absolute;bottom:9px;right:10px;display:flex;gap:4px}
.dot{width:6px;height:6px;border-radius:3px;background:rgba(255,255,255,.45);transition:all .3s}
.dot.on{width:15px;background:var(--o)}

.sh{display:flex;align-items:center;justify-content:space-between;padding:0 13px;margin-bottom:8px}
.sh h3{font-size:.87rem;font-weight:800;color:var(--txt)}
.sh span{font-size:.68rem;color:var(--o);font-weight:700}

.acts{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 11px;margin-bottom:12px}
.ab{display:flex;flex-direction:column;align-items:center;gap:5px;text-decoration:none;cursor:pointer}
.ab:active .ai{transform:scale(.88)}
.ai{width:50px;height:50px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;box-shadow:0 3px 10px rgba(0,0,0,.12);transition:transform .18s}
.al{font-size:.62rem;font-weight:800;color:var(--txt);text-align:center;line-height:1.2}
.c1{background:linear-gradient(135deg,#F97316,#EA580C)}.c2{background:linear-gradient(135deg,#3B82F6,#1D4ED8)}.c3{background:linear-gradient(135deg,#16A34A,#15803D)}.c4{background:linear-gradient(135deg,#84CC16,#65A30D)}.c5{background:linear-gradient(135deg,#F43F5E,#BE123C)}.c6{background:linear-gradient(135deg,#EAB308,#CA8A04)}

/* ‚îÄ‚îÄ SOLDE CARDS ‚îÄ‚îÄ */
.cards2{display:grid;grid-template-columns:1fr 1fr;gap:9px;padding:0 11px;margin-bottom:12px}
.sc{background:var(--card);border-radius:14px;padding:11px 12px;box-shadow:0 1px 7px rgba(0,0,0,.07);position:relative;overflow:hidden}
.sc::after{content:attr(data-e);position:absolute;right:-4px;bottom:-4px;font-size:2.3rem;opacity:.1}
.scl{font-size:.62rem;color:var(--mu);font-weight:700;margin-bottom:3px}
.scv{font-size:1.02rem;font-weight:900;color:var(--txt)}
.scs{font-size:.59rem;margin-top:3px;font-weight:700}
.cg{color:var(--g)}.co{color:var(--o)}

/* SOLDE highlight ring */
.sc.highlight-solde{border:2px solid var(--g);box-shadow:0 2px 12px rgba(22,163,74,.18)}
.sc.highlight-solde .scv{color:var(--g)}

.stgban{margin:0 11px 8px;background:linear-gradient(135deg,var(--o),var(--od));border-radius:14px;padding:11px 14px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 3px 12px rgba(249,115,22,.22)}
.stgl h4{font-size:.77rem;font-weight:900;color:#fff}
.stgl p{font-size:.63rem;color:rgba(255,255,255,.8);margin-top:2px;line-height:1.4}
.stgr{text-align:right;flex-shrink:0;margin-left:10px}
.stgn{font-size:1.4rem;font-weight:900;color:#fff;line-height:1}
.stgnl{font-size:.58rem;color:rgba(255,255,255,.75)}

.progw{margin:0 11px 12px}
.pb{background:#E5E7EB;border-radius:6px;height:6px;overflow:hidden}
.pf{height:100%;background:linear-gradient(90deg,var(--o),var(--od));border-radius:6px;transition:width .5s ease}
.pll{display:flex;justify-content:space-between;margin-top:4px}
.pll span{font-size:.59rem;font-weight:700;color:var(--mu)}

.tg{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 11px;margin-bottom:16px}
.tc{background:var(--card);border-radius:15px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.08);cursor:pointer;transition:transform .18s,box-shadow .18s;position:relative;user-select:none}
.tc:hover{transform:translateY(-2px);box-shadow:0 5px 18px rgba(0,0,0,.13)}
.tc:active{transform:scale(.95)}
.tc.done{pointer-events:none}
.tc.done::after{content:'‚úÖ Fait';position:absolute;inset:0;background:rgba(22,163,74,.84);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:900;color:#fff;border-radius:15px}
.tc.locked{opacity:.35;pointer-events:none}
.tc img{width:100%;height:92px;object-fit:cover;display:block}
.tctp{position:relative}
.tctag{position:absolute;top:6px;left:6px;background:var(--g);color:#fff;font-size:.56rem;font-weight:800;padding:2px 7px;border-radius:5px;text-transform:uppercase;letter-spacing:.04em}
.tcb{padding:7px 9px 9px}
.tcn{font-size:.73rem;font-weight:800;color:var(--txt)}
.tcr{font-size:.7rem;font-weight:900;color:var(--g);margin-top:2px}
.tcd{font-size:.6rem;color:var(--mu);margin-top:2px;line-height:1.3}
.notice{grid-column:1/-1;text-align:center;padding:11px;background:#F0FDF4;border-radius:12px;font-size:.73rem;font-weight:700;color:var(--g)}
.ended{grid-column:1/-1;text-align:center;padding:18px 14px;background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.07)}

.adov{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.adov.open{opacity:1;pointer-events:all}
.adbox{background:#111;border-radius:20px;width:calc(100% - 32px);max-width:398px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.6)}
.adimg{width:100%;height:190px;position:relative;background:#000;display:flex;align-items:center;justify-content:center}
.adimg img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;opacity:.6}
.adplay{position:relative;z-index:2;font-size:3rem}
.adbd{padding:13px 15px}
.adbr{font-size:.67rem;font-weight:700;color:#888;margin-bottom:3px}
.adti{font-size:.87rem;font-weight:900;color:#fff;margin-bottom:8px}
.adbw{background:#333;border-radius:4px;height:6px;overflow:hidden;margin-bottom:8px}
.adbar{height:100%;background:var(--o);border-radius:4px;width:0%}
.adtm{font-size:.72rem;font-weight:800;color:#bbb;text-align:center;margin-bottom:10px}
.adbtn{width:100%;padding:12px;background:linear-gradient(135deg,var(--g),var(--gd));border:none;border-radius:12px;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:900;color:#fff;cursor:pointer;display:none;transition:transform .15s;box-shadow:0 3px 12px rgba(22,163,74,.3)}
.adbtn:active{transform:scale(.97)}.adbtn.show{display:block}

.tst{position:fixed;top:66px;left:50%;transform:translateX(-50%) translateY(-80px);background:#111;color:#fff;padding:8px 20px;border-radius:22px;font-size:.77rem;font-weight:700;z-index:99999;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.2)}
.tst.show{transform:translateX(-50%) translateY(0)}.tst.err{background:#DC2626}
.ld{display:inline-block;width:10px;height:10px;border:2px solid #ccc;border-top-color:var(--g);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="topbar">
  <div class="tl"><div class="badge">üå±</div><span class="logo">VGN</span></div>
  <div class="tl" style="gap:7px">
    <div class="ibtn" onclick="toast('üîî Aucune notification')">üîî</div>
    <div class="ibtn" onclick="toast('üí¨ Support 24h/24')">üí¨</div>
  </div>
</div>
<div class="tst" id="tst"></div>

<div class="scroll">

  <div class="hero">
    <div class="ht">
      <h4>Bienvenue sur</h4>
      <h2 id="uname"><span class="ld"></span></h2>
      <p>üåΩ Ma√Øs &nbsp;¬∑&nbsp; üåæ Bl√© &nbsp;¬∑&nbsp; üêÑ √âlevage</p>
    </div>
    <div class="hi">üë®‚Äçüåæ</div>
  </div>

  <div class="ann">
    <span class="ann-d">üì¢</span>
    <div class="ann-t"><span>üåΩ R√©colte ma√Øs +18% &nbsp;|&nbsp; üåæ Nouvelle parcelle bl√© &nbsp;|&nbsp; üêÑ √âlevage record &nbsp;|&nbsp; üí∞ Retirez vos gains &nbsp;|&nbsp; ‚úÖ 3 t√¢ches gratuites / jour pendant 4 jours !</span></div>
  </div>

  <div class="slider">
    <div class="sli on"><img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=800&q=80" alt=""><div class="sov"></div><div class="cap"><h4>üåΩ Champs de Ma√Øs VGN</h4><p>Ma√Øs bio ‚Äî rendement garanti</p></div></div>
    <div class="sli"><img src="https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=800&q=80" alt=""><div class="sov"></div><div class="cap"><h4>üåæ Bl√© Dor√© Premium</h4><p>Des hectares de bl√© pour vous</p></div></div>
    <div class="sli"><img src="https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=800&q=80" alt=""><div class="sov"></div><div class="cap"><h4>üêÑ √âlevage Bovin Premium</h4><p>Gains durables et rentables</p></div></div>
    <div class="sli"><img src="https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=800&q=80" alt=""><div class="sov"></div><div class="cap"><h4>üöú Exploitation VGN</h4><p>Votre investissement bien g√©r√©</p></div></div>
    <div class="dots"><div class="dot on"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  </div>

  <div class="sh"><h3>Actions rapides</h3></div>
  <div class="acts">
    <a class="ab" href="recharge.html"><div class="ai c1">üí∞</div><span class="al">Recharge</span></a>
    <a class="ab" href="retrait.html"><div class="ai c2">üí≥</div><span class="al">Retrait</span></a>
    <a class="ab" href="fonds.html"><div class="ai c3">üõ°Ô∏è</div><span class="al">Mes Fonds</span></a>
    <a class="ab" href="roue.html"><div class="ai c4">üé°</div><span class="al">Roue Chance</span></a>
    <a class="ab" href="inviter.html"><div class="ai c5">üë•</div><span class="al">Inviter</span></a>
    <a class="ab" href="vip.html"><div class="ai c6">üíé</div><span class="al">VIP</span></a>
  </div>

  <div class="sh"><h3>Mon Portefeuille</h3></div>
  <div class="cards2">
    <div class="sc highlight-solde" data-e="üí∞">
      <div class="scl">Solde disponible</div>
      <div class="scv" id="v-solde"><span class="ld"></span></div>
      <div class="scs cg" id="v-sub">Chargement...</div>
    </div>
    <div class="sc" data-e="üìà">
      <div class="scl">Gains totaux</div>
      <div class="scv" id="v-gains"><span class="ld"></span></div>
      <div class="scs co">Cumul√©s</div>
    </div>
    <div class="sc" data-e="üå±">
      <div class="scl">Investissement</div>
      <div class="scv" id="v-invest"><span class="ld"></span></div>
      <div class="scs cg">Actif</div>
    </div>
    <div class="sc" data-e="‚úÖ">
      <div class="scl">T√¢ches du jour</div>
      <div class="scv" id="v-tasks"><span class="ld"></span></div>
      <div class="scs co">/ 3 max</div>
    </div>
  </div>

  <div class="stgban" id="stgban">
    <div class="stgl">
      <h4>üéì T√¢ches de stage ‚Äî Gratuites</h4>
      <p>Regardez une pub ‚Üí +70 FCFA<br>Max 3 t√¢ches par jour</p>
    </div>
    <div class="stgr"><div class="stgn" id="stgdays">‚Äî</div><div class="stgnl">jours restants</div></div>
  </div>
  <div class="progw">
    <div class="pb"><div class="pf" id="pf" style="width:0%"></div></div>
    <div class="pll"><span>Jour 1</span><span id="plbl">0 / 4 jours</span><span>Jour 4</span></div>
  </div>

  <div class="sh">
    <h3>üéØ T√¢ches gratuites</h3>
    <span id="tlbl"></span>
  </div>
  <div class="tg" id="tg">
    <div style="grid-column:1/-1;text-align:center;padding:24px"><span class="ld"></span></div>
  </div>

</div>

<nav class="botnav">
  <a class="bn on" href="dashboard.html"><span class="bni">üè†</span><span class="bnl">Accueil</span></a>
  <a class="bn" href="taches.html"><span class="bni">‚úÖ</span><span class="bnl">T√¢ches</span></a>
  <a class="bn" href="rapport.html"><span class="bni">üìä</span><span class="bnl">Rapports</span></a>
  <a class="bn" href="profil.html"><span class="bni">üë§</span><span class="bnl">Mon Compte</span></a>
</nav>

<div class="adov" id="adov">
  <div class="adbox">
    <div class="adimg"><img id="adimg" src="" alt=""><div class="adplay">‚ñ∂Ô∏è</div></div>
    <div class="adbd">
      <div class="adbr">VGN Agriculture</div>
      <div class="adti" id="adti">Chargement...</div>
      <div class="adbw"><div class="adbar" id="adbar"></div></div>
      <div class="adtm" id="adtm">Patientez <b>15</b> secondes...</div>
      <button class="adbtn" id="adbtn" onclick="finishAd()">‚úÖ R√©clamer +70 FCFA</button>
    </div>
  </div>
</div>

<script>
const SURL='https://tgrfzybemuwvhkbpuzmz.supabase.co';
const SKEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE';
const SB=supabase.createClient(SURL,SKEY,{auth:{persistSession:true,storageKey:'vgn-auth',storage:window.localStorage}});

const MAX=3,GAIN=70,DAYS=4,SECS=15;
const TK=[
  {id:'ag1',nom:'Champs de Ma√Øs VGN',img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400&q=80',desc:'Pub agricole VGN'},
  {id:'ag2',nom:'Bl√© Dor√© Premium',img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&q=80',desc:'D√©couvrez nos cultures'},
  {id:'ag3',nom:'√âlevage Bovin VGN',img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=400&q=80',desc:'Notre b√©tail prim√©'},
  {id:'ag4',nom:'Grande R√©colte 2025',img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&q=80',desc:'R√©colte record'},
  {id:'ag5',nom:'Ferme Bio Certifi√©e',img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=400&q=80',desc:'Agriculture durable'},
  {id:'ag6',nom:'Irrigation Moderne',img:'https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=400&q=80',desc:'Tech agricole VGN'},
];

let U=null,P=null,done=[],curT=null,adInt=null,saving=false;
const fmt=n=>Number(n||0).toLocaleString('fr-FR');
const fmtF=n=>fmt(n)+' FCFA';
const td=()=>new Date().toISOString().slice(0,10);
function $s(id,v){const e=document.getElementById(id);if(e)e.textContent=v}
function toast(m,e=false){const t=document.getElementById('tst');t.textContent=m;t.className='tst show'+(e?' err':'');setTimeout(()=>t.className='tst',3500)}

// ‚îÄ‚îÄ Rafra√Æchir l'affichage du solde depuis P ‚îÄ‚îÄ
function refreshSolde(){
  $s('v-solde', fmtF(P.solde));
  $s('v-gains', fmtF(P.gains_totaux));
  $s('v-invest', fmtF(P.investissement));
  $s('v-tasks', (P.taches_jour||0)+' / '+MAX);
  $s('v-sub', P.solde>0 ? '‚Üë '+fmtF(P.solde)+' disponible' : '‚Üë Aucun d√©p√¥t');
}

// ‚îÄ‚îÄ Charger le profil depuis Supabase (+ cr√©er si absent) ‚îÄ‚îÄ
async function loadProfile(userId, userEmail, userName){
  const{data:p, error}=await SB.from('profiles').select('*').eq('id',userId).single();

  if(!p){
    // Profil absent ‚Üí le cr√©er via upsert
    console.log('Profil absent, cr√©ation...');
    const code='VGN-'+Math.random().toString(36).slice(2,8).toUpperCase();
    const{data:np, error:err2}=await SB.from('profiles').upsert({
      id: userId,
      email: userEmail||'',
      full_name: userName||'Investisseur',
      vip_niveau: 'VIP 0',
      solde: 0, gains_totaux: 0, gains_jour: 0,
      gains_hier: 0, gains_semaine: 0, gains_mois: 0,
      investissement: 0, revenu_attendu: 0,
      taches_jour: 0, benefices_jour: 0,
      rabais_commission: 0, commission_parrainage: 0,
      code_parrainage: code,
    },{onConflict:'id'}).select().single();
    if(err2) console.error('Erreur cr√©ation profil:',err2);
    return np || {id:userId,solde:0,gains_totaux:0,gains_jour:0,gains_semaine:0,gains_mois:0,investissement:0,taches_jour:0,created_at:new Date().toISOString()};
  }
  return p;
}

// slider
let c=0;const slis=document.querySelectorAll('.sli'),dots=document.querySelectorAll('.dot');
function goTo(n){slis[c].classList.remove('on');dots[c].classList.remove('on');c=(n+slis.length)%slis.length;slis[c].classList.add('on');dots[c].classList.add('on')}
setInterval(()=>goTo(c+1),3800);dots.forEach((d,i)=>d.addEventListener('click',()=>goTo(i)));

function stageLeft(ca){
  const ms=Date.now()-new Date(ca||Date.now()).getTime();
  const dd=Math.min(Math.floor(ms/86400000),DAYS);
  const left=Math.max(DAYS-dd,0);
  $s('stgdays',left);$s('plbl',dd+' / '+DAYS+' jours');
  document.getElementById('pf').style.width=(dd/DAYS*100)+'%';
  if(left===0){const b=document.getElementById('stgban');b.style.background='linear-gradient(135deg,#6B7280,#374151)';b.querySelector('h4').textContent='üéì Stage termin√©';b.querySelector('p').textContent='Passez √† un plan VIP'}
  return left;
}

function renderTaches(left){
  const g=document.getElementById('tg');g.innerHTML='';
  $s('tlbl',done.length+' / '+MAX);
  if(left===0){g.innerHTML=`<div class="ended"><div style="font-size:2.2rem;margin-bottom:8px">üéì</div><div style="font-size:.84rem;font-weight:800;margin-bottom:4px">Stage termin√© !</div><div style="font-size:.72rem;color:#6B7280;margin-bottom:12px">Investissez dans un plan VIP.</div><a href="vip.html" style="display:inline-block;background:linear-gradient(135deg,#16A34A,#15803D);color:#fff;padding:9px 20px;border-radius:11px;font-size:.8rem;font-weight:800;text-decoration:none">üíé Plans VIP</a></div>`;return}
  TK.forEach(t=>{
    const isDone=done.includes(t.id),locked=!isDone&&done.length>=MAX;
    const card=document.createElement('div');
    card.className='tc'+(isDone?' done':locked?' locked':'');
    if(!isDone&&!locked)card.onclick=()=>startAd(t);
    card.innerHTML=`<div class="tctp"><img src="${t.img}" alt="${t.nom}" loading="lazy"><span class="tctag">Gratuit</span></div><div class="tcb"><div class="tcn">${t.nom}</div><div class="tcr">+${GAIN} FCFA</div><div class="tcd">${t.desc}</div></div>`;
    g.appendChild(card);
  });
  if(done.length>=MAX){const n=document.createElement('div');n.className='notice';n.textContent='‚úÖ 3 t√¢ches compl√©t√©es ! Revenez demain.';g.appendChild(n)}
}

function startAd(t){
  if(saving)return;curT=t;
  document.getElementById('adimg').src=t.img;
  document.getElementById('adti').textContent=t.nom;
  const bar=document.getElementById('adbar');bar.style.transition='none';bar.style.width='0%';
  document.getElementById('adtm').innerHTML=`Patientez <b>${SECS}</b> secondes...`;
  document.getElementById('adbtn').classList.remove('show');
  document.getElementById('adov').classList.add('open');
  let el=0;clearInterval(adInt);
  adInt=setInterval(()=>{el++;bar.style.transition='width 1s linear';bar.style.width=(el/SECS*100)+'%';const r=SECS-el;document.getElementById('adtm').innerHTML=r>0?`Patientez <b>${r}</b> sec...`:'üéâ Cliquez pour r√©clamer !';if(el>=SECS){clearInterval(adInt);document.getElementById('adbtn').classList.add('show')}},1000);
}

async function finishAd(){
  if(!curT||!U||saving)return;
  if(done.includes(curT.id)){toast('‚ö†Ô∏è D√©j√† compl√©t√©e');return}
  if(done.length>=MAX){toast('‚ö†Ô∏è Max 3 t√¢ches/jour');return}
  clearInterval(adInt);saving=true;
  const btn=document.getElementById('adbtn');btn.textContent='‚è≥...';btn.disabled=true;
  const t=curT;curT=null;

  try{
    // 1. Ins√©rer la t√¢che compl√©t√©e
    const{error:e1}=await SB.from('taches_completees').insert({
      user_id:   U.id,
      tache_ref: t.id,
      type_tache:'stage',
      reward:    GAIN,
      date_jour: td(),
      completee_le: new Date().toISOString()
    });
    if(e1) throw new Error('Insert tache: '+e1.message+' ('+e1.code+')');

    // 2. Recalculer les nouveaux montants
    const ns  = (P.solde        || 0) + GAIN;
    const ng  = (P.gains_totaux || 0) + GAIN;
    const ngj = (P.gains_jour   || 0) + GAIN;
    const ngs = (P.gains_semaine|| 0) + GAIN;
    const ngm = (P.gains_mois   || 0) + GAIN;
    const nt  = (P.taches_jour  || 0) + 1;

    // 3. Mettre √† jour le profil
    const{error:e2}=await SB.from('profiles').update({
      solde:         ns,
      gains_totaux:  ng,
      gains_jour:    ngj,
      gains_semaine: ngs,
      gains_mois:    ngm,
      taches_jour:   nt,
    }).eq('id', U.id);
    if(e2) throw new Error('Update profil: '+e2.message+' ('+e2.code+')');

    // 4. Mettre √† jour le cache local
    P.solde=ns; P.gains_totaux=ng; P.gains_jour=ngj;
    P.gains_semaine=ngs; P.gains_mois=ngm; P.taches_jour=nt;

    done.push(t.id);

    // 5. Rafra√Æchir l'affichage
    refreshSolde();
    document.getElementById('adov').classList.remove('open');
    toast('üéâ +'+GAIN+' FCFA cr√©dit√©s ! Solde : '+fmtF(ns));
    renderTaches(stageLeft(P.created_at||U.created_at));

  }catch(err){
    console.error('finishAd error:',err);
    document.getElementById('adov').classList.remove('open');
    toast('‚ùå '+err.message, true);
  }finally{
    saving=false;btn.textContent='‚úÖ R√©clamer +70 FCFA';btn.disabled=false;
  }
}

async function init(){
  const{data:{session}}=await SB.auth.getSession();
  const user=session?.user;
  if(!user){window.location.href='index.html';return}
  U=user;

  const name=user.user_metadata?.full_name||user.email?.split('@')[0]||'Investisseur';
  $s('uname','Bonjour, '+name+' üëã');

  // Charger (ou cr√©er) le profil
  P=await loadProfile(user.id, user.email, name);

  // Afficher les donn√©es
  refreshSolde();

  // Charger les t√¢ches faites aujourd'hui
  const{data:tc}=await SB.from('taches_completees')
    .select('tache_ref')
    .eq('user_id', user.id)
    .eq('type_tache','stage')
    .eq('date_jour', td());

  done=(tc||[]).map(r=>r.tache_ref).filter(Boolean).slice(0,MAX);
  $s('v-tasks', done.length+' / '+MAX);

  // Stage banner + t√¢ches
  const left=stageLeft(P.created_at||user.created_at);
  renderTaches(left);
}

init();
</script>
</body>
</html>
