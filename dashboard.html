<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>VGN â€“ Accueil</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#16A34A;--green-dark:#15803D;
  --orange:#F97316;--orange-dark:#EA580C;
  --bg:#F1F5F1;--card:#fff;
  --text:#111827;--muted:#6B7280;--border:#E5E7EB;
  --top:58px;--bot:58px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{font-family:'Nunito',sans-serif;background:var(--bg);max-width:430px;margin:0 auto;min-height:100vh;overflow-x:hidden}

/* â”€â”€ TOP â”€â”€ */
.topbar{
  position:fixed;top:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:430px;height:var(--top);
  background:linear-gradient(135deg,var(--green-dark),#22C55E);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;z-index:999;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
}
.tl{display:flex;align-items:center;gap:8px;}
.tl-badge{width:32px;height:32px;background:var(--orange);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1rem;box-shadow:0 2px 8px rgba(249,115,22,0.4);}
.tl-name{font-size:1.2rem;font-weight:900;color:#fff;letter-spacing:.07em;}
.tr{display:flex;gap:7px;}
.ibtn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:.95rem;cursor:pointer;}

/* â”€â”€ BODY â”€â”€ */
.body{
  padding-top:calc(var(--top)+10px);
  padding-bottom:calc(var(--bot)+16px);
}

/* â”€â”€ HERO CARD â”€â”€ */
.hero{
  margin:0 11px 10px;
  background:linear-gradient(135deg,var(--green-dark) 0%,#22C55E 100%);
  border-radius:18px;padding:13px 15px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 4px 16px rgba(22,163,74,0.22);
  position:relative;overflow:hidden;
}
.hero::after{content:'ğŸŒ¾';position:absolute;right:-8px;top:-8px;font-size:4.5rem;opacity:.1;}
.hero-txt h4{font-size:.68rem;color:rgba(255,255,255,.72);font-weight:600;}
.hero-txt h2{font-size:1rem;color:#fff;font-weight:900;margin:2px 0;}
.hero-txt p{font-size:.65rem;color:rgba(255,255,255,.6);}
.hero-ico{font-size:2.2rem;position:relative;z-index:1;}

/* â”€â”€ ANNOUNCE â”€â”€ */
.announce{
  margin:0 11px 10px;background:#fff;
  border-radius:12px;padding:8px 11px;
  display:flex;align-items:center;gap:7px;
  box-shadow:0 1px 6px rgba(0,0,0,.06);overflow:hidden;
}
.ann-dot{font-size:.95rem;flex-shrink:0;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
.ann-track{overflow:hidden;flex:1;}
.ann-track span{display:block;white-space:nowrap;font-size:.73rem;font-weight:700;color:var(--text);animation:tick 22s linear infinite;}
@keyframes tick{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

/* â”€â”€ SLIDER â”€â”€ */
.slider{
  margin:0 11px 12px;border-radius:17px;overflow:hidden;
  position:relative;height:172px;
  box-shadow:0 4px 16px rgba(0,0,0,.12);
}
.slide{position:absolute;inset:0;opacity:0;transition:opacity .85s ease;}
.slide.on{opacity:1;}
.slide img{width:100%;height:100%;object-fit:cover;display:block;}
.sov{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.58) 0%,transparent 52%);}
.scap{position:absolute;bottom:0;left:0;right:0;padding:9px 13px;}
.scap h4{font-size:.88rem;font-weight:900;color:#fff;}
.scap p{font-size:.65rem;color:rgba(255,255,255,.78);margin-top:1px;}
.sdots{position:absolute;bottom:9px;right:10px;display:flex;gap:4px;}
.sd{width:6px;height:6px;border-radius:3px;background:rgba(255,255,255,.45);transition:all .3s;}
.sd.on{width:15px;background:var(--orange);}

/* â”€â”€ SECTION HEAD â”€â”€ */
.sh{display:flex;align-items:center;justify-content:space-between;padding:0 13px;margin-bottom:8px;}
.sh h3{font-size:.88rem;font-weight:800;color:var(--text);}
.sh a{font-size:.7rem;color:var(--green);font-weight:700;text-decoration:none;}

/* â”€â”€ ACTIONS 3Ã—2 â”€â”€ */
.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 11px;margin-bottom:12px;}
.ab{display:flex;flex-direction:column;align-items:center;gap:5px;text-decoration:none;cursor:pointer;}
.ab:active .ai{transform:scale(.88);}
.ai{width:50px;height:50px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.35rem;box-shadow:0 3px 10px rgba(0,0,0,.12);transition:transform .18s,box-shadow .18s;}
.ab:hover .ai{transform:translateY(-2px);box-shadow:0 5px 16px rgba(0,0,0,.17);}
.al{font-size:.63rem;font-weight:800;color:var(--text);text-align:center;line-height:1.2;}
.c1{background:linear-gradient(135deg,#F97316,#EA580C);}
.c2{background:linear-gradient(135deg,#3B82F6,#1D4ED8);}
.c3{background:linear-gradient(135deg,#16A34A,#15803D);}
.c4{background:linear-gradient(135deg,#84CC16,#65A30D);}
.c5{background:linear-gradient(135deg,#F43F5E,#BE123C);}
.c6{background:linear-gradient(135deg,#EAB308,#CA8A04);}

/* â”€â”€ SOLDE CARDS 2Ã—2 â”€â”€ */
.solde-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;padding:0 11px;margin-bottom:12px;}
.sc{background:var(--card);border-radius:14px;padding:11px 12px;box-shadow:0 1px 7px rgba(0,0,0,.07);position:relative;overflow:hidden;}
.sc::after{content:attr(data-e);position:absolute;right:-4px;bottom:-4px;font-size:2.3rem;opacity:.1;}
.sc-lbl{font-size:.63rem;color:var(--muted);font-weight:700;margin-bottom:3px;}
.sc-val{font-size:1.05rem;font-weight:900;color:var(--text);}
.sc-sub{font-size:.6rem;margin-top:3px;font-weight:700;}
.sg{color:var(--green);} .so{color:var(--orange);}

/* â”€â”€ STAGE BANNER â”€â”€ */
.stage-banner{
  margin:0 11px 8px;
  background:linear-gradient(135deg,var(--orange),var(--orange-dark));
  border-radius:14px;padding:12px 14px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 3px 12px rgba(249,115,22,.25);
}
.sb-left h4{font-size:.78rem;font-weight:900;color:#fff;}
.sb-left p{font-size:.65rem;color:rgba(255,255,255,.8);margin-top:2px;line-height:1.4;}
.sb-right{text-align:right;flex-shrink:0;margin-left:10px;}
.sb-days{font-size:1.4rem;font-weight:900;color:#fff;line-height:1;}
.sb-days-lbl{font-size:.6rem;color:rgba(255,255,255,.75);}
.stage-progress{margin:0 11px 12px;}
.prog-bar-wrap{background:#E5E7EB;border-radius:6px;height:6px;overflow:hidden;}
.prog-bar{height:100%;background:linear-gradient(90deg,var(--orange),var(--orange-dark));border-radius:6px;transition:width .5s ease;}
.prog-labels{display:flex;justify-content:space-between;margin-top:4px;}
.prog-labels span{font-size:.6rem;font-weight:700;color:var(--muted);}

/* â”€â”€ TACHE CARDS â”€â”€ */
.taches-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:10px;padding:0 11px;
  margin-bottom:14px;
}
.tc{
  background:var(--card);border-radius:16px;
  overflow:hidden;
  box-shadow:0 2px 10px rgba(0,0,0,.08);
  cursor:pointer;
  transition:transform .18s,box-shadow .18s;
  position:relative;
}
.tc:hover{transform:translateY(-2px);box-shadow:0 5px 18px rgba(0,0,0,.13);}
.tc:active{transform:scale(.95);}
.tc.done{opacity:.55;cursor:not-allowed;}
.tc.done::after{
  content:'âœ… Fait';
  position:absolute;inset:0;
  background:rgba(22,163,74,.82);
  display:flex;align-items:center;justify-content:center;
  font-size:.9rem;font-weight:900;color:#fff;
  border-radius:16px;
}
.tc-img{width:100%;height:94px;object-fit:cover;display:block;}
.tc-img-wrap{position:relative;}
.tc-tag{
  position:absolute;top:6px;left:6px;
  background:var(--orange);color:#fff;
  font-size:.57rem;font-weight:800;
  padding:2px 7px;border-radius:5px;
  text-transform:uppercase;letter-spacing:.04em;
}
.tc-tag.free{background:var(--green);}
.tc-tag.vip{background:#7C3AED;}
.tc-body{padding:7px 9px 9px;}
.tc-n{font-size:.75rem;font-weight:800;color:var(--text);}
.tc-r{font-size:.72rem;font-weight:900;color:var(--green);margin-top:2px;}
.tc-desc{font-size:.62rem;color:var(--muted);margin-top:2px;line-height:1.3;}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.botnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:var(--bot);background:#fff;border-top:1px solid var(--border);display:flex;align-items:center;z-index:999;box-shadow:0 -2px 10px rgba(0,0,0,.07);}
.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none;position:relative;cursor:pointer;}
.bn.on::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:26px;height:3px;background:var(--green);border-radius:0 0 3px 3px;}
.bn-ico{font-size:1.2rem;}
.bn-lbl{font-size:.58rem;font-weight:800;color:var(--muted);}
.bn.on .bn-lbl{color:var(--green);}

/* â”€â”€ AD OVERLAY â”€â”€ */
.ad-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.88);
  z-index:2000;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.ad-overlay.open{opacity:1;pointer-events:all;}
.ad-box{
  background:#111;border-radius:20px;
  width:calc(100% - 32px);max-width:400px;
  overflow:hidden;
  box-shadow:0 8px 40px rgba(0,0,0,.6);
}
.ad-video{
  width:100%;height:200px;
  object-fit:cover;display:block;
  background:#000;
}
/* Fake video: image agriculture avec play */
.ad-fake{
  width:100%;height:200px;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  position:relative;background:#000;
}
.ad-fake img{width:100%;height:100%;object-fit:cover;display:block;position:absolute;inset:0;opacity:.6;}
.ad-play{position:relative;z-index:2;font-size:3rem;}
.ad-body{padding:14px 16px;}
.ad-brand{font-size:.7rem;font-weight:700;color:#888;margin-bottom:4px;}
.ad-title{font-size:.9rem;font-weight:900;color:#fff;margin-bottom:6px;}
.ad-bar-wrap{background:#333;border-radius:4px;height:5px;overflow:hidden;margin-bottom:10px;}
.ad-bar{height:100%;background:var(--orange);border-radius:4px;width:0%;transition:width .1s linear;}
.ad-timer{font-size:.75rem;font-weight:800;color:#aaa;text-align:center;margin-bottom:10px;}
.ad-skip{
  width:100%;padding:11px;
  background:linear-gradient(135deg,var(--green),var(--green-dark));
  border:none;border-radius:12px;
  font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:900;color:#fff;
  cursor:pointer;display:none;
  transition:transform .15s;
}
.ad-skip:active{transform:scale(.97);}
.ad-skip.show{display:block;}

/* â”€â”€ TOAST â”€â”€ */
.toast-bar{position:fixed;top:66px;left:50%;transform:translateX(-50%) translateY(-70px);background:#111;color:#fff;padding:7px 18px;border-radius:22px;font-size:.78rem;font-weight:700;z-index:9999;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.2);}
.toast-bar.show{transform:translateX(-50%) translateY(0);}

/* loader */
.ldot{display:inline-block;width:10px;height:10px;border:2px solid #ccc;border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- TOP -->
<div class="topbar">
  <div class="tl">
    <div class="tl-badge">ğŸŒ±</div>
    <span class="tl-name">VGN</span>
  </div>
  <div class="tr">
    <div class="ibtn" onclick="showToast('ğŸ”” Aucune notification')">ğŸ””</div>
    <div class="ibtn" onclick="showToast('ğŸ’¬ Support 24h/24')">ğŸ’¬</div>
  </div>
</div>
<div class="toast-bar" id="tb"></div>

<!-- BODY -->
<div class="body">

  <!-- HERO -->
  <div class="hero">
    <div class="hero-txt">
      <h4>Bienvenue sur</h4>
      <h2 id="uname"><span class="ldot"></span></h2>
      <p>ğŸŒ½ MaÃ¯s &nbsp;Â·&nbsp; ğŸŒ¾ BlÃ© &nbsp;Â·&nbsp; ğŸ„ Ã‰levage</p>
    </div>
    <div class="hero-ico">ğŸ‘¨â€ğŸŒ¾</div>
  </div>

  <!-- ANNOUNCE -->
  <div class="announce">
    <span class="ann-dot">ğŸ“¢</span>
    <div class="ann-track">
      <span>ğŸŒ½ RÃ©colte maÃ¯s +18% ce trimestre &nbsp;|&nbsp; ğŸŒ¾ Nouvelle parcelle blÃ© disponible &nbsp;|&nbsp; ğŸ„ Ã‰levage : rendement record &nbsp;|&nbsp; ğŸ’° Retirez vos gains Ã  tout moment &nbsp;|&nbsp; âœ… 3 tÃ¢ches gratuites par jour pendant 4 jours !</span>
    </div>
  </div>

  <!-- SLIDER -->
  <div class="slider">
    <div class="slide on">
      <img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=800&q=80" alt="MaÃ¯s">
      <div class="sov"></div>
      <div class="scap"><h4>ğŸŒ½ Champs de MaÃ¯s VGN</h4><p>MaÃ¯s bio â€” rendement garanti</p></div>
    </div>
    <div class="slide">
      <img src="https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=800&q=80" alt="BlÃ©">
      <div class="sov"></div>
      <div class="scap"><h4>ğŸŒ¾ Culture de BlÃ© DorÃ©</h4><p>Des hectares de blÃ© pour vous</p></div>
    </div>
    <div class="slide">
      <img src="https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=800&q=80" alt="Ã‰levage">
      <div class="sov"></div>
      <div class="scap"><h4>ğŸ„ Ã‰levage Bovin Premium</h4><p>Gains durables et rentables</p></div>
    </div>
    <div class="slide">
      <img src="https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=800&q=80" alt="Ferme">
      <div class="sov"></div>
      <div class="scap"><h4>ğŸšœ Exploitation VGN</h4><p>Votre investissement en bonnes mains</p></div>
    </div>
    <div class="sdots">
      <div class="sd on" data-i="0"></div>
      <div class="sd" data-i="1"></div>
      <div class="sd" data-i="2"></div>
      <div class="sd" data-i="3"></div>
    </div>
  </div>

  <!-- QUICK ACTIONS -->
  <div class="sh"><h3>Actions rapides</h3></div>
  <div class="actions">
    <a class="ab" href="recharge.html">
      <div class="ai c1">ğŸ’°</div><span class="al">Recharge</span>
    </a>
    <a class="ab" href="retrait.html">
      <div class="ai c2">ğŸ’³</div><span class="al">Retrait</span>
    </a>
    <a class="ab" href="fonds.html">
      <div class="ai c3">ğŸ›¡ï¸</div><span class="al">Mes Fonds</span>
    </a>
    <a class="ab" href="roue.html">
      <div class="ai c4">ğŸ¡</div><span class="al">Roue Chance</span>
    </a>
    <a class="ab" href="inviter.html">
      <div class="ai c5">ğŸ‘¥</div><span class="al">Inviter</span>
    </a>
    <a class="ab" href="vip.html">
      <div class="ai c6">ğŸ’</div><span class="al">VIP</span>
    </a>
  </div>

  <!-- SOLDE -->
  <div class="sh"><h3>Mon Portefeuille</h3></div>
  <div class="solde-row">
    <div class="sc" data-e="ğŸ’°">
      <div class="sc-lbl">Solde disponible</div>
      <div class="sc-val" id="v-solde"><span class="ldot"></span></div>
      <div class="sc-sub sg" id="v-solde-sub">â€”</div>
    </div>
    <div class="sc" data-e="ğŸ“ˆ">
      <div class="sc-lbl">Gains totaux</div>
      <div class="sc-val" id="v-gains"><span class="ldot"></span></div>
      <div class="sc-sub so">CumulÃ©s</div>
    </div>
    <div class="sc" data-e="ğŸŒ±">
      <div class="sc-lbl">Investissement</div>
      <div class="sc-val" id="v-invest"><span class="ldot"></span></div>
      <div class="sc-sub sg">Actif</div>
    </div>
    <div class="sc" data-e="âœ…">
      <div class="sc-lbl">TÃ¢ches / jour</div>
      <div class="sc-val" id="v-tasks"><span class="ldot"></span></div>
      <div class="sc-sub so" id="v-tasks-sub">ComplÃ©tÃ©es</div>
    </div>
  </div>

  <!-- STAGE BANNER -->
  <div class="stage-banner" id="stage-banner">
    <div class="sb-left">
      <h4>ğŸ“ TÃ¢ches gratuites â€” Stage</h4>
      <p>Regardez les publicitÃ©s,<br>gagnez 70 FCFA par tÃ¢che (max 3/jour)</p>
    </div>
    <div class="sb-right">
      <div class="sb-days" id="stage-days-left">â€”</div>
      <div class="sb-days-lbl">jours restants</div>
    </div>
  </div>
  <div class="stage-progress">
    <div class="prog-bar-wrap">
      <div class="prog-bar" id="stage-prog-bar" style="width:0%"></div>
    </div>
    <div class="prog-labels">
      <span>Jour 1</span>
      <span id="stage-prog-label">0 / 4 jours</span>
      <span>Jour 4</span>
    </div>
  </div>

  <!-- TÃ‚CHES GRATUITES -->
  <div class="sh">
    <h3>ğŸ¯ TÃ¢ches gratuites du jour</h3>
    <span id="tasks-count-lbl" style="font-size:.7rem;font-weight:800;color:var(--orange)"></span>
  </div>
  <div class="taches-grid" id="taches-grid">
    <!-- gÃ©nÃ©rÃ©es par JS -->
  </div>

</div><!-- /body -->

<!-- BOTTOM NAV -->
<nav class="botnav">
  <a class="bn on" href="dashboard.html"><span class="bn-ico">ğŸ </span><span class="bn-lbl">Accueil</span></a>
  <a class="bn" href="taches.html"><span class="bn-ico">âœ…</span><span class="bn-lbl">TÃ¢ches</span></a>
  <a class="bn" href="rapport.html"><span class="bn-ico">ğŸ“Š</span><span class="bn-lbl">Rapports</span></a>
  <a class="bn" href="profil.html"><span class="bn-ico">ğŸ‘¤</span><span class="bn-lbl">Mon Compte</span></a>
</nav>

<!-- AD OVERLAY -->
<div class="ad-overlay" id="ad-overlay">
  <div class="ad-box">
    <div class="ad-fake" id="ad-img-wrap">
      <img id="ad-img" src="" alt="pub">
      <div class="ad-play">â–¶ï¸</div>
    </div>
    <div class="ad-body">
      <div class="ad-brand" id="ad-brand">VGN Agriculture</div>
      <div class="ad-title" id="ad-title">DÃ©couvrez nos champs de maÃ¯s</div>
      <div class="ad-bar-wrap"><div class="ad-bar" id="ad-bar"></div></div>
      <div class="ad-timer" id="ad-timer">Regardez pendant <b>15</b> secondes...</div>
      <button class="ad-skip" id="ad-skip-btn" onclick="finishAd()">
        âœ… PublicitÃ© terminÃ©e â€” RÃ©clamer 70 FCFA
      </button>
    </div>
  </div>
</div>

<script>
const SB = supabase.createClient(
  'https://tgrfzybemuwvhkbpuzmz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE'
);

// â”€â”€ DONNÃ‰ES â”€â”€
const TACHES_LIBRES = [
  { id:'t1', nom:'Champs de MaÃ¯s VGN',    reward:70, img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400&q=80', tag:'Gratuit', desc:'Regardez notre pub maÃ¯s' },
  { id:'t2', nom:'BlÃ© DorÃ© Premium',       reward:70, img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&q=80', tag:'Gratuit', desc:'DÃ©couvrez nos cultures' },
  { id:'t3', nom:'Ã‰levage Bovin VGN',      reward:70, img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=400&q=80', tag:'Gratuit', desc:'Nos bÃªtes primÃ©es' },
  { id:'t4', nom:'Grande RÃ©colte 2025',    reward:70, img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&q=80', tag:'Gratuit', desc:'RÃ©colte record cette annÃ©e' },
  { id:'t5', nom:'Ferme Bio CertifiÃ©e',    reward:70, img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=400&q=80', tag:'Gratuit', desc:'Agriculture durable' },
  { id:'t6', nom:'Culture du Sol VGN',     reward:70, img:'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&q=80', tag:'Gratuit', desc:'PrÃ©parer la prochaine saison' },
  { id:'t7', nom:'Lait & Produits Laitiers', reward:70, img:'https://images.unsplash.com/photo-1527847263472-aa5338d178b8?w=400&q=80', tag:'Gratuit', desc:'Produits frais de la ferme' },
  { id:'t8', nom:'Irrigation Moderne',     reward:70, img:'https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=400&q=80', tag:'Gratuit', desc:'Technologie agricole VGN' },
];

const ADS = [
  { brand:'VGN Agriculture', title:'DÃ©couvrez nos champs de maÃ¯s bio', img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=600&q=80' },
  { brand:'VGN BlÃ© DorÃ©',    title:'Investissez dans le blÃ© premium', img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=600&q=80' },
  { brand:'VGN Ã‰levage',     title:'Notre bÃ©tail primÃ© vous attend',  img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=600&q=80' },
  { brand:'VGN RÃ©colte',     title:'Grande rÃ©colte 2025 en cours !',  img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=600&q=80' },
  { brand:'VGN Farm',        title:'Ferme biologique certifiÃ©e',      img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=600&q=80' },
];

let authUser = null;
let profile  = null;
let adTimer  = null;
let currentTaskId = null;
let tasksDoneToday = [];
const AD_DURATION  = 15; // secondes
const MAX_TASKS    = 3;
const STAGE_DAYS   = 4;
const REWARD       = 70;

// â”€â”€ HELPERS â”€â”€
const fmt  = n => Number(n).toLocaleString('fr-FR');
const fmtF = n => fmt(n)+' FCFA';
function showToast(msg){ const t=document.getElementById('tb');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200); }
function set(id,v){ const e=document.getElementById(id);if(e)e.textContent=v; }

// â”€â”€ SLIDER â”€â”€
let cur=0;
const slides=document.querySelectorAll('.slide');
const dots=document.querySelectorAll('.sd');
function goTo(n){
  slides[cur].classList.remove('on');dots[cur].classList.remove('on');
  cur=(n+slides.length)%slides.length;
  slides[cur].classList.add('on');dots[cur].classList.add('on');
}
setInterval(()=>goTo(cur+1),3800);
dots.forEach((d,i)=>d.addEventListener('click',()=>goTo(i)));

// â”€â”€ STAGE PROGRESS â”€â”€
function updateStageBanner(createdAt){
  const ms = Date.now() - new Date(createdAt).getTime();
  const daysDone = Math.min(Math.floor(ms/(1000*60*60*24)), STAGE_DAYS);
  const daysLeft = Math.max(STAGE_DAYS - daysDone, 0);
  const pct = (daysDone / STAGE_DAYS)*100;

  set('stage-days-left', daysLeft);
  set('stage-prog-label', daysDone+' / '+STAGE_DAYS+' jours');
  document.getElementById('stage-prog-bar').style.width = pct+'%';

  const banner = document.getElementById('stage-banner');
  if(daysLeft === 0){
    banner.style.background='linear-gradient(135deg,#6B7280,#374151)';
    document.querySelector('.sb-left h4').textContent = 'ğŸ“ Stage terminÃ©';
    document.querySelector('.sb-left p').textContent  = 'Passez Ã  un plan VIP pour continuer';
  }
  return daysLeft;
}

// â”€â”€ RENDER TÃ‚CHES â”€â”€
function renderTaches(daysLeft){
  const grid = document.getElementById('taches-grid');
  grid.innerHTML = '';
  const done = tasksDoneToday.length;
  set('tasks-count-lbl', done+' / '+MAX_TASKS+' aujourd\'hui');

  if(daysLeft === 0){
    grid.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:20px 14px;background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.07);">
        <div style="font-size:2.5rem;margin-bottom:8px;">ğŸ“</div>
        <div style="font-size:.85rem;font-weight:800;color:var(--text);margin-bottom:4px;">Stage de 4 jours terminÃ© !</div>
        <div style="font-size:.73rem;color:var(--muted);margin-bottom:12px;">Investissez dans un plan VIP pour accÃ©der aux tÃ¢ches rÃ©munÃ©rÃ©es.</div>
        <a href="vip.html" style="display:inline-block;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;padding:10px 20px;border-radius:12px;font-size:.82rem;font-weight:800;text-decoration:none;">ğŸ’ Voir les plans VIP</a>
      </div>`;
    return;
  }

  TACHES_LIBRES.forEach(t => {
    const isDone = tasksDoneToday.includes(t.id);
    const isMax  = done >= MAX_TASKS;
    const card   = document.createElement('div');
    card.className = 'tc'+(isDone?' done':'');
    card.onclick = (!isDone && !isMax) ? () => startTask(t) : null;
    if(isMax && !isDone) card.style.opacity = '.5';

    card.innerHTML = `
      <div class="tc-img-wrap">
        <img class="tc-img" src="${t.img}" alt="${t.nom}" loading="lazy">
        <span class="tc-tag free">${t.tag}</span>
      </div>
      <div class="tc-body">
        <div class="tc-n">${t.nom}</div>
        <div class="tc-r">+${fmt(t.reward)} FCFA</div>
        <div class="tc-desc">${t.desc}</div>
      </div>`;
    grid.appendChild(card);
  });

  if(done >= MAX_TASKS){
    const notice = document.createElement('div');
    notice.style.cssText = 'grid-column:1/-1;text-align:center;padding:12px;background:#F0FDF4;border-radius:12px;font-size:.75rem;font-weight:700;color:var(--green);';
    notice.textContent = 'âœ… Vous avez complÃ©tÃ© vos 3 tÃ¢ches du jour ! Revenez demain.';
    grid.appendChild(notice);
  }
}

// â”€â”€ DÃ‰MARRER UNE TÃ‚CHE â”€â”€
function startTask(t){
  currentTaskId = t.id;
  const ad = ADS[Math.floor(Math.random()*ADS.length)];

  document.getElementById('ad-img').src   = t.img;
  document.getElementById('ad-brand').textContent = ad.brand;
  document.getElementById('ad-title').textContent = ad.title;
  document.getElementById('ad-bar').style.width   = '0%';
  document.getElementById('ad-timer').innerHTML   = `Regardez pendant <b>${AD_DURATION}</b> secondes...`;
  document.getElementById('ad-skip-btn').classList.remove('show');

  document.getElementById('ad-overlay').classList.add('open');

  let elapsed = 0;
  clearInterval(adTimer);
  adTimer = setInterval(()=>{
    elapsed++;
    const pct = (elapsed/AD_DURATION)*100;
    document.getElementById('ad-bar').style.width = pct+'%';
    const rem = AD_DURATION - elapsed;
    document.getElementById('ad-timer').innerHTML = rem > 0
      ? `Regardez pendant <b>${rem}</b> seconde${rem>1?'s':''}...`
      : 'ğŸ‰ PublicitÃ© terminÃ©e !';
    if(elapsed >= AD_DURATION){
      clearInterval(adTimer);
      document.getElementById('ad-skip-btn').classList.add('show');
      document.getElementById('ad-timer').innerHTML = 'ğŸ‰ Cliquez pour rÃ©clamer votre gain !';
    }
  }, 1000);
}

// â”€â”€ TERMINER LA PUB â†’ CRÃ‰DITER â”€â”€
async function finishAd(){
  clearInterval(adTimer);
  document.getElementById('ad-overlay').classList.remove('open');

  if(!currentTaskId || !authUser) return;

  const daysLeft = updateStageBanner(profile.created_at || authUser.created_at);
  if(daysLeft === 0){ showToast('â›” Stage terminÃ©.'); return; }
  if(tasksDoneToday.length >= MAX_TASKS){ showToast('âš ï¸ Maximum 3 tÃ¢ches par jour'); return; }
  if(tasksDoneToday.includes(currentTaskId)){ showToast('âœ… TÃ¢che dÃ©jÃ  complÃ©tÃ©e'); return; }

  tasksDoneToday.push(currentTaskId);

  // Mettre Ã  jour Supabase
  try{
    const nvSolde      = (profile.solde||0) + REWARD;
    const nvGainsJour  = (profile.gains_jour||0) + REWARD;
    const nvGainsTotaux= (profile.gains_totaux||0) + REWARD;
    const nvTaches     = (profile.taches_jour||0) + 1;

    await SB.from('profiles').update({
      solde:        nvSolde,
      gains_jour:   nvGainsJour,
      gains_totaux: nvGainsTotaux,
      taches_jour:  nvTaches,
    }).eq('id', authUser.id);

    await SB.from('taches_completees').insert({
      user_id:   authUser.id,
      tache_id:  null,
      reward:    REWARD,
    }).select();

    profile.solde         = nvSolde;
    profile.gains_jour    = nvGainsJour;
    profile.gains_totaux  = nvGainsTotaux;
    profile.taches_jour   = nvTaches;

    // Refresh UI
    set('v-solde',  fmtF(nvSolde));
    set('v-gains',  fmtF(nvGainsTotaux));
    set('v-tasks',  nvTaches+' / '+MAX_TASKS);

    showToast(`ğŸ‰ +${REWARD} FCFA crÃ©ditÃ©s sur votre compte !`);
    renderTaches(daysLeft);

  }catch(e){
    console.error(e);
    showToast('âŒ Erreur rÃ©seau, rÃ©essayez');
    tasksDoneToday.pop();
  }

  currentTaskId = null;
}

// â”€â”€ INIT â”€â”€
async function init(){
  const { data:{ user } } = await SB.auth.getUser();
  if(!user){ window.location.href='index.html'; return; }
  authUser = user;

  const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'Investisseur';
  set('uname', 'Bonjour, '+name+' ğŸ‘‹');

  const { data:p } = await SB.from('profiles')
    .select('solde,gains_totaux,gains_jour,investissement,taches_jour,created_at,vip_niveau')
    .eq('id', user.id).single();

  profile = p || { solde:0, gains_totaux:0, gains_jour:0, investissement:0, taches_jour:0, created_at:user.created_at };

  set('v-solde',  fmtF(profile.solde||0));
  set('v-gains',  fmtF(profile.gains_totaux||0));
  set('v-invest', fmtF(profile.investissement||0));
  set('v-tasks',  (profile.taches_jour||0)+' / '+MAX_TASKS);
  set('v-solde-sub', (profile.solde||0)>0 ? 'â†‘ Solde disponible' : 'â†‘ Effectuez votre 1er dÃ©pÃ´t');

  // Charger taches completÃ©es aujourd'hui
  const today = new Date().toISOString().slice(0,10);
  const { data:tcToday } = await SB.from('taches_completees')
    .select('id,completee_le')
    .eq('user_id', user.id)
    .gte('completee_le', today+'T00:00:00');

  // On utilise l'index local pour les IDs libres
  tasksDoneToday = (tcToday||[]).map((_,i) => TACHES_LIBRES[i]?.id).filter(Boolean);
  // RÃ©-aligner avec le compteur rÃ©el
  const realDone = Math.min(tcToday?.length||0, MAX_TASKS);
  tasksDoneToday = TACHES_LIBRES.slice(0, realDone).map(t=>t.id);

  const createdAt = profile.created_at || user.created_at;
  const daysLeft  = updateStageBanner(createdAt);
  renderTaches(daysLeft);
}

init();
</script>
</body>
</html>
