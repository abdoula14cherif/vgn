<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<title>VGN ‚Äì Mes Fonds</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#16A34A;--green-dark:#15803D;
  --orange:#F97316;--orange-dark:#EA580C;
  --bg:#F2F5F2;--card:#fff;
  --text:#111827;--muted:#6B7280;--border:#E5E7EB;
  --top:56px;--bot:58px;
  --sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  font-family:'Nunito',sans-serif;
  background:var(--bg);
  max-width:430px;
  margin:0 auto;
  min-height:100vh;
  overflow-x:hidden;
}

/* ‚îÄ‚îÄ TOP ‚îÄ‚îÄ */
.topbar{
  position:fixed;top:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:430px;height:calc(var(--top) + var(--sat));
  background:linear-gradient(135deg,var(--green-dark),#22C55E);
  display:flex;align-items:center;justify-content:space-between;
  padding:var(--sat) 14px 0;z-index:999;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
}
.tb-back{
  width:34px;height:34px;border-radius:50%;
  background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);
  display:flex;align-items:center;justify-content:center;
  font-size:1.2rem;font-weight:900;color:#fff;
  text-decoration:none;cursor:pointer;
}
.tb-title{font-size:1rem;font-weight:900;color:#fff;}
.tb-hist{
  width:34px;height:34px;border-radius:50%;
  background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;color:#fff;text-decoration:none;cursor:pointer;
}

/* ‚îÄ‚îÄ BODY ‚îÄ‚îÄ */
.body{
  padding-top:calc(var(--top) + var(--sat) + 12px);
  padding-bottom:calc(var(--bot) + var(--sab) + 28px);
}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-card{
  margin:0 12px 14px;
  background:#fff;border-radius:18px;
  padding:16px 20px;
  display:flex;justify-content:space-around;align-items:center;
  box-shadow:0 2px 12px rgba(0,0,0,0.07);
}
.sc-item{text-align:center;}
.sc-lbl{font-size:0.65rem;color:var(--muted);font-weight:700;margin-bottom:4px;}
.sc-val{font-size:1.25rem;font-weight:900;color:var(--orange);}
.sc-divider{width:1px;background:var(--border);height:40px;}

/* ‚îÄ‚îÄ SECTION ‚îÄ‚îÄ */
.sec{padding:0 13px;margin-bottom:10px;}
.sec h3{font-size:0.9rem;font-weight:800;color:var(--text);}

/* ‚îÄ‚îÄ FUND CARDS ‚îÄ‚îÄ */
.fund-list{
  display:flex;flex-direction:column;
  gap:12px;
  padding:0 12px;
  margin-bottom:16px;
}

.fund-card{
  background:#fff;
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 3px 14px rgba(0,0,0,0.09);
  border:1.5px solid var(--border);
}

/* Image pleine largeur en haut */
.fund-img-wrap{
  position:relative;
  width:100%;
  height:140px;
  overflow:hidden;
}
.fund-img-wrap img{
  width:100%;height:100%;
  object-fit:cover;display:block;
  transition:transform .4s ease;
}
.fund-card:hover .fund-img-wrap img{transform:scale(1.04);}

.fund-overlay{
  position:absolute;inset:0;
  background:linear-gradient(to top, rgba(0,0,0,0.55) 0%, transparent 55%);
}
.fund-img-title{
  position:absolute;bottom:10px;left:12px;
  font-size:1rem;font-weight:900;color:#fff;
  text-shadow:0 1px 4px rgba(0,0,0,0.4);
}
.fund-vip-tag{
  position:absolute;top:10px;right:10px;
  background:var(--orange);color:#fff;
  font-size:0.6rem;font-weight:900;
  padding:3px 9px;border-radius:7px;
  letter-spacing:.04em;text-transform:uppercase;
}

/* Card body */
.fund-body{padding:12px 14px 14px;}

.fund-info-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:6px;margin-bottom:10px;
}
.fi{
  background:#F9FAFB;border-radius:10px;
  padding:7px 10px;
}
.fi-lbl{font-size:0.6rem;color:var(--muted);font-weight:700;margin-bottom:2px;}
.fi-val{font-size:0.82rem;font-weight:900;color:var(--text);}
.fi-val.green{color:var(--green);}
.fi-val.orange{color:var(--orange);}

.fund-rembours{
  display:inline-flex;align-items:center;gap:5px;
  border:1.5px solid var(--green);border-radius:20px;
  padding:4px 12px;margin-bottom:10px;
  font-size:0.65rem;font-weight:700;color:var(--green);
}

.fund-detail-btn{
  display:flex;align-items:center;justify-content:space-between;
  width:100%;
  background:linear-gradient(135deg,var(--green),var(--green-dark));
  border:none;border-radius:12px;
  padding:10px 14px;
  font-family:'Nunito',sans-serif;
  font-size:0.82rem;font-weight:900;color:#fff;
  cursor:pointer;
  transition:transform .15s,box-shadow .2s;
  box-shadow:0 3px 10px rgba(22,163,74,0.25);
}
.fund-detail-btn:active{transform:scale(0.97);}
.fund-detail-btn .arr{font-size:1rem;}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.botnav{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:430px;height:var(--bot);
  background:#fff;border-top:1px solid var(--border);
  display:flex;align-items:center;z-index:999;
  box-shadow:0 -2px 10px rgba(0,0,0,0.07);
}
.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none;position:relative;cursor:pointer;}
.bn.on::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:26px;height:3px;background:var(--green);border-radius:0 0 3px 3px;}
.bn-ico{font-size:1.2rem;}
.bn-lbl{font-size:0.58rem;font-weight:800;color:var(--muted);}
.bn.on .bn-lbl{color:var(--green);}

/* ‚îÄ‚îÄ MODAL D√âTAIL ‚îÄ‚îÄ */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.52);
  z-index:1000;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .28s;
}
.overlay.open{opacity:1;pointer-events:all;}

.modal{
  background:#fff;
  width:100%;max-width:430px;
  border-radius:24px 24px 0 0;
  max-height:90vh;
  overflow-y:auto;
  padding:0 18px 32px;
  transform:translateY(100%);
  transition:transform .35s cubic-bezier(.34,1.56,.64,1);
  -webkit-overflow-scrolling:touch;
}
.overlay.open .modal{transform:translateY(0);}

/* Modal top image */
.modal-img{
  width:calc(100% + 36px);
  margin-left:-18px;
  height:160px;object-fit:cover;
  display:block;
}
.modal-img-wrap{position:relative;margin:0 -18px;}
.modal-img-overlay{
  position:absolute;inset:0;
  background:linear-gradient(to top,rgba(0,0,0,0.6) 0%,transparent 50%);
}
.modal-img-title{
  position:absolute;bottom:12px;left:18px;
  font-size:1.15rem;font-weight:900;color:#fff;
}

.modal-handle{width:38px;height:4px;background:#E5E7EB;border-radius:2px;margin:14px auto 0;}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 0 12px;
  border-bottom:1px solid var(--border);
  margin-bottom:14px;
  position:sticky;top:0;background:#fff;z-index:2;
}
.modal-header h3{font-size:1rem;font-weight:900;color:var(--text);}
.modal-close{
  width:30px;height:30px;border-radius:50%;background:#F3F4F6;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;font-weight:900;cursor:pointer;border:none;color:var(--text);
}

/* detail rows */
.detail-row{
  display:flex;align-items:baseline;gap:8px;
  padding:9px 0;border-bottom:1px solid #F9FAFB;
}
.dr-lbl{font-size:0.78rem;font-weight:800;color:var(--text);min-width:130px;flex-shrink:0;}
.dr-val{font-size:0.78rem;font-weight:700;color:var(--muted);flex:1;}

.detail-box{
  border-radius:14px;padding:13px 14px;margin:12px 0;
}
.detail-box.green{background:#F0FDF4;}
.detail-box.orange{background:#FFF7ED;}
.detail-box .db-title{font-size:0.78rem;font-weight:900;margin-bottom:7px;}
.detail-box.green .db-title{color:var(--green-dark);}
.detail-box.orange .db-title{color:var(--orange-dark);}
.detail-box p{font-size:0.75rem;color:#374151;line-height:1.65;font-weight:600;}

/* Montant */
.montant-wrap{margin:14px 0 10px;}
.montant-wrap label{font-size:0.8rem;font-weight:800;color:var(--text);display:block;margin-bottom:6px;}
.input-row{position:relative;}
.montant-input{
  width:100%;padding:12px 60px 12px 14px;
  border:2px solid var(--border);border-radius:12px;
  font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:800;color:var(--text);
  outline:none;transition:border-color .2s;
}
.montant-input:focus{border-color:var(--green);}
.input-suffix{
  position:absolute;right:14px;top:50%;transform:translateY(-50%);
  font-size:0.75rem;font-weight:800;color:var(--muted);
}

/* Solde check */
.solde-row{
  display:flex;justify-content:space-between;align-items:center;
  background:#F9FAFB;border-radius:11px;padding:10px 13px;margin-bottom:12px;
}
.sr-left .sr-lbl{font-size:0.65rem;color:var(--muted);font-weight:700;}
.sr-left .sr-val{font-size:0.95rem;font-weight:900;}
.sr-ico{font-size:1.4rem;}
.ok{color:var(--green);} .nok{color:#EF4444;}

/* Rendement preview */
.rendement-preview{
  display:none;
  background:linear-gradient(135deg,var(--green-dark),var(--green));
  border-radius:12px;padding:12px 14px;margin-bottom:14px;
}
.rp-row{display:flex;justify-content:space-between;align-items:center;}
.rp-lbl{font-size:0.68rem;color:rgba(255,255,255,0.8);font-weight:700;}
.rp-val{font-size:0.95rem;font-weight:900;color:#fff;}

/* Buy btn */
.buy-btn{
  width:100%;padding:14px;border:none;border-radius:16px;
  font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;color:#fff;
  cursor:pointer;transition:transform .15s,box-shadow .2s;
}
.buy-btn.g{background:linear-gradient(135deg,var(--green),var(--green-dark));box-shadow:0 4px 16px rgba(22,163,74,0.3);}
.buy-btn.r{background:linear-gradient(135deg,#F97316,#EA580C);box-shadow:0 4px 16px rgba(249,115,22,0.3);}
.buy-btn:active{transform:scale(0.97);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-bar{
  position:fixed;top:64px;left:50%;
  transform:translateX(-50%) translateY(-70px);
  background:#111;color:#fff;padding:7px 18px;border-radius:22px;
  font-size:0.78rem;font-weight:700;z-index:9999;
  white-space:nowrap;pointer-events:none;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
}
.toast-bar.show{transform:translateX(-50%) translateY(0);}

/* loader */
.ldot{display:inline-block;width:10px;height:10px;border:2px solid #ccc;border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- TOP -->
<div class="topbar">
  <a class="tb-back" href="dashboard.html">‚Äπ</a>
  <span class="tb-title">üí∞ Mes Fonds</span>
  <div style="font-size:.68rem;font-weight:800;color:#fff;background:rgba(255,255,255,.15);padding:4px 9px;border-radius:16px;border:1px solid rgba(255,255,255,.25)">üí∞ <span id="tb-solde">‚Äî</span></div>
</div>
<div class="toast-bar" id="tb"></div>

<!-- BODY -->
<div class="body">

  <!-- STATS -->
  <div class="stats-card">
    <div class="sc-item">
      <div class="sc-lbl">Montant total des fonds</div>
      <div class="sc-val" id="total-fonds"><span class="ldot"></span></div>
    </div>
    <div class="sc-divider"></div>
    <div class="sc-item">
      <div class="sc-lbl">Revenu total attendu</div>
      <div class="sc-val" id="total-attendu"><span class="ldot"></span></div>
    </div>
  </div>

  <!-- LIST -->
  <div class="sec"><h3>üìã Liste des fonds VGN</h3></div>
  <div class="fund-list" id="fund-list"></div>

</div>

<!-- BOTTOM NAV -->
<nav class="botnav">
  <a class="bn" href="dashboard.html"><span class="bn-ico">üè†</span><span class="bn-lbl">Accueil</span></a>
  <a class="bn" href="taches.html"><span class="bn-ico">‚úÖ</span><span class="bn-lbl">T√¢ches</span></a>
  <a class="bn" href="rapport.html"><span class="bn-ico">üìä</span><span class="bn-lbl">Rapports</span></a>
  <a class="bn" href="profil.html"><span class="bn-ico">üë§</span><span class="bn-lbl">Mon Compte</span></a>
</nav>

<!-- MODAL -->
<div class="overlay" id="overlay" onclick="closeOutside(event)">
  <div class="modal" id="modal">
    <div class="modal-handle"></div>
    <!-- Image dans la modal -->
    <div class="modal-img-wrap" id="m-img-wrap">
      <img class="modal-img" id="m-img" src="" alt="">
      <div class="modal-img-overlay"></div>
      <div class="modal-img-title" id="m-img-title">‚Äî</div>
    </div>

    <div class="modal-header">
      <h3 id="m-title">‚Äî</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>

    <div class="detail-row">
      <span class="dr-lbl">üè¶ Minimum d'achat</span>
      <span class="dr-val" id="m-min">‚Äî</span>
    </div>
    <div class="detail-row">
      <span class="dr-lbl">üìÖ Dur√©e</span>
      <span class="dr-val" id="m-duree">‚Äî</span>
    </div>
    <div class="detail-row">
      <span class="dr-lbl">üìà Taux de rendement</span>
      <span class="dr-val" id="m-taux">‚Äî</span>
    </div>

    <div class="detail-box green">
      <div class="db-title">üìñ Description du fonds</div>
      <p id="m-desc">‚Äî</p>
    </div>

    <div class="detail-box orange">
      <div class="db-title">üßÆ M√©thode de calcul</div>
      <p id="m-calc">‚Äî</p>
    </div>

    <!-- Montant -->
    <div class="montant-wrap">
      <label>Montant √† investir</label>
      <div class="input-row">
        <input class="montant-input" type="number" id="m-montant" placeholder="Ex: 10 000" oninput="updateRendement()">
        <span class="input-suffix">FCFA</span>
      </div>
    </div>

    <!-- Solde -->
    <div class="solde-row">
      <div class="sr-left">
        <div class="sr-lbl">Votre solde disponible</div>
        <div class="sr-val ok" id="m-solde">‚Äî</div>
      </div>
      <div class="sr-ico" id="m-solde-ico">‚Äî</div>
    </div>

    <!-- Rendement preview -->
    <div class="rendement-preview" id="rp">
      <div class="rp-row" style="margin-bottom:6px;">
        <span class="rp-lbl">Capital + Int√©r√™ts</span>
        <span class="rp-val" id="rp-total">‚Äî</span>
      </div>
      <div class="rp-row">
        <span class="rp-lbl">Int√©r√™ts gagn√©s</span>
        <span class="rp-val" id="rp-interets">‚Äî</span>
      </div>
    </div>

    <button class="buy-btn g" id="buy-btn" onclick="acheter()">
      üå± Investir maintenant
    </button>

  </div>
</div>

<script>
const SB = supabase.createClient('https://tgrfzybemuwvhkbpuzmz.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE',{auth:{persistSession:true,storageKey:'vgn-auth',storage:window.localStorage}});

// ‚îÄ‚îÄ DONN√âES DES 5 FONDS ‚îÄ‚îÄ
const FONDS = [
  {
    id:1, nom:'VGN Fund 1', jours:7, taux:15, min:10000, niveau:'VIP 1',
    img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=600&q=80',
    desc:'Le Fonds VGN 1 est un fonds d\'investissement agricole √† court terme, id√©al pour les investisseurs cherchant un retour rapide. Sur une p√©riode de 7 jours, vous pouvez obtenir un rendement de 15%. Ce fonds pr√©sente un faible risque et une haute liquidit√©, en faisant un choix id√©al pour une rotation rapide des fonds.',
  },
  {
    id:2, nom:'VGN Fund 2', jours:15, taux:25, min:20000, niveau:'VIP 1',
    img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=600&q=80',
    desc:'Le Fonds VGN 2 est un placement √† moyen terme offrant 25% de rendement sur 15 jours. Soutenu par nos champs de bl√© dor√© et notre production c√©r√©ali√®re, ce fonds combine s√©curit√© agricole et performance financi√®re.',
  },
  {
    id:3, nom:'VGN Fund 3', jours:30, taux:35, min:30000, niveau:'VIP 1',
    img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=600&q=80',
    desc:'Le Fonds VGN 3 offre un rendement de 35% sur 30 jours. Soutenu par nos grandes exploitations agricoles et notre √©levage bovin, ce fonds garantit une stabilit√© solide et des profits r√©guliers pour l\'investisseur patient.',
  },
  {
    id:4, nom:'VGN Fund 4', jours:90, taux:100, min:40000, niveau:'VIP 1',
    img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=600&q=80',
    desc:'Le Fonds VGN 4 est notre fonds phare √† long terme. Avec un rendement de 100% sur 90 jours, il double votre capital gr√¢ce √† nos investissements agricoles diversifi√©s : ma√Øs, bl√©, √©levage et transformation. R√©serv√© aux investisseurs ambitieux.',
  },
  {
    id:5, nom:'VGN Fund 5', jours:95, taux:250, min:5000, niveau:'VIP 1',
    img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=600&q=80',
    desc:'Le Fonds VGN 5 est notre offre premium sur 95 jours avec un rendement exceptionnel de 250%. Sur 3 mois, votre capital cro√Æt de mani√®re spectaculaire gr√¢ce √† l\'ensemble de nos activit√©s : cultures, √©levage, lait et transformation agricole.',
  },
];

let user = null;
let profile = null;
let fondActif = null;

const fmt  = n => Number(n).toLocaleString('fr-FR');
const fmtF = n => fmt(n)+' FCFA';

function showToast(msg){
  const t=document.getElementById('tb');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

// ‚îÄ‚îÄ RENDER CARDS ‚îÄ‚îÄ
function renderFunds(){
  const c = document.getElementById('fund-list');
  c.innerHTML = '';
  FONDS.forEach(f => {
    const interetsEx = f.min * f.taux / 100;
    const card = document.createElement('div');
    card.className = 'fund-card';
    card.innerHTML = `
      <div class="fund-img-wrap">
        <img src="${f.img}" alt="${f.nom}" loading="lazy">
        <div class="fund-overlay"></div>
        <div class="fund-img-title">${f.nom}</div>
        <span class="fund-vip-tag">${f.niveau}</span>
      </div>
      <div class="fund-body">
        <div class="fund-info-grid">
          <div class="fi">
            <div class="fi-lbl">‚è± Dur√©e</div>
            <div class="fi-val">${f.jours} jours</div>
          </div>
          <div class="fi">
            <div class="fi-lbl">üìà Taux</div>
            <div class="fi-val green">${f.taux}%</div>
          </div>
          <div class="fi">
            <div class="fi-lbl">üí∞ Minimum</div>
            <div class="fi-val orange">${fmtF(f.min)}</div>
          </div>
          <div class="fi">
            <div class="fi-lbl">üéØ Gain min</div>
            <div class="fi-val green">${fmtF(interetsEx)}</div>
          </div>
        </div>
        <div class="fund-rembours">üîÑ Remboursement des int√©r√™ts √† √©ch√©ance</div>
        <button class="fund-detail-btn" onclick="openDetail(${f.id})">
          <span>Voir les d√©tails</span>
          <span class="arr">‚Ä∫</span>
        </button>
      </div>
    `;
    c.appendChild(card);
  });
}

// ‚îÄ‚îÄ OUVRIR MODAL ‚îÄ‚îÄ
function openDetail(id){
  const f = FONDS.find(x=>x.id===id);
  if(!f) return;
  fondActif = f;

  const solde = profile?.solde || 0;
  const peutPayer = solde >= f.min;
  const interetsEx = f.min * f.taux / 100;
  const totalEx = f.min + interetsEx;

  // Image
  document.getElementById('m-img').src = f.img;
  document.getElementById('m-img-title').textContent = f.nom;
  document.getElementById('m-title').textContent = f.nom;

  document.getElementById('m-min').textContent   = fmtF(f.min);
  document.getElementById('m-duree').textContent = f.jours+' jours';
  document.getElementById('m-taux').textContent  = f.taux+'% du montant total investi';
  document.getElementById('m-desc').textContent  = f.desc;
  document.getElementById('m-calc').innerHTML    =
    `Formule : Rendement = Capital √ó Taux\n`+
    `Exemple avec le minimum :\n`+
    `${fmt(f.min)} FCFA √ó ${f.taux}% = ${fmtF(interetsEx)}\n`+
    `Rendement total = ${fmt(f.min)} + ${fmt(interetsEx)} = ${fmtF(totalEx)}`;

  document.getElementById('m-montant').value = '';
  document.getElementById('m-solde').textContent = fmtF(solde);
  document.getElementById('m-solde').className   = 'sr-val '+(peutPayer?'ok':'nok');
  document.getElementById('m-solde-ico').textContent = peutPayer?'‚úÖ':'‚ùå';
  document.getElementById('rp').style.display = 'none';

  const btn = document.getElementById('buy-btn');
  btn.textContent = peutPayer ? 'üå± Investir maintenant' : '‚ùå Solde insuffisant ‚Äî Recharger';
  btn.className   = 'buy-btn '+(peutPayer?'g':'r');
  btn.disabled    = false;

  document.getElementById('overlay').classList.add('open');
  // scroll modal to top
  document.getElementById('modal').scrollTop = 0;
}

// ‚îÄ‚îÄ RENDEMENT LIVE ‚îÄ‚îÄ
function updateRendement(){
  if(!fondActif) return;
  const f = fondActif;
  const montant = parseFloat(document.getElementById('m-montant').value)||0;
  const solde   = profile?.solde || 0;

  if(montant > 0){
    const inter = montant * f.taux / 100;
    const total = montant + inter;
    document.getElementById('rp-interets').textContent = fmtF(inter);
    document.getElementById('rp-total').textContent    = fmtF(total);
    document.getElementById('rp').style.display = 'flex';
    document.getElementById('rp').style.flexDirection = 'column';
  } else {
    document.getElementById('rp').style.display = 'none';
  }

  const requis = Math.max(montant, f.min);
  const ok = solde >= requis;
  document.getElementById('m-solde').className = 'sr-val '+(ok?'ok':'nok');
  document.getElementById('m-solde-ico').textContent = ok?'‚úÖ':'‚ùå';

  const btn = document.getElementById('buy-btn');
  btn.textContent = ok ? 'üå± Investir maintenant' : '‚ùå Solde insuffisant ‚Äî Recharger';
  btn.className   = 'buy-btn '+(ok?'g':'r');
}

function closeModal(){ document.getElementById('overlay').classList.remove('open'); fondActif=null; }
function closeOutside(e){ if(e.target===document.getElementById('overlay')) closeModal(); }

// ‚îÄ‚îÄ ACHETER ‚îÄ‚îÄ
async function acheter(){
  if(!fondActif) return;
  const f      = fondActif;
  const solde  = profile?.solde || 0;
  const montant = parseFloat(document.getElementById('m-montant').value) || f.min;

  if(solde < f.min){ closeModal(); window.location.href='recharge.html'; return; }
  if(montant < f.min){ showToast(`‚ö†Ô∏è Minimum requis : ${fmtF(f.min)}`); return; }
  if(montant > solde){ showToast('‚ùå Solde insuffisant pour ce montant'); return; }

  const btn = document.getElementById('buy-btn');
  btn.textContent='‚è≥ Traitement...'; btn.disabled=true;

  try{
    const interets    = montant * f.taux / 100;
    const totalRetour = montant + interets;
    const dateEch     = new Date(Date.now() + f.jours*86400000).toISOString();
    const nvSolde     = solde - montant;
    const nvInvest    = (profile?.investissement||0) + montant;
    const nvAttendu   = (profile?.revenu_attendu||0) + totalRetour;

    // D√©biter profil
    await SB.from('profiles').update({
      solde: nvSolde, investissement: nvInvest, revenu_attendu: nvAttendu
    }).eq('id', user.id);

    // Transaction
    await SB.from('transactions').insert({
      user_id:user.id, type:'recharge', montant, statut:'confirme',
      note:`${f.nom} ‚Äî ${f.taux}% / ${f.jours}j ‚Äî √©ch√©ance ${dateEch.slice(0,10)}`,
      reference: f.nom
    });

    // Fond investissement
    await SB.from('fonds_investissements').insert({
      user_id:user.id, fond_nom:f.nom, fond_id:f.id,
      montant, taux:f.taux, jours:f.jours,
      interets, total_retour:totalRetour,
      date_echeance:dateEch, statut:'actif'
    });

    profile.solde = nvSolde; profile.investissement = nvInvest; profile.revenu_attendu = nvAttendu;
    document.getElementById('total-fonds').textContent   = fmtF(nvInvest);
    document.getElementById('total-attendu').textContent = fmtF(nvAttendu);

    closeModal();
    showToast(`üéâ ${fmtF(montant)} investis dans ${f.nom} ! Retour dans ${f.jours} jours.`);

  }catch(e){
    console.error(e);
    showToast('‚ùå Erreur : '+(e.message||'R√©essayez'));
    btn.textContent='üå± Investir maintenant'; btn.disabled=false;
  }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function init(){
  const{data:{session}}=await SB.auth.getSession();
  const u=session?.user;
  if(!u){ window.location.href='index.html'; return; }
  user = u;

  const { data:p } = await SB.from('profiles')
    .select('solde,investissement,revenu_attendu')
    .eq('id', u.id).single();

  profile = p || { solde:0, investissement:0, revenu_attendu:0 };

  // Solde topbar
  const soldeEl=document.getElementById('tb-solde');
  if(soldeEl) soldeEl.textContent=fmtF(profile.solde);

  document.getElementById('total-fonds').textContent   = fmtF(profile.investissement||0);
  document.getElementById('total-attendu').textContent = fmtF(profile.revenu_attendu||0);

  renderFunds();
}
init();
</script>
</body>
</html>
