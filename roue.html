<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>VGN ‚Äì Roue de Chance</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--g:#16A34A;--gd:#15803D;--o:#F97316;--od:#EA580C;--bg:#0A0A0F;--card:#13131A;--bd:#2A2A3A;--txt:#F0F0FF;--mu:#888;--H:56px;--B:58px;--sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px)}
html{font-family:'Nunito',sans-serif;background:var(--bg)}
body{max-width:430px;margin:0 auto;background:var(--bg);overflow-x:hidden}
.topbar{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:calc(var(--H) + var(--sat));background:linear-gradient(135deg,#0f0f1a,#1a1a2e);display:flex;align-items:center;justify-content:space-between;padding:var(--sat) 14px 0;z-index:999;border-bottom:1px solid #1f1f2e}
.tbk{width:34px;height:34px;border-radius:50%;background:rgba(249,115,22,.15);border:1px solid rgba(249,115,22,.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;text-decoration:none;color:#fff;font-weight:900;line-height:1}
.tbt{font-size:1rem;font-weight:900;color:#fff}
.tbsolde{font-size:.66rem;font-weight:800;color:#fff;background:rgba(249,115,22,.2);padding:4px 10px;border-radius:16px;border:1px solid rgba(249,115,22,.35)}
.scroll{padding-top:calc(var(--H) + var(--sat) + 14px);padding-bottom:calc(var(--B) + var(--sab) + 28px);min-height:100svh;min-height:100vh}
.botnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:calc(var(--B) + var(--sab));padding-bottom:var(--sab);background:#0f0f1a;border-top:1px solid var(--bd);display:flex;align-items:center;z-index:999}
.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none}
.bni{font-size:1.2rem}.bnl{font-size:.57rem;font-weight:800;color:var(--mu)}

/* LOCK */
/* BANDEAU LOCK */
.lock-banner{background:linear-gradient(135deg,#1e1040,#2d1060);border-radius:14px;padding:13px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid rgba(139,92,246,.4);box-shadow:0 0 20px rgba(139,92,246,.1)}
.lb-left{flex:1}
.lb-title{font-size:.78rem;font-weight:900;color:#c4b5fd;margin-bottom:3px}
.lb-sub{font-size:.67rem;color:#a78bfa;line-height:1.4}
.lb-btn{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;padding:9px 14px;border-radius:10px;font-size:.75rem;font-weight:900;text-decoration:none;white-space:nowrap;flex-shrink:0;box-shadow:0 3px 12px rgba(109,40,217,.4)}
.spin-msg{text-align:center;margin:0 12px 10px;padding:11px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:12px;font-size:.76rem;font-weight:800;color:#f87171}

/* STATS */
.stats-strip{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:0 12px 14px}
.scard{background:var(--card);border-radius:14px;padding:12px 10px;text-align:center;border:1px solid var(--bd)}
.scard-v{font-size:.98rem;font-weight:900;color:var(--o)}
.scard-l{font-size:.59rem;color:var(--mu);font-weight:700;margin-top:3px}

/* INFO GAINS */
.gains-info{margin:0 12px 14px;background:linear-gradient(135deg,#0d2818,#0a1f10);border-radius:16px;padding:13px 15px;border:1px solid rgba(22,163,74,.3)}
.gi-title{font-size:.73rem;font-weight:800;color:#4ade80;margin-bottom:9px}
.gi-row{display:flex;justify-content:space-between;margin-bottom:5px}
.gi-row:last-child{margin-bottom:0}
.gi-lbl{font-size:.68rem;color:#6b7280;font-weight:700}
.gi-val{font-size:.75rem;font-weight:900;color:#fff}

/* ROUE */
.roue-zone{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;position:relative}
.wheel-outer{position:relative;width:290px;height:290px}
.wheel-outer::before{content:'';position:absolute;inset:-12px;border-radius:50%;background:conic-gradient(from 0deg,#F97316,#EAB308,#22C55E,#3B82F6,#8B5CF6,#EF4444,#F97316);animation:halo 8s linear infinite;filter:blur(10px);opacity:.45}
@keyframes halo{to{transform:rotate(360deg)}}
canvas#roue{position:relative;z-index:2;border-radius:50%;display:block;box-shadow:0 0 0 4px #1a1a2e,0 0 40px rgba(249,115,22,.35)}
.needle{position:absolute;top:-2px;left:50%;transform:translateX(-50%);z-index:10;width:0;height:0;border-left:11px solid transparent;border-right:11px solid transparent;border-top:36px solid #F97316;filter:drop-shadow(0 0 8px rgba(249,115,22,.9))}

.spin-btn{display:block;margin:0 auto 14px;padding:15px 44px;background:linear-gradient(135deg,var(--o),var(--od));border:none;border-radius:50px;font-family:'Nunito',sans-serif;font-size:1.05rem;font-weight:900;color:#fff;cursor:pointer;box-shadow:0 4px 24px rgba(249,115,22,.55);transition:transform .15s}
.spin-btn:active{transform:scale(.95)}.spin-btn:disabled{opacity:.4;cursor:not-allowed;box-shadow:none;transform:none}

/* R√âSULTAT */
.result-card{margin:0 12px 14px;background:var(--card);border-radius:18px;padding:18px;text-align:center;border:1px solid var(--bd);display:none}
.result-card.show{display:block;animation:pop .45s cubic-bezier(.34,1.56,.64,1)}
@keyframes pop{from{transform:scale(.75);opacity:0}to{transform:scale(1);opacity:1}}
.r-ico{font-size:3rem;margin-bottom:8px}
.r-label{font-size:.72rem;color:var(--mu);font-weight:700;margin-bottom:4px}
.r-val{font-size:2rem;font-weight:900;color:var(--o)}
.r-mult{font-size:.75rem;color:var(--mu);margin-top:5px}

/* HISTORIQUE */
.sec-h{padding:0 14px;margin-bottom:8px;font-size:.85rem;font-weight:900;color:var(--txt)}
.hist-list{padding:0 12px;display:flex;flex-direction:column;gap:7px;margin-bottom:14px}
.hitem{background:var(--card);border-radius:13px;padding:11px 14px;display:flex;align-items:center;justify-content:space-between;border:1px solid var(--bd)}
.hi-l div:first-child{font-size:.73rem;font-weight:800;color:var(--txt)}
.hi-l div:last-child{font-size:.62rem;color:var(--mu);margin-top:2px}
.hi-r{font-size:.88rem;font-weight:900;color:var(--o)}
.vide{text-align:center;padding:24px;color:var(--mu);font-size:.76rem;font-weight:700}
.tst{position:fixed;top:calc(var(--H) + var(--sat) + 8px);left:50%;transform:translateX(-50%) translateY(-80px);background:#111;color:#fff;padding:9px 22px;border-radius:22px;font-size:.77rem;font-weight:700;z-index:99999;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.tst.show{transform:translateX(-50%) translateY(0)}.tst.err{background:#DC2626}.tst.ok{background:#16A34A}
.ld{display:inline-block;width:10px;height:10px;border:2px solid #333;border-top-color:var(--o);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="topbar">
  <a class="tbk" href="dashboard.html">‚Äπ</a>
  <span class="tbt">üé° Roue de Chance</span>
  <div class="tbsolde">üí∞ <span id="tb-solde">‚Äî</span></div>
</div>
<div class="tst" id="tst"></div>
<div class="scroll">

  <!-- STATS toujours visibles -->
  <div class="stats-strip">
    <div class="scard"><div class="scard-v" id="ic-vip">‚Äî</div><div class="scard-l">Niveau VIP</div></div>
    <div class="scard"><div class="scard-v" id="ic-inv">‚Äî</div><div class="scard-l">Investissement</div></div>
    <div class="scard"><div class="scard-v" id="ic-max">‚Äî</div><div class="scard-l">Gain max</div></div>
  </div>

  <!-- BANDEAU LOCK (affich√© si VIP < 2) -->
  <div id="vip-lock" style="display:none;margin:0 12px 12px">
    <div class="lock-banner">
      <div class="lb-left">
        <div class="lb-title">üîí VIP 1 actif ‚Äî D√©bloquez la roue</div>
        <div class="lb-sub">Passez au <b>VIP 2</b> pour pouvoir lancer la roue et gagner selon votre investissement</div>
      </div>
      <a href="vip.html" class="lb-btn">VIP 2 ‚Üí</a>
    </div>
  </div>

  <!-- INFO GAINS -->
  <div class="gains-info" id="gains-info" style="display:none">
    <div class="gi-title">üìä Gains calcul√©s sur votre investissement</div>
    <div class="gi-row"><span class="gi-lbl">Base (1% de l'investissement)</span><span class="gi-val" id="gi-base">‚Äî</span></div>
    <div class="gi-row"><span class="gi-lbl">Multiplicateur min / max</span><span class="gi-val" id="gi-range">√ó0.5 / √ó3</span></div>
    <div class="gi-row"><span class="gi-lbl">Gain potentiel maximum</span><span class="gi-val" id="gi-max">‚Äî</span></div>
  </div>

  <!-- ROUE ‚Äî toujours affich√©e -->
  <div class="roue-zone">
    <div class="wheel-outer">
      <div class="needle"></div>
      <canvas id="roue" width="280" height="280"></canvas>
    </div>
  </div>

  <!-- BOUTON + √©tat -->
  <button class="spin-btn" id="spin-btn" onclick="lancer()">üé° Lancer la roue</button>
  <div class="spin-msg" id="spin-msg" style="display:none"></div>

  <!-- R√âSULTAT -->
  <div class="result-card" id="result-card">
    <div class="r-ico" id="r-ico">üéâ</div>
    <div class="r-label">Vous avez gagn√©</div>
    <div class="r-val" id="r-val">‚Äî</div>
    <div class="r-mult" id="r-mult"></div>
  </div>

  <!-- HISTORIQUE -->
  <div class="sec-h">Mes derniers tours</div>
  <div class="hist-list" id="hist-list"><div class="vide"><span class="ld"></span></div></div>

</div>
<nav class="botnav">
  <a class="bn" href="dashboard.html"><span class="bni">üè†</span><span class="bnl">Accueil</span></a>
  <a class="bn" href="taches.html"><span class="bni">‚úÖ</span><span class="bnl">T√¢ches</span></a>
  <a class="bn" href="rapport.html"><span class="bni">üìä</span><span class="bnl">Rapports</span></a>
  <a class="bn" href="profil.html"><span class="bni">üë§</span><span class="bnl">Mon Compte</span></a>
</nav>

<script>
const SB=supabase.createClient('https://tgrfzybemuwvhkbpuzmz.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE',{auth:{persistSession:true,storageKey:'vgn-auth',storage:window.localStorage}});
const fmt=n=>Number(n||0).toLocaleString('fr-FR');
const fmtF=n=>fmt(n)+' FCFA';
const $=id=>document.getElementById(id);
const $s=(id,v)=>{const e=$(id);if(e)e.textContent=v};
const toast=(m,t='')=>{const el=$('tst');el.textContent=m;el.className='tst show'+(t?' '+t:'');setTimeout(()=>el.className='tst',3500)};
let U=null,P=null,SEGS=[],spinning=false,angle=0;

function buildSegments(inv,vipNum){
  const base=Math.max(Math.round((inv||0)*0.01),200);
  const maxM=vipNum>=5?5:vipNum>=4?4:vipNum>=3?3.5:3;
  return [
    {label:'√ó0.5',mult:.5,color:'#EF4444'},
    {label:'√ó1',mult:1,color:'#F97316'},
    {label:'√ó1.5',mult:1.5,color:'#EAB308'},
    {label:'√ó2',mult:2,color:'#22C55E'},
    {label:'√ó0.5',mult:.5,color:'#EF4444'},
    {label:'√ó1',mult:1,color:'#3B82F6'},
    {label:'√ó'+maxM,mult:maxM,color:'#8B5CF6'},
    {label:'√ó1',mult:1,color:'#F97316'},
  ].map(s=>({...s,gain:Math.round(base*s.mult)}));
}

function drawWheel(segs,rot=0){
  const cv=$('roue'),ctx=cv.getContext('2d');
  const cx=140,cy=140,r=132,n=segs.length,arc=(2*Math.PI)/n;
  ctx.clearRect(0,0,280,280);
  segs.forEach((s,i)=>{
    const a0=rot+i*arc,a1=a0+arc;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,a0,a1);ctx.closePath();
    ctx.fillStyle=s.color;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=2;ctx.stroke();
    ctx.save();ctx.translate(cx,cy);ctx.rotate(a0+arc/2);ctx.textAlign='right';
    ctx.fillStyle='#fff';ctx.font='bold 12px Nunito,sans-serif';
    ctx.fillText(fmt(s.gain)+' F',r-8,4);
    ctx.font='bold 10px Nunito,sans-serif';ctx.fillStyle='rgba(255,255,255,.7)';
    ctx.fillText(s.label,r-8,16);ctx.restore();
  });
  ctx.beginPath();ctx.arc(cx,cy,24,0,2*Math.PI);
  ctx.fillStyle='#0A0A0F';ctx.fill();
  ctx.strokeStyle='rgba(249,115,22,.7)';ctx.lineWidth=3;ctx.stroke();
  ctx.fillStyle='#fff';ctx.font='bold 13px Nunito,sans-serif';
  ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('VGN',cx,cy);
}

function lancer(){
  if(spinning||!P)return;
  const vipN=parseInt((P.vip_niveau||'VIP 0').replace('VIP ',''))||0;
  if(vipN<2){toast('üîí Passez au VIP 2 pour jouer !','err');return}
  const today=new Date().toISOString().slice(0,10);
  if(localStorage.getItem('vgn-spin-'+U.id)===today){toast('‚è≥ 1 tour/jour ‚Äî revenez demain !','err');return}
  spinning=true;$('spin-btn').disabled=true;$('result-card').classList.remove('show');
  const n=SEGS.length,arc=(2*Math.PI)/n,inv=P.investissement||0;
  // Tirage pond√©r√© : + d'investissement = + de chances sur les grands multiplicateurs
  const poids=SEGS.map(s=>{
    if(s.mult>=3)   return inv>=1000000?35:inv>=500000?22:inv>=100000?12:6;
    if(s.mult>=2)   return inv>=500000?28:inv>=100000?18:inv>=50000?12:8;
    if(s.mult>=1.5) return inv>=50000?20:15;
    if(s.mult>=1)   return 14;
    return 7; // √ó0.5
  });
  const tot=poids.reduce((a,b)=>a+b,0);
  let r=Math.random()*tot,w=0;
  for(let i=0;i<poids.length;i++){r-=poids[i];if(r<=0){w=i;break}}
  const segCenter=w*arc+arc/2;
  const endAngle=angle-(segCenter+Math.PI/2-angle%(2*Math.PI))+Math.PI*2*8;
  const t0=performance.now(),startA=angle;
  function step(now){
    const p=Math.min((now-t0)/4500,1),ease=1-Math.pow(1-p,4);
    angle=startA+(endAngle-startA)*ease;
    drawWheel(SEGS,angle);
    if(p<1)requestAnimationFrame(step);
    else{angle=angle%(2*Math.PI);crediter(SEGS[w]);}
  }
  requestAnimationFrame(step);
}

async function crediter(seg){
  try{
    const today=new Date().toISOString().slice(0,10);
    const{error:e1}=await SB.from('roue_historique').insert({user_id:U.id,gain:seg.gain,multiplicateur:seg.mult,investissement_base:Math.round((P.investissement||0)*0.01),date_tour:today,created_at:new Date().toISOString()});
    if(e1)throw new Error(e1.message);
    const ns=(P.solde||0)+seg.gain,ng=(P.gains_totaux||0)+seg.gain;
    const{error:e2}=await SB.from('profiles').update({solde:ns,gains_totaux:ng}).eq('id',U.id);
    if(e2)throw new Error(e2.message);
    P.solde=ns;P.gains_totaux=ng;
    localStorage.setItem('vgn-spin-'+U.id,today);
    const icos={0.5:'üò¨',1:'üòä',1.5:'üòÑ',2:'ü§©',3:'üéä',3.5:'üéä',4:'üí•',5:'üèÜ'};
    $s('r-ico',icos[seg.mult]||'üéâ');$s('r-val',fmtF(seg.gain));
    $s('r-mult',seg.label+' ‚Äî Solde mis √† jour !');
    $('result-card').classList.add('show');$s('tb-solde',fmtF(ns));
    seg.mult<1?toast('üò¨ Pas de chance‚Ä¶ r√©essayez demain !'):toast('üéâ +'+fmtF(seg.gain)+' FCFA !','ok');
    chargerHistorique();
  }catch(err){toast('‚ùå '+err.message,'err')}
  finally{spinning=false;$('spin-btn').textContent='‚úÖ Tour utilis√© ‚Äî Revenez demain';$('spin-btn').disabled=true;}
}

async function chargerHistorique(){
  const{data:h}=await SB.from('roue_historique').select('*').eq('user_id',U.id).order('created_at',{ascending:false}).limit(10);
  const list=$('hist-list');
  if(!h||!h.length){list.innerHTML='<div class="vide">Aucun tour effectu√©</div>';return}
  list.innerHTML=h.map(r=>{
    const dt=new Date(r.created_at).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
    return `<div class="hitem"><div class="hi-l"><div>${dt} &nbsp;¬∑&nbsp; √ó${r.multiplicateur}</div><div>Base : ${fmtF(r.investissement_base)}</div></div><div class="hi-r">+${fmtF(r.gain)}</div></div>`;
  }).join('');
}

async function init(){
  const{data:{session}}=await SB.auth.getSession();
  if(!session){window.location.href='index.html';return}
  U=session.user;
  const{data:p}=await SB.from('profiles').select('*').eq('id',U.id).single();
  P=p||{solde:0,investissement:0,vip_niveau:'VIP 0'};
  $s('tb-solde',fmtF(P.solde));
  const vipNum=parseInt((P.vip_niveau||'VIP 0').replace('VIP ',''))||0;
  $s('lv-current',(vipNum>0?'‚úÖ ':'‚¨ú ')+(P.vip_niveau||'VIP 0'));
  if(vipNum>=1)$('lv-current').classList.replace('lock','ok');

  // Toujours construire et afficher la roue
  SEGS=buildSegments(P.investissement,vipNum);
  const base=Math.max(Math.round((P.investissement||0)*0.01),200);
  const maxG=Math.max(...SEGS.map(s=>s.gain));
  const maxM=vipNum>=5?5:vipNum>=4?4:vipNum>=3?3.5:3;

  $s('ic-vip',P.vip_niveau||'VIP 0');
  $s('ic-inv',fmt(Math.round(P.investissement||0))+' F');
  $s('ic-max',vipNum>=2?fmtF(maxG):'üîí');
  drawWheel(SEGS,0); // Toujours dessiner

  if(vipNum<2){
    // Afficher le bandeau lock, bloquer le bouton
    $('vip-lock').style.display='block';
    $('spin-btn').disabled=true;
    $('spin-btn').style.opacity='0.4';
    $('spin-btn').textContent='üîí VIP 2 requis pour jouer';
    $('gains-info').style.display='none';
    return;
  }

  // VIP 2+ : tout d√©bloquer
  $('vip-lock').style.display='none';
  $('gains-info').style.display='block';
  $s('gi-base',fmtF(base));
  $s('gi-range','√ó0.5 / √ó'+maxM);
  $s('gi-max',fmtF(maxG));

  const today=new Date().toISOString().slice(0,10);
  if(localStorage.getItem('vgn-spin-'+U.id)===today){
    $('spin-btn').textContent='‚úÖ Tour utilis√© ‚Äî Revenez demain';
    $('spin-btn').disabled=true;
  }
  await chargerHistorique();
}
init();
</script>
</body>
</html>
