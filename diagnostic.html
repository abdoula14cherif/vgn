<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VGN â€“ Diagnostic</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:monospace;background:#0f0f0f;color:#00ff00;padding:16px;font-size:13px}
h2{color:#fff;margin-bottom:12px;font-family:sans-serif}
.ok{color:#22c55e}.err{color:#ef4444}.warn{color:#f97316}.info{color:#60a5fa}
.line{padding:4px 0;border-bottom:1px solid #1a1a1a}
.big{font-size:16px;font-weight:bold;margin:8px 0}
button{margin-top:12px;padding:10px 20px;background:#16a34a;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;font-family:sans-serif}
button:active{background:#15803d}
#log{margin-top:12px}
</style>
</head>
<body>
<h2>ğŸ” VGN Diagnostic Supabase</h2>
<div id="log"><div class="info line">â³ DÃ©marrage du diagnostic...</div></div>
<button onclick="location.href='dashboard.html'">â† Retour Dashboard</button>

<script>
const SURL='https://tgrfzybemuwvhkbpuzmz.supabase.co';
const SKEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE';
const SB = supabase.createClient(SURL, SKEY);

const log = document.getElementById('log');
function L(msg, cls='info'){
  const d = document.createElement('div');
  d.className = cls+' line';
  d.textContent = msg;
  log.appendChild(d);
  console.log(msg);
}

async function run(){
  log.innerHTML = '';

  // 1. Auth
  L('â”â”â” 1. AUTHENTIFICATION â”â”â”');
  const {data:{user}, error:authErr} = await SB.auth.getUser();
  if(authErr){ L('âŒ Auth error: '+authErr.message, 'err'); return; }
  if(!user){ L('âŒ Pas connectÃ© â€” retour index', 'err'); setTimeout(()=>location.href='index.html',2000); return; }
  L('âœ… ConnectÃ© : '+user.email, 'ok');
  L('   user.id = '+user.id, 'info');
  L('   created_at = '+user.created_at, 'info');

  // 2. Lire le profil
  L('â”â”â” 2. LECTURE PROFIL â”â”â”');
  const {data:p, error:errP, status:stP} = await SB.from('profiles').select('*').eq('id',user.id).single();
  L('   HTTP status: '+stP, stP===200?'ok':'warn');
  if(errP){
    L('âŒ Erreur lecture: '+JSON.stringify(errP), 'err');
    L('   code='+errP.code+' | hint='+errP.hint, 'err');
  } else if(!p){
    L('âš ï¸ Profil null â€” ligne absente dans profiles', 'warn');
  } else {
    L('âœ… Profil trouvÃ© !', 'ok');
    L('   solde = '+p.solde, p.solde>0?'ok':'warn');
    L('   gains_totaux = '+p.gains_totaux, 'info');
    L('   gains_jour = '+p.gains_jour, 'info');
    L('   taches_jour = '+p.taches_jour, 'info');
    L('   vip_niveau = '+p.vip_niveau, 'info');
  }

  // 3. Si profil absent â†’ tenter upsert
  if(!p && !errP || (errP && errP.code==='PGRST116')){
    L('â”â”â” 3. CRÃ‰ATION PROFIL (absent) â”â”â”');
    const {data:np, error:errU} = await SB.from('profiles').upsert({
      id: user.id,
      email: user.email,
      full_name: user.user_metadata?.full_name || user.email.split('@')[0],
      solde:0, gains_totaux:0, gains_jour:0, gains_hier:0,
      gains_semaine:0, gains_mois:0, investissement:0,
      revenu_attendu:0, taches_jour:0, vip_niveau:'VIP 0',
      benefices_jour:0, rabais_commission:0, commission_parrainage:0,
    },{onConflict:'id'}).select().single();
    if(errU) L('âŒ Upsert Ã©chouÃ©: '+JSON.stringify(errU), 'err');
    else L('âœ… Profil crÃ©Ã©: solde='+np?.solde, 'ok');
  }

  // 4. Test UPDATE solde (+1 FCFA de test)
  L('â”â”â” 4. TEST UPDATE PROFIL â”â”â”');
  const soldeActuel = p?.solde || 0;
  const {error:errUpd, status:stUpd} = await SB.from('profiles')
    .update({ solde: soldeActuel }) // mÃªme valeur, juste pour tester
    .eq('id', user.id);
  L('   HTTP status: '+stUpd, stUpd===204?'ok':'err');
  if(errUpd) L('âŒ UPDATE bloquÃ©: '+JSON.stringify(errUpd), 'err');
  else L('âœ… UPDATE fonctionne !', 'ok');

  // 5. Lire taches_completees
  L('â”â”â” 5. TACHES COMPLETEES â”â”â”');
  const today = new Date().toISOString().slice(0,10);
  const {data:tc, error:errTc, status:stTc} = await SB.from('taches_completees')
    .select('*').eq('user_id',user.id).eq('date_jour',today);
  L('   HTTP status: '+stTc, stTc===200?'ok':'err');
  if(errTc) L('âŒ Erreur: '+JSON.stringify(errTc), 'err');
  else L('âœ… TÃ¢ches aujourd\'hui: '+(tc?.length||0), 'ok');

  // 6. Test INSERT taches_completees
  L('â”â”â” 6. TEST INSERT TACHE â”â”â”');
  const {error:errIns, status:stIns} = await SB.from('taches_completees').insert({
    user_id: user.id,
    tache_ref: 'TEST',
    type_tache: 'stage',
    reward: 0,
    date_jour: '2000-01-01', // date passÃ©e pour ne pas polluer
    completee_le: new Date().toISOString()
  });
  L('   HTTP status: '+stIns, stIns===201?'ok':'err');
  if(errIns) L('âŒ INSERT bloquÃ©: '+JSON.stringify(errIns), 'err');
  else L('âœ… INSERT fonctionne !', 'ok');

  // 7. Politiques actives (via count trick)
  L('â”â”â” 7. RÃ‰SUMÃ‰ â”â”â”');
  L(errP ? 'âŒ SELECT profiles : BLOQUÃ‰ ('+errP.code+')' : 'âœ… SELECT profiles : OK', errP?'err':'ok');
  L(errUpd ? 'âŒ UPDATE profiles : BLOQUÃ‰' : 'âœ… UPDATE profiles : OK', errUpd?'err':'ok');
  L(errTc ? 'âŒ SELECT taches : BLOQUÃ‰' : 'âœ… SELECT taches : OK', errTc?'err':'ok');
  L(errIns ? 'âŒ INSERT taches : BLOQUÃ‰ ('+errIns.code+')' : 'âœ… INSERT taches : OK', errIns?'err':'ok');
  L('â”â”â” FIN DIAGNOSTIC â”â”â”', 'info');
}

run();
</script>
</body>
</html>
