<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VGN ‚Äì T√¢ches</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--green:#16A34A;--gd:#15803D;--orange:#F97316;--od:#EA580C;--bg:#F1F5F1;--card:#fff;--txt:#111827;--muted:#6B7280;--bdr:#E5E7EB}
html,body{height:100%;font-family:'Nunito',sans-serif;background:var(--bg);max-width:430px;margin:0 auto;overflow-x:hidden}

#shell{display:flex;flex-direction:column;height:100%}
#topbar{flex:0 0 56px;background:linear-gradient(135deg,var(--gd),#22C55E);display:flex;align-items:center;justify-content:space-between;padding:0 14px;box-shadow:0 2px 10px rgba(0,0,0,.15);z-index:10}
#content{flex:1 1 auto;overflow-y:auto;-webkit-overflow-scrolling:touch}
#botnav{flex:0 0 58px;background:#fff;border-top:1px solid var(--bdr);display:flex;align-items:center;box-shadow:0 -2px 10px rgba(0,0,0,.07);z-index:10}

.tb-back{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:900;color:#fff;text-decoration:none;cursor:pointer}
.tb-title{font-size:1rem;font-weight:900;color:#fff}
.tb-right{width:34px}

.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none;position:relative;cursor:pointer}
.bn.on::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:26px;height:3px;background:var(--green);border-radius:0 0 3px 3px}
.bn-i{font-size:1.2rem}
.bn-l{font-size:.57rem;font-weight:800;color:var(--muted)}
.bn.on .bn-l{color:var(--green)}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;background:#fff;border-bottom:2px solid var(--bdr);position:sticky;top:0;z-index:5}
.tab{flex:1;text-align:center;padding:13px 0;font-size:.85rem;font-weight:800;color:var(--muted);cursor:pointer;position:relative;transition:color .2s}
.tab.on{color:var(--green)}
.tab.on::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:3px;background:var(--green);border-radius:2px}

/* ‚îÄ‚îÄ SUMMARY BANNER ‚îÄ‚îÄ */
.summary{margin:12px 12px 10px;background:linear-gradient(135deg,var(--gd),#22C55E);border-radius:16px;padding:13px 16px;box-shadow:0 4px 14px rgba(22,163,74,.22)}
.sum-row{display:flex;justify-content:space-around;align-items:center}
.sum-item{text-align:center}
.sum-lbl{font-size:.62rem;color:rgba(255,255,255,.75);font-weight:700;margin-bottom:3px}
.sum-val{font-size:1.1rem;font-weight:900;color:#fff}
.sum-sep{width:1px;background:rgba(255,255,255,.25);height:36px}

/* ‚îÄ‚îÄ PROGRESS BAR JOURNALI√àRE ‚îÄ‚îÄ */
.day-prog{margin:0 12px 14px;background:#fff;border-radius:14px;padding:12px 14px;box-shadow:0 1px 7px rgba(0,0,0,.07)}
.dp-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.dp-title{font-size:.78rem;font-weight:800;color:var(--txt)}
.dp-count{font-size:.75rem;font-weight:900;color:var(--green)}
.dp-bar{background:#E5E7EB;border-radius:6px;height:8px;overflow:hidden}
.dp-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--green),#22C55E);transition:width .5s ease}
.dp-msg{font-size:.65rem;color:var(--muted);font-weight:700;margin-top:6px;text-align:center}

/* ‚îÄ‚îÄ TACHE ITEM (liste) ‚îÄ‚îÄ */
.tache-list{padding:0 12px;display:flex;flex-direction:column;gap:10px;padding-bottom:16px}

.titem{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07);display:flex;align-items:stretch;position:relative}
.titem.encours{border-left:4px solid var(--orange)}
.titem.termine{border-left:4px solid var(--green)}

.ti-img{width:80px;flex-shrink:0;object-fit:cover;display:block}
.ti-body{flex:1;padding:10px 12px}
.ti-name{font-size:.78rem;font-weight:800;color:var(--txt);margin-bottom:4px}
.ti-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.ti-badge{font-size:.6rem;font-weight:800;padding:2px 8px;border-radius:6px;color:#fff}
.badge-encours{background:var(--orange)}
.badge-fait{background:var(--green)}
.ti-reward{font-size:.78rem;font-weight:900;color:var(--green);margin-top:4px}
.ti-time{font-size:.6rem;color:var(--muted);font-weight:700;margin-top:3px}
.ti-right{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 12px;gap:6px;flex-shrink:0}

/* bouton Faire la t√¢che */
.do-btn{background:linear-gradient(135deg,var(--orange),var(--od));border:none;border-radius:10px;padding:7px 10px;font-family:'Nunito',sans-serif;font-size:.65rem;font-weight:800;color:#fff;cursor:pointer;text-align:center;line-height:1.3;transition:transform .15s}
.do-btn:active{transform:scale(.93)}
.done-ico{font-size:1.6rem}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{text-align:center;padding:50px 20px}
.empty-ico{font-size:3.5rem;margin-bottom:12px}
.empty-txt{font-size:.85rem;font-weight:800;color:var(--txt);margin-bottom:6px}
.empty-sub{font-size:.75rem;color:var(--muted);line-height:1.5}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.tst{position:fixed;top:64px;left:50%;transform:translateX(-50%) translateY(-70px);background:#111;color:#fff;padding:8px 20px;border-radius:22px;font-size:.77rem;font-weight:700;z-index:200;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.2)}
.tst.show{transform:translateX(-50%) translateY(0)}
.tst.err{background:#DC2626}

/* ‚îÄ‚îÄ AD OVERLAY ‚îÄ‚îÄ */
.adov{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.adov.open{opacity:1;pointer-events:all}
.ad-box{background:#111;border-radius:20px;width:calc(100% - 32px);max-width:398px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.6)}
.ad-img{width:100%;height:190px;position:relative;background:#000;display:flex;align-items:center;justify-content:center}
.ad-img img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;opacity:.6}
.ad-play{position:relative;z-index:2;font-size:3rem}
.ad-bd{padding:13px 15px}
.ad-br{font-size:.67rem;font-weight:700;color:#888;margin-bottom:3px}
.ad-ti{font-size:.87rem;font-weight:900;color:#fff;margin-bottom:8px}
.ad-bw{background:#333;border-radius:4px;height:6px;overflow:hidden;margin-bottom:8px}
.ad-bar{height:100%;background:var(--orange);border-radius:4px;width:0%}
.ad-tm{font-size:.72rem;font-weight:800;color:#bbb;text-align:center;margin-bottom:10px}
.ad-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--green),var(--gd));border:none;border-radius:12px;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:900;color:#fff;cursor:pointer;display:none;transition:transform .15s;box-shadow:0 3px 12px rgba(22,163,74,.3)}
.ad-btn:active{transform:scale(.97)}
.ad-btn.show{display:block}

.ld{display:inline-block;width:10px;height:10px;border:2px solid #ccc;border-top-color:var(--green);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="shell">

  <div id="topbar">
    <a class="tb-back" href="dashboard.html">‚Äπ</a>
    <span class="tb-title">‚úÖ Mes T√¢ches</span>
    <div class="tb-right"></div>
  </div>

  <div id="content">

    <!-- TABS -->
    <div class="tabs">
      <div class="tab on" id="tab-ec" onclick="switchTab('encours')">En cours</div>
      <div class="tab" id="tab-tr" onclick="switchTab('termine')">Termin√©</div>
    </div>

    <!-- SUMMARY -->
    <div class="summary">
      <div class="sum-row">
        <div class="sum-item"><div class="sum-lbl">T√¢ches aujourd'hui</div><div class="sum-val" id="s-today">‚Äî</div></div>
        <div class="sum-sep"></div>
        <div class="sum-item"><div class="sum-lbl">Gains du jour</div><div class="sum-val" id="s-gains">‚Äî</div></div>
        <div class="sum-sep"></div>
        <div class="sum-item"><div class="sum-lbl">Jours de stage</div><div class="sum-val" id="s-stage">‚Äî</div></div>
      </div>
    </div>

    <!-- PROGRESS JOURNALI√àRE -->
    <div class="day-prog">
      <div class="dp-head">
        <span class="dp-title">üìä Progression journali√®re</span>
        <span class="dp-count" id="dp-count">0 / 3</span>
      </div>
      <div class="dp-bar"><div class="dp-fill" id="dp-fill" style="width:0%"></div></div>
      <div class="dp-msg" id="dp-msg">Aucune t√¢che compl√©t√©e aujourd'hui</div>
    </div>

    <!-- LISTE -->
    <div class="tache-list" id="tache-list">
      <div style="text-align:center;padding:30px"><span class="ld"></span></div>
    </div>

  </div>

  <nav id="botnav">
    <a class="bn" href="dashboard.html"><span class="bn-i">üè†</span><span class="bn-l">Accueil</span></a>
    <a class="bn on" href="taches.html"><span class="bn-i">‚úÖ</span><span class="bn-l">T√¢ches</span></a>
    <a class="bn" href="rapport.html"><span class="bn-i">üìä</span><span class="bn-l">Rapports</span></a>
    <a class="bn" href="profil.html"><span class="bn-i">üë§</span><span class="bn-l">Mon Compte</span></a>
  </nav>
</div>

<div class="tst" id="tst"></div>

<!-- AD -->
<div class="adov" id="adov">
  <div class="ad-box">
    <div class="ad-img"><img id="ad-img" src="" alt=""><div class="ad-play">‚ñ∂Ô∏è</div></div>
    <div class="ad-bd">
      <div class="ad-br">VGN Agriculture</div>
      <div class="ad-ti" id="ad-ti">T√¢che en cours</div>
      <div class="ad-bw"><div class="ad-bar" id="ad-bar"></div></div>
      <div class="ad-tm" id="ad-tm">Patientez <b>15</b> secondes...</div>
      <button class="ad-btn" id="ad-btn" onclick="finishAd()">‚úÖ R√©clamer +70 FCFA</button>
    </div>
  </div>
</div>

<script>
const SB=supabase.createClient('https://tgrfzybemuwvhkbpuzmz.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE');

const MAX=3,GAIN=70,DAYS=4,SECS=15;
const TACHES_DATA={
  ag1:{nom:'Champs de Ma√Øs VGN',img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=200&q=80'},
  ag2:{nom:'Bl√© Dor√© Premium',img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=200&q=80'},
  ag3:{nom:'√âlevage Bovin VGN',img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=200&q=80'},
  ag4:{nom:'Grande R√©colte 2025',img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=200&q=80'},
  ag5:{nom:'Ferme Bio Certifi√©e',img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=200&q=80'},
  ag6:{nom:'Irrigation Moderne',img:'https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=200&q=80'},
};

// T√¢ches disponibles qui n'ont PAS encore √©t√© faites aujourd'hui
const ALL_TACHES=[
  {id:'ag1',nom:'Champs de Ma√Øs VGN',img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400&q=80'},
  {id:'ag2',nom:'Bl√© Dor√© Premium',img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&q=80'},
  {id:'ag3',nom:'√âlevage Bovin VGN',img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=400&q=80'},
  {id:'ag4',nom:'Grande R√©colte 2025',img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&q=80'},
  {id:'ag5',nom:'Ferme Bio Certifi√©e',img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=400&q=80'},
  {id:'ag6',nom:'Irrigation Moderne',img:'https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=400&q=80'},
];

let authUser=null,profile=null,doneToday=[],allHistory=[],curTab='encours',curTask=null,adTimer=null,saving=false;
const fmt=n=>Number(n||0).toLocaleString('fr-FR');
const fmtF=n=>fmt(n)+' FCFA';
const today=()=>new Date().toISOString().slice(0,10);
function set(id,v){const e=document.getElementById(id);if(e)e.textContent=v}
function toast(m,err=false){const t=document.getElementById('tst');t.textContent=m;t.className='tst show'+(err?' err':'');setTimeout(()=>t.className='tst',3500)}
function timeAgo(iso){const d=new Date(iso),now=new Date();const diff=Math.floor((now-d)/60000);if(diff<1)return'√Ä l\'instant';if(diff<60)return diff+'min';if(diff<1440)return Math.floor(diff/60)+'h';return d.toLocaleDateString('fr-FR')}

function switchTab(tab){
  curTab=tab;
  document.getElementById('tab-ec').className='tab'+(tab==='encours'?' on':'');
  document.getElementById('tab-tr').className='tab'+(tab==='termine'?' on':'');
  render();
}

function updateSummary(){
  const doneCount=doneToday.length;
  const gainsJour=doneCount*GAIN;
  const ms=Date.now()-new Date(profile?.created_at||authUser?.created_at||Date.now()).getTime();
  const jourStage=Math.min(Math.floor(ms/86400000)+1,DAYS);
  set('s-today',doneCount+' / '+MAX);
  set('s-gains',fmtF(gainsJour));
  set('s-stage','Jour '+jourStage+' / '+DAYS);

  // barre progression
  const pct=Math.round(doneCount/MAX*100);
  document.getElementById('dp-fill').style.width=pct+'%';
  set('dp-count',doneCount+' / '+MAX);
  let msg='';
  if(doneCount===0)msg='Aucune t√¢che compl√©t√©e aujourd\'hui';
  else if(doneCount<MAX)msg=`Super ! ${MAX-doneCount} t√¢che${MAX-doneCount>1?'s':''} restante${MAX-doneCount>1?'s':''} pour aujourd'hui`;
  else msg='üéâ Objectif du jour atteint ! Revenez demain.';
  set('dp-msg',msg);
}

function render(){
  const list=document.getElementById('tache-list');
  list.innerHTML='';

  if(curTab==='encours'){
    // T√¢ches pas encore faites aujourd'hui ET dans la limite
    const restantes=ALL_TACHES.filter(t=>!doneToday.includes(t.id));
    const limiteAtteinte=doneToday.length>=MAX;

    if(limiteAtteinte){
      list.innerHTML=`<div class="empty"><div class="empty-ico">üåô</div><div class="empty-txt">Limite du jour atteinte !</div><div class="empty-sub">Vous avez compl√©t√© vos 3 t√¢ches aujourd'hui.<br>Revenez demain pour continuer.</div></div>`;
      return;
    }
    if(restantes.length===0){
      list.innerHTML=`<div class="empty"><div class="empty-ico">‚úÖ</div><div class="empty-txt">Toutes les t√¢ches faites !</div><div class="empty-sub">Revenez demain pour de nouvelles t√¢ches.</div></div>`;
      return;
    }

    restantes.forEach(t=>{
      const div=document.createElement('div');
      div.className='titem encours';
      div.innerHTML=`
        <img class="ti-img" src="${t.img}" alt="${t.nom}" loading="lazy">
        <div class="ti-body">
          <div class="ti-name">${t.nom}</div>
          <div class="ti-meta"><span class="ti-badge badge-encours">En cours</span><span class="ti-badge" style="background:#6B7280">Gratuit</span></div>
          <div class="ti-reward">+${GAIN} FCFA</div>
          <div class="ti-time">‚è± Regardez une pub de 15 sec</div>
        </div>
        <div class="ti-right">
          <button class="do-btn" onclick="startAd({id:'${t.id}',nom:'${t.nom}',img:'${t.img}'})">‚ñ∂Ô∏è Faire<br>la t√¢che</button>
        </div>`;
      list.appendChild(div);
    });

  } else {
    // Termin√© : tout l'historique de today
    if(doneToday.length===0){
      list.innerHTML=`<div class="empty"><div class="empty-ico">üìã</div><div class="empty-txt">Aucune t√¢che termin√©e</div><div class="empty-sub">Les t√¢ches que vous compl√©tez<br>appara√Ætront ici.</div></div>`;
      return;
    }

    // Afficher les t√¢ches faites aujourd'hui (depuis allHistory)
    const todayDone=allHistory.filter(r=>r.date_jour===today());
    todayDone.forEach(r=>{
      const td=TACHES_DATA[r.tache_ref]||{nom:r.tache_ref||'T√¢che',img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=200&q=80'};
      const div=document.createElement('div');
      div.className='titem termine';
      div.innerHTML=`
        <img class="ti-img" src="${td.img}" alt="${td.nom}" loading="lazy">
        <div class="ti-body">
          <div class="ti-name">${td.nom}</div>
          <div class="ti-meta"><span class="ti-badge badge-fait">‚úÖ Termin√©</span></div>
          <div class="ti-reward">+${r.reward||GAIN} FCFA cr√©dit√©s</div>
          <div class="ti-time">üïê ${timeAgo(r.completee_le)}</div>
        </div>
        <div class="ti-right"><div class="done-ico">‚úÖ</div></div>`;
      list.appendChild(div);
    });

    // Aussi les anciens jours si pr√©sents
    const anciens=allHistory.filter(r=>r.date_jour!==today());
    if(anciens.length>0){
      const sep=document.createElement('div');
      sep.style.cssText='grid-column:1/-1;padding:8px 0;font-size:.72rem;font-weight:800;color:var(--muted);text-align:center';
      sep.textContent='‚îÄ‚îÄ Jours pr√©c√©dents ‚îÄ‚îÄ';
      list.appendChild(sep);
      anciens.forEach(r=>{
        const td=TACHES_DATA[r.tache_ref]||{nom:'T√¢che de stage',img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=200&q=80'};
        const div=document.createElement('div');
        div.className='titem termine';
        div.style.opacity='.7';
        div.innerHTML=`
          <img class="ti-img" src="${td.img}" alt="${td.nom}" loading="lazy">
          <div class="ti-body">
            <div class="ti-name">${td.nom}</div>
            <div class="ti-meta"><span class="ti-badge badge-fait">‚úÖ Termin√©</span></div>
            <div class="ti-reward">+${r.reward||GAIN} FCFA</div>
            <div class="ti-time">üìÖ ${new Date(r.completee_le).toLocaleDateString('fr-FR')}</div>
          </div>
          <div class="ti-right"><div class="done-ico">‚úÖ</div></div>`;
        list.appendChild(div);
      });
    }
  }
}

// ‚îÄ‚îÄ AD ‚îÄ‚îÄ
function startAd(t){
  if(saving)return;
  curTask=t;
  document.getElementById('ad-img').src=t.img;
  document.getElementById('ad-ti').textContent=t.nom;
  const bar=document.getElementById('ad-bar');bar.style.transition='none';bar.style.width='0%';
  document.getElementById('ad-tm').innerHTML=`Patientez <b>${SECS}</b> secondes...`;
  document.getElementById('ad-btn').classList.remove('show');
  document.getElementById('adov').classList.add('open');
  let el=0;clearInterval(adTimer);
  adTimer=setInterval(()=>{el++;bar.style.transition='width 1s linear';bar.style.width=(el/SECS*100)+'%';const r=SECS-el;document.getElementById('ad-tm').innerHTML=r>0?`Patientez <b>${r}</b> sec...`:'üéâ Cliquez pour r√©clamer !';if(el>=SECS){clearInterval(adTimer);document.getElementById('ad-btn').classList.add('show')}},1000);
}

async function finishAd(){
  if(!curTask||!authUser||saving)return;
  if(doneToday.includes(curTask.id)){toast('‚ö†Ô∏è D√©j√† compl√©t√©e');return}
  if(doneToday.length>=MAX){toast('‚ö†Ô∏è Max 3 t√¢ches/jour');return}
  clearInterval(adTimer);saving=true;
  const btn=document.getElementById('ad-btn');btn.textContent='‚è≥ Enregistrement...';btn.disabled=true;
  const t=curTask;curTask=null;
  try{
    const dj=today();const now=new Date().toISOString();
    const{error:e1}=await SB.from('taches_completees').insert({user_id:authUser.id,tache_ref:t.id,type_tache:'stage',reward:GAIN,date_jour:dj,completee_le:now});
    if(e1)throw e1;
    const ns=(profile.solde||0)+GAIN,ng=(profile.gains_totaux||0)+GAIN,ngj=(profile.gains_jour||0)+GAIN,ngs=(profile.gains_semaine||0)+GAIN,ngm=(profile.gains_mois||0)+GAIN,nt=(profile.taches_jour||0)+1;
    const{error:e2}=await SB.from('profiles').update({solde:ns,gains_totaux:ng,gains_jour:ngj,gains_semaine:ngs,gains_mois:ngm,taches_jour:nt}).eq('id',authUser.id);
    if(e2)throw e2;
    profile.solde=ns;profile.gains_totaux=ng;profile.gains_jour=ngj;profile.gains_semaine=ngs;profile.gains_mois=ngm;profile.taches_jour=nt;
    doneToday.push(t.id);
    allHistory.unshift({tache_ref:t.id,reward:GAIN,date_jour:dj,completee_le:now});
    document.getElementById('adov').classList.remove('open');
    toast('üéâ +'+GAIN+' FCFA cr√©dit√©s !');
    updateSummary();render();
  }catch(err){
    console.error(err);
    document.getElementById('adov').classList.remove('open');
    toast('‚ùå '+(err.message||JSON.stringify(err)),true);
  }finally{saving=false;btn.textContent='‚úÖ R√©clamer +70 FCFA';btn.disabled=false}
}

async function init(){
  const{data:{user}}=await SB.auth.getUser();
  if(!user){window.location.href='index.html';return}
  authUser=user;
  const{data:p}=await SB.from('profiles').select('*').eq('id',user.id).single();
  profile=p||{solde:0,gains_totaux:0,gains_jour:0,investissement:0,taches_jour:0,created_at:user.created_at};
  // Charger TOUTES les t√¢ches compl√©t√©es (today + historique)
  const{data:tc}=await SB.from('taches_completees').select('*').eq('user_id',user.id).eq('type_tache','stage').order('completee_le',{ascending:false});
  allHistory=tc||[];
  doneToday=allHistory.filter(r=>r.date_jour===today()).map(r=>r.tache_ref).filter(Boolean).slice(0,MAX);
  updateSummary();render();
}
init();
</script>
</body>
</html>
