<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>VGN ‚Äì T√¢ches</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --g:#16A34A;--gd:#15803D;--gl:#22C55E;
  --o:#F97316;--od:#EA580C;
  --bg:#F0F4F0;--card:#fff;--txt:#111827;--mu:#6B7280;--bd:#E5E7EB;
  --H:56px;--B:58px;
  --sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px)
}
html{font-family:'Nunito',sans-serif;background:var(--bg)}
body{max-width:430px;margin:0 auto;background:var(--bg);overflow-x:hidden}

/* TOPBAR */
.topbar{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;
  height:calc(var(--H) + var(--sat));background:linear-gradient(135deg,var(--gd),var(--gl));
  display:flex;align-items:center;justify-content:space-between;padding:var(--sat) 14px 0;
  z-index:999;box-shadow:0 2px 12px rgba(0,0,0,.18)}
.tbk{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.2);
  border:1px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;
  font-size:1.3rem;font-weight:900;color:#fff;text-decoration:none}
.tbt{font-size:1rem;font-weight:900;color:#fff}
.tb-pill{font-size:.67rem;font-weight:800;color:#fff;background:rgba(255,255,255,.18);
  padding:4px 10px;border-radius:16px;border:1px solid rgba(255,255,255,.28)}

/* SCROLL */
.scroll{padding-top:calc(var(--H) + var(--sat));padding-bottom:calc(var(--B) + var(--sab) + 24px);min-height:100svh}

/* TABS */
.tabs{position:sticky;top:calc(var(--H) + var(--sat));z-index:50;background:#fff;
  display:flex;border-bottom:2px solid var(--bd)}
.tab{flex:1;text-align:center;padding:12px 0;font-size:.82rem;font-weight:800;
  color:var(--mu);cursor:pointer;position:relative;transition:color .2s}
.tab.on{color:var(--g)}
.tab.on::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:3px;background:var(--g);border-radius:2px}

/* BOTNAV */
.botnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;
  height:calc(var(--B) + var(--sab));padding-bottom:var(--sab);background:#fff;
  border-top:1px solid var(--bd);display:flex;align-items:center;z-index:999;
  box-shadow:0 -2px 10px rgba(0,0,0,.07)}
.bn{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;padding:6px 0;text-decoration:none;position:relative}
.bn.on::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:26px;height:3px;background:var(--g);border-radius:0 0 3px 3px}
.bni{font-size:1.2rem}.bnl{font-size:.57rem;font-weight:800;color:var(--mu)}
.bn.on .bnl{color:var(--g)}

/* PLAN BANNER VIP */
.plan-banner{margin:10px 12px 8px;border-radius:16px;padding:13px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 3px 14px rgba(0,0,0,.1)}
.pb0{background:linear-gradient(135deg,var(--gd),var(--gl))}
.pb1{background:linear-gradient(135deg,#1D4ED8,#60A5FA)}
.pb2{background:linear-gradient(135deg,#6D28D9,#A78BFA)}
.pb3{background:linear-gradient(135deg,#C2410C,#FB923C)}
.pb4{background:linear-gradient(135deg,#991B1B,#F87171)}
.pb5{background:linear-gradient(135deg,#0F766E,#34D399)}
.pb6{background:linear-gradient(135deg,#A16207,#FCD34D)}
.pb7{background:linear-gradient(135deg,#3730A3,#818CF8)}
.pb8{background:linear-gradient(135deg,#0369A1,#38BDF8)}
.pb9{background:linear-gradient(135deg,#14532D,#4ADE80)}
.pb-ico{font-size:2rem;flex-shrink:0}
.pb-info{flex:1}
.pb-titre{font-size:.86rem;font-weight:900;color:#fff}
.pb-sub{font-size:.63rem;color:rgba(255,255,255,.78);margin-top:2px}
.pb-right{text-align:right}
.pb-gain{font-size:1.15rem;font-weight:900;color:#fff}
.pb-gainl{font-size:.57rem;color:rgba(255,255,255,.68)}

/* SUMMARY */
.summary{margin:0 12px 10px;background:linear-gradient(135deg,var(--gd),var(--gl));border-radius:14px;padding:12px 16px;box-shadow:0 3px 12px rgba(22,163,74,.2)}
.sum-row{display:flex;justify-content:space-around;align-items:center}
.sum-item{text-align:center}
.sum-lbl{font-size:.59rem;color:rgba(255,255,255,.75);font-weight:700;margin-bottom:3px}
.sum-val{font-size:1.05rem;font-weight:900;color:#fff}
.sum-sep{width:1px;background:rgba(255,255,255,.25);height:32px}

/* PROGRESS */
.dayp{margin:0 12px 10px;background:#fff;border-radius:14px;padding:11px 14px;box-shadow:0 1px 7px rgba(0,0,0,.07)}
.dp-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.dp-t{font-size:.76rem;font-weight:800;color:var(--txt)}
.dp-c{font-size:.74rem;font-weight:900;color:var(--g)}
.dp-b{background:#E5E7EB;border-radius:6px;height:9px;overflow:hidden}
.dp-f{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--g),var(--gl));transition:width .6s ease}
.dp-m{font-size:.63rem;color:var(--mu);font-weight:700;margin-top:6px;text-align:center}

/* LOCKED STAGE */
.locked-box{margin:0 12px 10px;background:#FFF7ED;border:1.5px solid #FED7AA;border-radius:14px;padding:13px 14px;display:flex;align-items:flex-start;gap:10px}
.lk-ico{font-size:1.4rem;flex-shrink:0}
.lk-txt{font-size:.7rem;font-weight:700;color:#92400E;line-height:1.55}
.lk-btn{display:inline-block;margin-top:7px;font-size:.72rem;font-weight:900;color:#fff;background:var(--o);padding:6px 16px;border-radius:10px;text-decoration:none;box-shadow:0 2px 8px rgba(249,115,22,.3)}

/* SECTION HEADER cat√©gorie */
.sec-hd{display:flex;align-items:center;gap:8px;margin:12px 12px 7px}
.sec-hd-ico{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.95rem;flex-shrink:0}
.sec-hd-lbl{font-size:.75rem;font-weight:900;color:var(--txt)}
.sec-hd-ct{font-size:.6rem;font-weight:800;padding:2px 9px;border-radius:20px;margin-left:auto;color:#fff}

/* TACHE LIST */
.tlist{padding:0 12px;display:flex;flex-direction:column;gap:9px;padding-bottom:16px}

/* TACHE CARD */
.titem{background:#fff;border-radius:16px;overflow:hidden;
  box-shadow:0 2px 10px rgba(0,0,0,.07);display:flex;align-items:stretch;
  border-left:5px solid #E5E7EB;transition:transform .15s}
.titem:active{transform:scale(.985)}
/* couleurs bordure gauche par cat√©gorie */
.cc-agri{border-left-color:#16A34A}
.cc-elev{border-left-color:#D97706}
.cc-aqua{border-left-color:#0284C7}
.cc-mara{border-left-color:#7C3AED}
.cc-apic{border-left-color:#F59E0B}
.cc-arbo{border-left-color:#15803D}
.cc-agro{border-left-color:#0F766E}
.cc-poul{border-left-color:#DC2626}
.cc-lait{border-left-color:#6366F1}
.cc-serr{border-left-color:#DB2777}
.titem.fin{border-left-color:var(--g);opacity:.88}

.tiimg{width:82px;min-height:90px;object-fit:cover;display:block;flex-shrink:0;background:#f3f4f6}
.tibody{flex:1;padding:10px 11px}
.tiname{font-size:.77rem;font-weight:800;color:var(--txt);margin-bottom:4px;line-height:1.3}
.timeta{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:2px}
.badge{font-size:.58rem;font-weight:800;padding:2px 8px;border-radius:6px;color:#fff}
.bg-agri{background:#16A34A}.bg-elev{background:#D97706}.bg-aqua{background:#0284C7}
.bg-mara{background:#7C3AED}.bg-apic{background:#F59E0B}.bg-arbo{background:#15803D}
.bg-agro{background:#0F766E}.bg-poul{background:#DC2626}.bg-lait{background:#6366F1}
.bg-serr{background:#DB2777}.bg-ok{background:#16A34A}.bg-mu{background:#6B7280}
.tirew{font-size:.8rem;font-weight:900;color:var(--g)}
.titime{font-size:.59rem;color:var(--mu);font-weight:700;margin-top:2px}
.tiright{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 11px;gap:5px;flex-shrink:0}
.dobtn{background:linear-gradient(135deg,var(--o),var(--od));border:none;border-radius:10px;
  padding:8px 9px;font-family:'Nunito',sans-serif;font-size:.63rem;font-weight:900;color:#fff;
  cursor:pointer;text-align:center;line-height:1.3;transition:transform .15s;
  box-shadow:0 2px 8px rgba(249,115,22,.28)}
.dobtn:active{transform:scale(.92)}
.doneico{font-size:1.6rem}
.sectitle{margin:6px 12px;font-size:.7rem;font-weight:800;color:var(--mu);text-align:center;letter-spacing:.04em}

/* EMPTY */
.empty{text-align:center;padding:44px 20px}
.emico{font-size:3.5rem;margin-bottom:12px}
.emtxt{font-size:.85rem;font-weight:800;color:var(--txt);margin-bottom:6px}
.emsub{font-size:.73rem;color:var(--mu);line-height:1.6}
.em-btn{display:inline-block;margin-top:14px;padding:11px 26px;background:var(--o);color:#fff;font-size:.82rem;font-weight:900;border-radius:12px;text-decoration:none;box-shadow:0 2px 10px rgba(249,115,22,.3)}

/* AD OVERLAY */
.adov{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .3s;
  max-width:430px;left:50%;transform:translateX(-50%)}
.adov.open{opacity:1;pointer-events:all}
.adbox{background:#111;border-radius:20px;width:calc(100% - 28px);max-width:402px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.7)}
.adimg-w{width:100%;height:185px;position:relative;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
.adimg-w img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;opacity:.65}
.adplay{position:relative;z-index:2;font-size:2.8rem}
.ad-catbar{position:absolute;top:10px;left:10px;z-index:3;font-size:.62rem;font-weight:800;padding:3px 10px;border-radius:8px;color:#fff}
.adbd{padding:13px 15px}
.adbr{font-size:.65rem;font-weight:700;color:#888;margin-bottom:2px}
.adti{font-size:.86rem;font-weight:900;color:#fff;margin-bottom:8px;line-height:1.3}
.adbw{background:#2a2a2a;border-radius:4px;height:6px;overflow:hidden;margin-bottom:8px}
.adbar{height:100%;background:linear-gradient(90deg,var(--o),var(--od));border-radius:4px;width:0%}
.adtm{font-size:.72rem;font-weight:800;color:#aaa;text-align:center;margin-bottom:10px}
.adbtn{width:100%;padding:12px;background:linear-gradient(135deg,var(--g),var(--gd));border:none;
  border-radius:12px;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:900;color:#fff;
  cursor:pointer;display:none;box-shadow:0 3px 14px rgba(22,163,74,.3)}
.adbtn.show{display:block}.adbtn:active{opacity:.85}

/* TOAST */
.tst{position:fixed;top:calc(var(--H) + var(--sat) + 8px);left:50%;
  transform:translateX(-50%) translateY(-80px);background:#111;color:#fff;
  padding:8px 20px;border-radius:22px;font-size:.76rem;font-weight:700;z-index:99999;
  white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.25)}
.tst.show{transform:translateX(-50%) translateY(0)}.tst.err{background:#DC2626}.tst.ok{background:var(--g)}
.ld{display:inline-block;width:10px;height:10px;border:2px solid #ccc;border-top-color:var(--g);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="topbar">
  <a class="tbk" href="dashboard.html">‚Äπ</a>
  <span class="tbt">‚úÖ Mes T√¢ches</span>
  <div class="tb-pill">üí∞ <span id="tb-solde">‚Äî</span></div>
</div>

<div class="tst" id="tst"></div>

<div class="scroll">
  <div class="tabs">
    <div class="tab on" id="tab-ec" onclick="switchTab('enc')">üîÑ En cours</div>
    <div class="tab" id="tab-fin" onclick="switchTab('fin')">‚úÖ Termin√©</div>
  </div>

  <div id="plan-banner" style="display:none"></div>
  <div id="locked-box" style="display:none" class="locked-box">
    <span class="lk-ico">üîí</span>
    <div class="lk-txt">Stage termin√©. Investissez dans un plan VIP pour d√©bloquer plus de t√¢ches et multiplier vos gains !
      <br><a href="recharge.html" class="lk-btn">üíé Choisir un plan VIP</a>
    </div>
  </div>

  <div class="summary">
    <div class="sum-row">
      <div class="sum-item"><div class="sum-lbl">Aujourd'hui</div><div class="sum-val" id="s-today">‚Äî</div></div>
      <div class="sum-sep"></div>
      <div class="sum-item"><div class="sum-lbl">Gains du jour</div><div class="sum-val" id="s-gains">‚Äî</div></div>
      <div class="sum-sep"></div>
      <div class="sum-item"><div class="sum-lbl">Statut</div><div class="sum-val" id="s-stage">‚Äî</div></div>
    </div>
  </div>

  <div class="dayp">
    <div class="dp-hd">
      <span class="dp-t">üìä Progression du jour</span>
      <span class="dp-c" id="dpc">0 / ‚Äî</span>
    </div>
    <div class="dp-b"><div class="dp-f" id="dpf" style="width:0%"></div></div>
    <div class="dp-m" id="dpm">Chargement...</div>
  </div>

  <div class="tlist" id="tlist">
    <div style="text-align:center;padding:30px"><span class="ld"></span></div>
  </div>
</div>

<nav class="botnav">
  <a class="bn" href="dashboard.html"><span class="bni">üè†</span><span class="bnl">Accueil</span></a>
  <a class="bn on" href="taches.html"><span class="bni">‚úÖ</span><span class="bnl">T√¢ches</span></a>
  <a class="bn" href="rapport.html"><span class="bni">üìä</span><span class="bnl">Rapports</span></a>
  <a class="bn" href="profil.html"><span class="bni">üë§</span><span class="bnl">Mon Compte</span></a>
</nav>

<!-- AD OVERLAY -->
<div class="adov" id="adov">
  <div class="adbox">
    <div class="adimg-w">
      <img id="adimg" src="" alt="">
      <div class="adplay">‚ñ∂Ô∏è</div>
      <div class="ad-catbar" id="ad-catbar"></div>
    </div>
    <div class="adbd">
      <div class="adbr">VGN Agriculture</div>
      <div class="adti" id="adti">T√¢che en cours</div>
      <div class="adbw"><div class="adbar" id="adbar"></div></div>
      <div class="adtm" id="adtm">Patientez <b>15</b> secondes...</div>
      <button class="adbtn" id="adbtn" onclick="finishAd()">‚úÖ R√©clamer mes gains</button>
    </div>
  </div>
</div>

<script>
const SB=supabase.createClient(
  'https://tgrfzybemuwvhkbpuzmz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmZ6eWJlbXV3dmhrYnB1em16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDMwOTgsImV4cCI6MjA4NzY3OTA5OH0.M20AwabfyHK_btwhgCmdUUbP2IAtY4TeYbc3Ovzj7CE',
  {auth:{persistSession:true,storageKey:'vgn-auth',storage:window.localStorage}}
);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG PLANS VIP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const VIP_CONF={
  'VIP 0':{max:3,  gain:70,    ico:'üå±', pb:'pb0', label:'Stage gratuit'},
  'VIP 1':{max:5,  gain:70,    ico:'üíº', pb:'pb1', label:'Job 1'},
  'VIP 2':{max:8,  gain:175,   ico:'üöÄ', pb:'pb2', label:'Job 2'},
  'VIP 3':{max:10, gain:560,   ico:'‚≠ê', pb:'pb3', label:'Job 3'},
  'VIP 4':{max:15, gain:1300,  ico:'üíé', pb:'pb4', label:'Job 4'},
  'VIP 5':{max:20, gain:2000,  ico:'üèÜ', pb:'pb5', label:'Job 5'},
  'VIP 6':{max:25, gain:3500,  ico:'üëë', pb:'pb6', label:'Job 6'},
  'VIP 7':{max:30, gain:6400,  ico:'üåü', pb:'pb7', label:'Job 7'},
  'VIP 8':{max:35, gain:11000, ico:'üí´', pb:'pb8', label:'Job 8'},
  'VIP 9':{max:40, gain:19000, ico:'üéØ', pb:'pb9', label:'Job 9'},
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CATALOGUE 36 T√ÇCHES
   10 cat√©gories color√©es
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CAT_META={
  'Agriculture':  {ico:'üåæ',bg:'bg-agri',cc:'cc-agri',sico:'bg-agri'},
  '√âlevage bovin':{ico:'üêÑ',bg:'bg-elev',cc:'cc-elev',sico:'bg-elev'},
  'Aquaculture':  {ico:'üêü',bg:'bg-aqua',cc:'cc-aqua',sico:'bg-aqua'},
  'Mara√Æchage':   {ico:'ü•¶',bg:'bg-mara',cc:'cc-mara',sico:'bg-mara'},
  'Apiculture':   {ico:'üçØ',bg:'bg-apic',cc:'cc-apic',sico:'bg-apic'},
  'Arboriculture':{ico:'üå≥',bg:'bg-arbo',cc:'cc-arbo',sico:'bg-arbo'},
  'Agroforesterie':{ico:'üåø',bg:'bg-agro',cc:'cc-agro',sico:'bg-agro'},
  'Aviculture':   {ico:'üêî',bg:'bg-poul',cc:'cc-poul',sico:'bg-poul'},
  'Laiterie':     {ico:'ü•õ',bg:'bg-lait',cc:'cc-lait',sico:'bg-lait'},
  'Hydroponique': {ico:'üíß',bg:'bg-serr',cc:'cc-serr',sico:'bg-serr'},
};

const CATALOG={
  /* üåæ AGRICULTURE */
  ag01:{nom:'Champs de Ma√Øs VGN',       cat:'Agriculture',    img:'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=300&q=80'},
  ag02:{nom:'R√©colte de Bl√© Dor√©',       cat:'Agriculture',    img:'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=300&q=80'},
  ag03:{nom:'Culture du Manioc Bio',     cat:'Agriculture',    img:'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=300&q=80'},
  ag04:{nom:'Plantation de Cacao',       cat:'Agriculture',    img:'https://images.unsplash.com/photo-1606914501449-5a96b6ce24ca?w=300&q=80'},
  ag05:{nom:'Rizi√®re Premium VGN',       cat:'Agriculture',    img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=300&q=80'},
  ag06:{nom:'Sorgho & Mil Fermier',      cat:'Agriculture',    img:'https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=300&q=80'},
  /* üêÑ √âLEVAGE BOVIN */
  el01:{nom:'√âlevage Bovin VGN',         cat:'√âlevage bovin',  img:'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=300&q=80'},
  el02:{nom:'Ranch Ovin & Caprin',        cat:'√âlevage bovin',  img:'https://images.unsplash.com/photo-1548550023-2bdb3c5beed7?w=300&q=80'},
  el03:{nom:'Ferme Bovine Laiti√®re',      cat:'√âlevage bovin',  img:'https://images.unsplash.com/photo-1570042225831-d98fa7577f1e?w=300&q=80'},
  el04:{nom:'Troupeau de Moutons Bio',    cat:'√âlevage bovin',  img:'https://images.unsplash.com/photo-1595433707802-6b2626ef1c91?w=300&q=80'},
  /* üêü AQUACULTURE */
  aq01:{nom:'√âlevage de Tilapia VGN',    cat:'Aquaculture',    img:'https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=300&q=80'},
  aq02:{nom:'Ferme Piscicole Moderne',    cat:'Aquaculture',    img:'https://images.unsplash.com/photo-1518877593221-1f28583780b4?w=300&q=80'},
  aq03:{nom:'Bassins Catfish Bio',        cat:'Aquaculture',    img:'https://images.unsplash.com/photo-1504973960431-1c467e159aa4?w=300&q=80'},
  aq04:{nom:'Crevetticulture Premium',    cat:'Aquaculture',    img:'https://images.unsplash.com/photo-1495615080073-6b89c9839ce0?w=300&q=80'},
  /* ü•¶ MARA√éCHAGE */
  ma01:{nom:'Serre de Tomates VGN',      cat:'Mara√Æchage',     img:'https://images.unsplash.com/photo-1592921870583-aeafb0639ffe?w=300&q=80'},
  ma02:{nom:'Culture de Poivrons Bio',    cat:'Mara√Æchage',     img:'https://images.unsplash.com/photo-1563565375-f3fdfdbefa83?w=300&q=80'},
  ma03:{nom:'Plantation de L√©gumes',      cat:'Mara√Æchage',     img:'https://images.unsplash.com/photo-1566385101042-1a0aa0c1268c?w=300&q=80'},
  ma04:{nom:'Oignons & Ail Fermiers',     cat:'Mara√Æchage',     img:'https://images.unsplash.com/photo-1618512496248-a07fe83aa8cb?w=300&q=80'},
  /* üçØ APICULTURE */
  ap01:{nom:'Ruches de Miel Naturel',    cat:'Apiculture',     img:'https://images.unsplash.com/photo-1587049352846-4a222e784d38?w=300&q=80'},
  ap02:{nom:'Apiculture VGN Premium',     cat:'Apiculture',     img:'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=300&q=80'},
  ap03:{nom:"Miel d'Acacia Sauvage",     cat:'Apiculture',     img:'https://images.unsplash.com/photo-1601063458289-77247ba485ec?w=300&q=80'},
  /* üå≥ ARBORICULTURE */
  ar01:{nom:'Verger de Manguiers',        cat:'Arboriculture',  img:'https://images.unsplash.com/photo-1504973960431-1c467e159aa4?w=300&q=80'},
  ar02:{nom:"Plantation d'Avocatiers",   cat:'Arboriculture',  img:'https://images.unsplash.com/photo-1601926638-c1f9bba4b9e8?w=300&q=80'},
  ar03:{nom:'Orangeraie Bio VGN',         cat:'Arboriculture',  img:'https://images.unsplash.com/photo-1547514701-42782101795e?w=300&q=80'},
  /* üåø AGROFORESTERIE */
  af01:{nom:'For√™t Productive VGN',      cat:'Agroforesterie', img:'https://images.unsplash.com/photo-1448375240586-882707db888b?w=300&q=80'},
  af02:{nom:'Bambouseraie Industrielle',  cat:'Agroforesterie', img:'https://images.unsplash.com/photo-1524490353-a5a09a9e60d0?w=300&q=80'},
  af03:{nom:'Moringa & Plantes M√©d.',    cat:'Agroforesterie', img:'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=300&q=80'},
  /* üêî AVICULTURE */
  po01:{nom:'Ferme Avicole VGN',         cat:'Aviculture',     img:'https://images.unsplash.com/photo-1608198093002-ad4e005484ec?w=300&q=80'},
  po02:{nom:'√âlevage de Poulets Bio',     cat:'Aviculture',     img:'https://images.unsplash.com/photo-1569288052389-dac9b01c9c05?w=300&q=80'},
  po03:{nom:"Production d'≈íufs VGN",    cat:'Aviculture',     img:'https://images.unsplash.com/photo-1582722872445-44dc5f7e3c8f?w=300&q=80'},
  po04:{nom:'Pintades & Dindons Farm.',  cat:'Aviculture',     img:'https://images.unsplash.com/photo-1548550023-2bdb3c5beed7?w=300&q=80'},
  /* ü•õ LAITERIE */
  la01:{nom:'Fromagerie Fermi√®re VGN',   cat:'Laiterie',       img:'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?w=300&q=80'},
  la02:{nom:'Production Laiti√®re Bio',    cat:'Laiterie',       img:'https://images.unsplash.com/photo-1563636619-e9143da7973b?w=300&q=80'},
  /* üíß HYDROPONIQUE */
  se01:{nom:'Serre Hydroponique VGN',    cat:'Hydroponique',   img:'https://images.unsplash.com/photo-1558618047-3c08d697a4ac?w=300&q=80'},
  se02:{nom:'Culture A√©roponique',        cat:'Hydroponique',   img:'https://images.unsplash.com/photo-1530836369250-ef72a3f5cda8?w=300&q=80'},
  se03:{nom:'Ferme Verticale Urbaine',    cat:'Hydroponique',   img:'https://images.unsplash.com/photo-1627920769842-053aebdaedbe?w=300&q=80'},
  se04:{nom:'Irrigation Connect√©e IoT',  cat:'Hydroponique',   img:'https://images.unsplash.com/photo-1464226184884-fa280b87c399?w=300&q=80'},
};

const ALL_IDS=Object.keys(CATALOG); // 36 t√¢ches
const SECS=15, DAYS_STAGE=4;

const fmt=n=>Number(n||0).toLocaleString('fr-FR');
const fmtF=n=>fmt(n)+' FCFA';
const td=()=>new Date().toISOString().slice(0,10);
const $=id=>document.getElementById(id);
const $s=(id,v)=>{const e=$(id);if(e)e.textContent=v};
function toast(m,t=''){const el=$('tst');el.textContent=m;el.className='tst show'+(t?' '+t:'');setTimeout(()=>el.className='tst',3500)}
function timeAgo(iso){const d=Math.floor((Date.now()-new Date(iso))/60000);if(d<1)return"√Ä l'instant";if(d<60)return d+'min';if(d<1440)return Math.floor(d/60)+'h';return new Date(iso).toLocaleDateString('fr-FR')}

let U=null,P=null,histList=[],doneToday=[],curTab='enc',curT=null,adInt=null,saving=false;
let vipNiv='VIP 0',MAX=3,GAIN=70,isVIP=false;

/* ‚îÄ‚îÄ Pool t√¢ches stable par jour & user ‚îÄ‚îÄ */
function getDayPool(){
  const seed=(U?.id||'x').slice(0,8)+td();
  let h=0;for(const c of seed)h=Math.imul(31,h)+c.charCodeAt(0)|0;
  const rng=()=>{h=Math.imul(h^(h>>>16),0x45d9f3b);h^=h>>>16;return(h>>>0)/0xFFFFFFFF};
  return [...ALL_IDS].sort(()=>rng()-.5).slice(0,Math.min(MAX*3,ALL_IDS.length));
}

/* ‚îÄ‚îÄ Banner VIP ‚îÄ‚îÄ */
function renderBanner(){
  const b=$('plan-banner');
  if(vipNiv==='VIP 0'){b.style.display='none';return}
  const c=VIP_CONF[vipNiv]||VIP_CONF['VIP 0'];
  b.style.display='block';
  b.innerHTML=`<div class="plan-banner ${c.pb}">
    <span class="pb-ico">${c.ico}</span>
    <div class="pb-info">
      <div class="pb-titre">${vipNiv} ‚Äî ${c.label} <span style="font-size:.6rem;background:rgba(255,255,255,.2);padding:1px 7px;border-radius:8px;">‚úÖ Actif</span></div>
      <div class="pb-sub">${MAX} t√¢ches/jour ¬∑ Gain ${fmtF(GAIN)}/t√¢che</div>
    </div>
    <div class="pb-right">
      <div class="pb-gain">+${fmtF(GAIN)}</div>
      <div class="pb-gainl">/ t√¢che</div>
    </div>
  </div>`;
}

/* ‚îÄ‚îÄ Summary ‚îÄ‚îÄ */
function updateSummary(){
  const n=doneToday.length;
  $s('s-today',n+' / '+MAX);
  $s('s-gains',fmtF(n*GAIN));
  $s('s-stage',isVIP?vipNiv:'Stage VIP 0');
  $('dpf').style.width=(n/Math.max(MAX,1)*100)+'%';
  $s('dpc',n+' / '+MAX);
  $s('dpm',n===0?"Aucune t√¢che compl√©t√©e aujourd'hui":n<MAX?`${MAX-n} t√¢che${MAX-n>1?'s':''} restante${MAX-n>1?'s':''} !`:"üéâ Objectif atteint ! Revenez demain.");
}

/* ‚îÄ‚îÄ Switch tab ‚îÄ‚îÄ */
function switchTab(t){
  curTab=t;
  $('tab-ec').className='tab'+(t==='enc'?' on':'');
  $('tab-fin').className='tab'+(t==='fin'?' on':'');
  render();
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function render(){
  const list=$('tlist');list.innerHTML='';
  $('locked-box').style.display='none';

  if(curTab==='enc'){
    // Stage termin√© sans VIP ?
    if(!isVIP){
      const ms=Date.now()-new Date(P?.created_at||U?.created_at||Date.now()).getTime();
      const jourStage=Math.floor(ms/86400000)+1;
      if(jourStage>DAYS_STAGE&&doneToday.length>=MAX){
        $('locked-box').style.display='flex';
        list.innerHTML=`<div class="empty"><div class="emico">üîí</div>
          <div class="emtxt">Stage termin√© !</div>
          <div class="emsub">Activez un plan VIP pour acc√©der<br>√† plus de t√¢ches et augmenter vos gains.</div>
          <a href="recharge.html" class="em-btn">üíé Investir maintenant</a></div>`;
        return;
      }
    }

    if(doneToday.length>=MAX){
      list.innerHTML=`<div class="empty"><div class="emico">üåô</div>
        <div class="emtxt">Limite du jour atteinte !</div>
        <div class="emsub">Vous avez r√©alis√© vos ${MAX} t√¢ches du jour.<br>Revenez demain pour continuer.</div></div>`;
      return;
    }

    const pool=getDayPool();
    const restantes=pool.filter(id=>!doneToday.includes(id));
    if(!restantes.length){
      list.innerHTML=`<div class="empty"><div class="emico">‚úÖ</div><div class="emtxt">Toutes faites !</div><div class="emsub">Revenez demain.</div></div>`;
      return;
    }

    // Grouper par cat√©gorie
    const parCat={};
    restantes.forEach(id=>{
      const c=CATALOG[id].cat;
      if(!parCat[c])parCat[c]=[];
      parCat[c].push(id);
    });

    let rendered=0;
    for(const [cat,ids] of Object.entries(parCat)){
      if(rendered>=MAX*2)break; // limiter l'affichage √† 2√ó le max
      const cm=CAT_META[cat]||CAT_META['Agriculture'];

      // Titre section cat√©gorie
      const sh=document.createElement('div');sh.className='sec-hd';
      sh.innerHTML=`<div class="sec-hd-ico ${cm.bg}">${cm.ico}</div>
        <span class="sec-hd-lbl">${cat}</span>
        <span class="sec-hd-ct ${cm.bg}">${ids.length}</span>`;
      list.appendChild(sh);

      ids.forEach(id=>{
        if(rendered>=MAX*2)return;
        const t=CATALOG[id];
        const div=document.createElement('div');
        div.className=`titem ${cm.cc}`;
        div.innerHTML=`
          <img class="tiimg" src="${t.img}" alt="${t.nom}" loading="lazy"
            onerror="this.src='https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=300&q=80'">
          <div class="tibody">
            <div class="tiname">${t.nom}</div>
            <div class="timeta">
              <span class="badge ${cm.bg}">${cm.ico} ${cat}</span>
              <span class="badge bg-mu">Gratuit</span>
            </div>
            <div class="tirew">+${fmtF(GAIN)}</div>
            <div class="titime">‚è± Publicit√© de ${SECS} secondes</div>
          </div>
          <div class="tiright">
            <button class="dobtn" onclick="startAd('${id}')">‚ñ∂Ô∏è Faire<br>la t√¢che</button>
          </div>`;
        list.appendChild(div);
        rendered++;
      });
    }

  } else {
    // TERMIN√â
    const todayR=histList.filter(r=>r.date_jour===td());
    const oldR=histList.filter(r=>r.date_jour!==td());

    if(!histList.length){
      list.innerHTML=`<div class="empty"><div class="emico">üìã</div><div class="emtxt">Aucune t√¢che termin√©e</div><div class="emsub">Les t√¢ches compl√©t√©es appara√Ætront ici.</div></div>`;
      return;
    }

    const mkItem=(r,faded)=>{
      const t=CATALOG[r.tache_ref]||{nom:'T√¢che VGN',cat:'Agriculture',img:'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=300&q=80'};
      const cm=CAT_META[t.cat]||CAT_META['Agriculture'];
      const div=document.createElement('div');div.className='titem fin';if(faded)div.style.opacity='.7';
      div.innerHTML=`
        <img class="tiimg" src="${t.img}" alt="${t.nom}" loading="lazy">
        <div class="tibody">
          <div class="tiname">${t.nom}</div>
          <div class="timeta"><span class="badge bg-ok">‚úÖ Termin√©</span><span class="badge ${cm.bg}">${cm.ico} ${t.cat}</span></div>
          <div class="tirew">+${fmtF(r.reward||GAIN)} cr√©dit√©s</div>
          <div class="titime">${faded?'üìÖ '+new Date(r.completee_le).toLocaleDateString('fr-FR'):'üïê '+timeAgo(r.completee_le)}</div>
        </div>
        <div class="tiright"><div class="doneico">‚úÖ</div></div>`;
      return div;
    };

    if(todayR.length){
      const s=document.createElement('div');s.className='sectitle';s.textContent="‚îÄ‚îÄ Aujourd'hui ‚îÄ‚îÄ";list.appendChild(s);
      todayR.forEach(r=>list.appendChild(mkItem(r,false)));
    }
    if(oldR.length){
      const s=document.createElement('div');s.className='sectitle';s.textContent='‚îÄ‚îÄ Jours pr√©c√©dents ‚îÄ‚îÄ';list.appendChild(s);
      oldR.forEach(r=>list.appendChild(mkItem(r,true)));
    }
  }
}

/* ‚îÄ‚îÄ START AD ‚îÄ‚îÄ */
function startAd(id){
  if(saving)return;
  const t=CATALOG[id];if(!t)return;
  const cm=CAT_META[t.cat]||CAT_META['Agriculture'];
  curT={id,...t};
  $('adimg').src=t.img;
  $('adti').textContent=t.nom;
  $('ad-catbar').textContent=cm.ico+' '+t.cat;
  $('ad-catbar').className='ad-catbar '+cm.bg;
  const bar=$('adbar');bar.style.transition='none';bar.style.width='0%';
  $('adtm').innerHTML=`Patientez <b>${SECS}</b> secondes...`;
  $('adbtn').textContent='‚úÖ R√©clamer +'+fmt(GAIN)+' FCFA';
  $('adbtn').classList.remove('show');
  $('adov').classList.add('open');
  let el=0;clearInterval(adInt);
  adInt=setInterval(()=>{
    el++;bar.style.transition='width 1s linear';bar.style.width=(el/SECS*100)+'%';
    const r=SECS-el;
    $('adtm').innerHTML=r>0?`Patientez <b>${r}</b> sec...`:'üéâ Cliquez pour r√©clamer !';
    if(el>=SECS){clearInterval(adInt);$('adbtn').classList.add('show')}
  },1000);
}

/* ‚îÄ‚îÄ FINISH AD ‚îÄ‚îÄ */
async function finishAd(){
  if(!curT||!U||saving)return;
  if(doneToday.includes(curT.id)){toast('‚ö†Ô∏è D√©j√† compl√©t√©e');return}
  if(doneToday.length>=MAX){toast('‚ö†Ô∏è Limite du jour atteinte');return}
  clearInterval(adInt);saving=true;
  const btn=$('adbtn');btn.textContent='‚è≥...';btn.disabled=true;
  const t=curT;curT=null;
  try{
    const now=new Date().toISOString(),dj=td();
    const{error:e1}=await SB.from('taches_completees').insert({
      user_id:U.id,tache_ref:t.id,
      type_tache:isVIP?'vip':'stage',
      reward:GAIN,date_jour:dj,completee_le:now
    });
    if(e1)throw e1;
    const ns=(P.solde||0)+GAIN,ng=(P.gains_totaux||0)+GAIN,
          ngj=(P.gains_jour||0)+GAIN,ngs=(P.gains_semaine||0)+GAIN,
          ngm=(P.gains_mois||0)+GAIN,nt=(P.taches_jour||0)+1;
    const{error:e2}=await SB.from('profiles').update({
      solde:ns,gains_totaux:ng,gains_jour:ngj,gains_semaine:ngs,gains_mois:ngm,taches_jour:nt
    }).eq('id',U.id);
    if(e2)throw e2;
    P={...P,solde:ns,gains_totaux:ng,gains_jour:ngj,taches_jour:nt};
    doneToday.push(t.id);
    histList.unshift({tache_ref:t.id,reward:GAIN,date_jour:dj,completee_le:now});
    $('adov').classList.remove('open');
    toast('üéâ +'+fmtF(GAIN)+' cr√©dit√©s !','ok');
    $s('tb-solde',fmtF(P.solde));
    updateSummary();render();
  }catch(err){
    $('adov').classList.remove('open');
    toast('‚ùå '+(err.message||JSON.stringify(err)),'err');
  }finally{
    saving=false;btn.textContent='‚úÖ R√©clamer +'+fmt(GAIN)+' FCFA';btn.disabled=false;
  }
}

/* ‚îÄ‚îÄ APPLIQUER UN NOUVEAU PROFIL VIP ‚îÄ‚îÄ */
function applyProfil(newP,showToast=false){
  const oldVip=vipNiv;
  vipNiv=newP.vip_niveau||'VIP 0';
  const conf=VIP_CONF[vipNiv]||VIP_CONF['VIP 0'];
  MAX=newP.taches_total||conf.max;
  GAIN=conf.gain;
  isVIP=vipNiv!=='VIP 0';
  P={...P,...newP};
  $s('tb-solde',fmtF(P.solde));
  renderBanner();
  updateSummary();
  if(showToast&&vipNiv!==oldVip){
    toast('üéâ '+vipNiv+' activ√© ! Nouvelles t√¢ches disponibles !','ok');
  }
  render();
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
async function init(){
  const{data:{session}}=await SB.auth.getSession();
  if(!session?.user){window.location.href='index.html';return}
  U=session.user;

  const{data:p}=await SB.from('profiles').select('*').eq('id',U.id).single();
  const profil=p||{solde:0,gains_totaux:0,gains_jour:0,investissement:0,taches_jour:0,taches_total:3,vip_niveau:'VIP 0',created_at:U.created_at};

  // Charger historique complet (les 2 types)
  const{data:tc}=await SB.from('taches_completees')
    .select('*').eq('user_id',U.id)
    .order('completee_le',{ascending:false}).limit(300);
  histList=tc||[];
  doneToday=histList.filter(r=>r.date_jour===td()).map(r=>r.tache_ref).filter(Boolean);

  applyProfil(profil,false);

  /* ‚îÄ‚îÄ Temps r√©el : mise √† jour d√®s validation recharge par admin ‚îÄ‚îÄ */
  SB.channel('vgn-profile-'+U.id)
    .on('postgres_changes',{
      event:'UPDATE',schema:'public',table:'profiles',filter:`id=eq.${U.id}`
    }, payload=>{
      applyProfil(payload.new,true);
    })
    .subscribe();
}

init();
</script>
</body>
</html>
